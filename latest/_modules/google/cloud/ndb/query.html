
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>google.cloud.ndb.query &#8212; ndb 0.0.1.dev1 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for google.cloud.ndb.query</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2018 Google LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;High-level wrapper for datastore queries.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">context</span> <span class="k">as</span> <span class="n">context_module</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">_datastore_query</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">_gql</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">model</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">_options</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;QueryOptions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PropertyOrder&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RepeatedStructuredPropertyPredicate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ParameterizedThing&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Parameter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ParameterizedFunction&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Node&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FalseNode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ParameterNode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FilterNode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PostFilterNode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ConjunctionNode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DisjunctionNode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AND&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Query&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gql&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="n">_EQ_OP</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span>
<span class="n">_NE_OP</span> <span class="o">=</span> <span class="s2">&quot;!=&quot;</span>
<span class="n">_IN_OP</span> <span class="o">=</span> <span class="s2">&quot;in&quot;</span>
<span class="n">_LT_OP</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span>
<span class="n">_GT_OP</span> <span class="o">=</span> <span class="s2">&quot;&gt;&quot;</span>
<span class="n">_OPS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">_EQ_OP</span><span class="p">,</span> <span class="n">_NE_OP</span><span class="p">,</span> <span class="n">_LT_OP</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="n">_GT_OP</span><span class="p">,</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span> <span class="n">_IN_OP</span><span class="p">])</span>

<span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="PropertyOrder"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.PropertyOrder">[docs]</a><span class="k">class</span> <span class="nc">PropertyOrder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The sort order for a property name, to be used when ordering the</span>
<span class="sd">       results of a query.</span>

<span class="sd">       Args:</span>
<span class="sd">           name (str): The name of the model property to use for ordering.</span>
<span class="sd">           reverse (bool): Whether to reverse the sort order (descending)</span>
<span class="sd">               or not (ascending). Default is False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;reverse&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span> <span class="o">=</span> <span class="n">reverse</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;PropertyOrder(name=&#39;</span><span class="si">{}</span><span class="s2">&#39;, reverse=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span></div>


<div class="viewcode-block" id="RepeatedStructuredPropertyPredicate"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.RepeatedStructuredPropertyPredicate">[docs]</a><span class="k">class</span> <span class="nc">RepeatedStructuredPropertyPredicate</span><span class="p">:</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="ParameterizedThing"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.ParameterizedThing">[docs]</a><span class="k">class</span> <span class="nc">ParameterizedThing</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for :class:`Parameter` and :class:`ParameterizedFunction`.</span>

<span class="sd">    This exists purely for :func:`isinstance` checks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">eq</span>
        <span class="k">return</span> <span class="n">eq</span></div>


<div class="viewcode-block" id="Parameter"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Parameter">[docs]</a><span class="k">class</span> <span class="nc">Parameter</span><span class="p">(</span><span class="n">ParameterizedThing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a bound variable in a GQL query.</span>

<span class="sd">    ``Parameter(1)`` corresponds to a slot labeled ``:1`` in a GQL query.</span>
<span class="sd">    ``Parameter(&#39;xyz&#39;)`` corresponds to a slot labeled ``:xyz``.</span>

<span class="sd">    The value must be set (bound) separately.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (Union[str, int]): The parameter key.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the ``key`` is not a string or integer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_key&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Parameter key must be an integer or string, not </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">key</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">key</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_key</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the key.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span>

<div class="viewcode-block" id="Parameter.resolve"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Parameter.resolve">[docs]</a>    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bindings</span><span class="p">,</span> <span class="n">used</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resolve the current parameter from the parameter bindings.</span>

<span class="sd">        Args:</span>
<span class="sd">            bindings (dict): A mapping of parameter bindings.</span>
<span class="sd">            used (Dict[Union[str, int], bool]): A mapping of already used</span>
<span class="sd">                parameters. This will be modified if the current parameter</span>
<span class="sd">                is in ``bindings``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The bound value for the current parameter.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadArgumentError: If the current parameter is not in ``bindings``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bindings</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
                <span class="s2">&quot;Parameter :</span><span class="si">{}</span><span class="s2"> is not bound.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">bindings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">used</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="ParameterizedFunction"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.ParameterizedFunction">[docs]</a><span class="k">class</span> <span class="nc">ParameterizedFunction</span><span class="p">(</span><span class="n">ParameterizedThing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a GQL function with parameterized arguments.</span>

<span class="sd">    For example, ParameterizedFunction(&#39;key&#39;, [Parameter(1)]) stands for</span>
<span class="sd">    the GQL syntax KEY(:1).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__values</span> <span class="o">=</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;ParameterizedFunction(</span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ParameterizedFunction</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__func</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">__func</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__values</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">__values</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__func</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__values</span></div>


<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for filter expression tree nodes.</span>

<span class="sd">    Tree nodes are considered immutable, even though they can contain</span>
<span class="sd">    Parameter instances, which are not. In particular, two identical</span>
<span class="sd">    trees may be represented by the same Node object in different</span>
<span class="sd">    contexts.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: Always, only subclasses are allowed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_multiquery</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Node</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot instantiate Node, only a subclass.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Nodes cannot be ordered&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Nodes cannot be ordered&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Nodes cannot be ordered&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Nodes cannot be ordered&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_to_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper to convert to low-level filter.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. This method is virtual.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_post_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper to extract post-filter nodes, if any.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Always. Because this is the base implementation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Node.resolve"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Node.resolve">[docs]</a>    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bindings</span><span class="p">,</span> <span class="n">used</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a node with parameters replaced by the selected values.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Both ``bindings`` and ``used`` are unused by this base class</span>
<span class="sd">            implementation.</span>

<span class="sd">        Args:</span>
<span class="sd">            bindings (dict): A mapping of parameter bindings.</span>
<span class="sd">            used (Dict[Union[str, int], bool]): A mapping of already used</span>
<span class="sd">                parameters. This will be modified if the current parameter</span>
<span class="sd">                is in ``bindings``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Node: The current node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span></div></div>


<div class="viewcode-block" id="FalseNode"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.FalseNode">[docs]</a><span class="k">class</span> <span class="nc">FalseNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tree node for an always-failing filter.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="FalseNode.__eq__"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.FalseNode.__eq__">[docs]</a>    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Equality check.</span>

<span class="sd">        An instance will always equal another :class:`FalseNode` instance. This</span>
<span class="sd">        is because they hold no state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">FalseNode</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_to_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(Attempt to) convert to a low-level filter instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            post (bool): Indicates if this is a post-filter node.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadQueryError: If ``post`` is :data:`False`, because there&#39;s no</span>
<span class="sd">                point submitting a query that will never return anything.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">post</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadQueryError</span><span class="p">(</span><span class="s2">&quot;Cannot convert FalseNode to predicate&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ParameterNode"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.ParameterNode">[docs]</a><span class="k">class</span> <span class="nc">ParameterNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tree node for a parameterized filter.</span>

<span class="sd">    Args:</span>
<span class="sd">        prop (~google.cloud.ndb.model.Property): A property describing a value</span>
<span class="sd">            type.</span>
<span class="sd">        op (str): The comparison operator. One of ``=``, ``!=``, ``&lt;``, ``&lt;=``,</span>
<span class="sd">            ``&gt;``, ``&gt;=`` or ``in``.</span>
<span class="sd">        param (ParameterizedThing): The parameter corresponding to the node.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If ``prop`` is not a</span>
<span class="sd">            :class:`~google.cloud.ndb.model.Property`.</span>
<span class="sd">        TypeError: If ``op`` is not one of the accepted operators.</span>
<span class="sd">        TypeError: If ``param`` is not a :class:`.Parameter` or</span>
<span class="sd">            :class:`.ParameterizedFunction`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_prop&quot;</span><span class="p">,</span> <span class="s2">&quot;_op&quot;</span><span class="p">,</span> <span class="s2">&quot;_param&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Property</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected a Property, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prop</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_OPS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected a valid operator, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">ParameterizedThing</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Expected a ParameterizedThing, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ParameterNode</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_prop</span> <span class="o">=</span> <span class="n">prop</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">op</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_param</span> <span class="o">=</span> <span class="n">param</span>
        <span class="k">return</span> <span class="n">obj</span>

<div class="viewcode-block" id="ParameterNode.__getnewargs__"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.ParameterNode.__getnewargs__">[docs]</a>    <span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private API used to specify ``__new__`` arguments when unpickling.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This method only applies if the ``pickle`` protocol is 2 or</span>
<span class="sd">            greater.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[~google.cloud.ndb.model.Property, str, ParameterizedThing]:</span>
<span class="sd">            A tuple containing the internal state: the property, operation and</span>
<span class="sd">            parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;ParameterNode(</span><span class="si">{!r}</span><span class="s2">, </span><span class="si">{!r}</span><span class="s2">, </span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ParameterNode</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_prop</span><span class="o">.</span><span class="n">_name</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_op</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_param</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_to_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper to convert to low-level filter.</span>

<span class="sd">        Args:</span>
<span class="sd">            post (bool): Indicates if this is a post-filter node.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadArgumentError: Always. This is because this node represents</span>
<span class="sd">            a parameter, i.e. no value exists to be filtered on.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
            <span class="s2">&quot;Parameter :</span><span class="si">{}</span><span class="s2"> is not bound.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ParameterNode.resolve"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.ParameterNode.resolve">[docs]</a>    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bindings</span><span class="p">,</span> <span class="n">used</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a node with parameters replaced by the selected values.</span>

<span class="sd">        Args:</span>
<span class="sd">            bindings (dict): A mapping of parameter bindings.</span>
<span class="sd">            used (Dict[Union[str, int], bool]): A mapping of already used</span>
<span class="sd">                parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[~google.cloud.ndb.query.DisjunctionNode, \</span>
<span class="sd">                ~google.cloud.ndb.query.FilterNode, \</span>
<span class="sd">                ~google.cloud.ndb.query.FalseNode]: A node corresponding to</span>
<span class="sd">            the value substituted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">bindings</span><span class="p">,</span> <span class="n">used</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">==</span> <span class="n">_IN_OP</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="o">.</span><span class="n">_IN</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FilterNode"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.FilterNode">[docs]</a><span class="k">class</span> <span class="nc">FilterNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tree node for a single filter expression.</span>

<span class="sd">    For example ``FilterNode(&quot;a&quot;, &quot;&gt;&quot;, 3)`` filters for entities where the</span>
<span class="sd">    value ``a`` is greater than ``3``.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        The constructor for this type may not always return a</span>
<span class="sd">        :class:`FilterNode`. For example:</span>

<span class="sd">        * The filter ``name != value`` is converted into</span>
<span class="sd">          ``(name &gt; value) OR (name &lt; value)`` (a :class:`DisjunctionNode`)</span>
<span class="sd">        * The filter ``name in (value1, ..., valueN)`` is converted into</span>
<span class="sd">          ``(name = value1) OR ... OR (name = valueN)`` (also a</span>
<span class="sd">          :class:`DisjunctionNode`)</span>
<span class="sd">        * The filter ``name in ()`` (i.e. a property is among an empty list</span>
<span class="sd">          of values) is converted into a :class:`FalseNode`</span>
<span class="sd">        * The filter ``name in (value1,)`` (i.e. a list with one element) is</span>
<span class="sd">          converted into ``name = value1``, a related :class:`FilterNode`</span>
<span class="sd">          with a different ``opsymbol`` and ``value`` than what was passed</span>
<span class="sd">          to the constructor</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): The name of the property being filtered.</span>
<span class="sd">        opsymbol (str): The comparison operator. One of ``=``, ``!=``, ``&lt;``,</span>
<span class="sd">            ``&lt;=``, ``&gt;``, ``&gt;=`` or ``in``.</span>
<span class="sd">        value (Any): The value to filter on / relative to.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If ``opsymbol`` is ``&quot;in&quot;`` but ``value`` is not a</span>
<span class="sd">            basic container (:class:`list`, :class:`tuple`, :class:`set` or</span>
<span class="sd">            :class:`frozenset`)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_name&quot;</span><span class="p">,</span> <span class="s2">&quot;_opsymbol&quot;</span><span class="p">,</span> <span class="s2">&quot;_value&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">opsymbol</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Key</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_key</span>

        <span class="k">if</span> <span class="n">opsymbol</span> <span class="o">==</span> <span class="n">_NE_OP</span><span class="p">:</span>
            <span class="n">node1</span> <span class="o">=</span> <span class="n">FilterNode</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_LT_OP</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">node2</span> <span class="o">=</span> <span class="n">FilterNode</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_GT_OP</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">DisjunctionNode</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">opsymbol</span> <span class="o">==</span> <span class="n">_IN_OP</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;in expected a list, tuple or set of values; &quot;</span>
                    <span class="s2">&quot;received </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">FilterNode</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_EQ_OP</span><span class="p">,</span> <span class="n">sub_value</span><span class="p">)</span> <span class="k">for</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">value</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">FalseNode</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">DisjunctionNode</span><span class="p">(</span><span class="o">*</span><span class="n">nodes</span><span class="p">)</span>

        <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">FilterNode</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_opsymbol</span> <span class="o">=</span> <span class="n">opsymbol</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">instance</span>

<div class="viewcode-block" id="FilterNode.__getnewargs__"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.FilterNode.__getnewargs__">[docs]</a>    <span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private API used to specify ``__new__`` arguments when unpickling.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This method only applies if the ``pickle`` protocol is 2 or</span>
<span class="sd">            greater.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[str, str, Any]: A tuple containing the</span>
<span class="sd">            internal state: the name, ``opsymbol`` and value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opsymbol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{!r}</span><span class="s2">, </span><span class="si">{!r}</span><span class="s2">, </span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opsymbol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">FilterNode</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opsymbol</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_opsymbol</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_value</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_to_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper to convert to low-level filter.</span>

<span class="sd">        Args:</span>
<span class="sd">            post (bool): Indicates if this is a post-filter node.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[query_pb2.PropertyFilter]: Returns :data:`None`, if</span>
<span class="sd">                this is a post-filter, otherwise returns the protocol buffer</span>
<span class="sd">                representation of the filter.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If the ``opsymbol`` is ``!=`` or ``in``, since</span>
<span class="sd">                they should correspond to a composite filter. This should</span>
<span class="sd">                never occur since the constructor will create ``OR`` nodes for</span>
<span class="sd">                ``!=`` and ``in``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">post</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opsymbol</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_NE_OP</span><span class="p">,</span> <span class="n">_IN_OP</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Inequality filters are not single filter &quot;</span>
                <span class="s2">&quot;expressions and therefore cannot be converted &quot;</span>
                <span class="s2">&quot;to a single filter (</span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_opsymbol</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">_datastore_query</span><span class="o">.</span><span class="n">make_filter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opsymbol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PostFilterNode"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.PostFilterNode">[docs]</a><span class="k">class</span> <span class="nc">PostFilterNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tree node representing an in-memory filtering operation.</span>

<span class="sd">    This is used to represent filters that cannot be executed by the</span>
<span class="sd">    datastore, for example a query for a structured value.</span>

<span class="sd">    Args:</span>
<span class="sd">        predicate (Callable[[Any], bool]): A filter predicate that</span>
<span class="sd">            takes a datastore entity (typically as a protobuf) and</span>
<span class="sd">            returns :data:`True` or :data:`False` if the entity matches</span>
<span class="sd">            the given filter.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;predicate&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">predicate</span><span class="p">):</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">PostFilterNode</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">predicate</span> <span class="o">=</span> <span class="n">predicate</span>
        <span class="k">return</span> <span class="n">instance</span>

<div class="viewcode-block" id="PostFilterNode.__getnewargs__"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.PostFilterNode.__getnewargs__">[docs]</a>    <span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private API used to specify ``__new__`` arguments when unpickling.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This method only applies if the ``pickle`` protocol is 2 or</span>
<span class="sd">            greater.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Callable[[Any], bool],]: A tuple containing a single value,</span>
<span class="sd">            the ``predicate`` attached to this node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="p">,)</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">PostFilterNode</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">predicate</span>

    <span class="k">def</span> <span class="nf">_to_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper to convert to low-level filter.</span>

<span class="sd">        Args:</span>
<span class="sd">            post (bool): Indicates if this is a post-filter node.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Callable[[Any], bool], None]: If this is a post-filter, this</span>
<span class="sd">            returns the stored ``predicate``, otherwise it returns</span>
<span class="sd">            :data:`None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">post</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<span class="k">class</span> <span class="nc">_BooleanClauses</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This type will be used for symbolically performing boolean operations.</span>

<span class="sd">    Internally, the state will track a symbolic expression like::</span>

<span class="sd">        A or (B and C) or (A and D)</span>

<span class="sd">    as a list of the ``OR`` components::</span>

<span class="sd">        [A, B and C, A and D]</span>

<span class="sd">    When ``combine_or=False``, it will track ``AND`` statements as a list,</span>
<span class="sd">    making the final simplified form of our example::</span>

<span class="sd">        [[A], [B, C], [A, D]]</span>

<span class="sd">    Via :meth:`add_node`, we will ensure that new nodes will be correctly</span>
<span class="sd">    combined (via ``AND`` or ``OR``) with the current expression.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): The name of the class that is tracking a</span>
<span class="sd">            boolean expression.</span>
<span class="sd">        combine_or (bool): Indicates if new nodes will be combined</span>
<span class="sd">            with the current boolean expression via ``AND`` or ``OR``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;combine_or&quot;</span><span class="p">,</span> <span class="s2">&quot;or_parts&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">combine_or</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combine_or</span> <span class="o">=</span> <span class="n">combine_or</span>
        <span class="k">if</span> <span class="n">combine_or</span><span class="p">:</span>
            <span class="c1"># For ``OR()`` the parts are just nodes.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">or_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For ``AND()`` the parts are &quot;segments&quot;, i.e. node lists.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">or_parts</span> <span class="o">=</span> <span class="p">[[]]</span>

    <span class="k">def</span> <span class="nf">add_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the current boolean expression.</span>

<span class="sd">        This uses the distributive law for sets to combine as follows:</span>

<span class="sd">        - ``(A or B or C or ...) or  D`` -&gt; ``A or B or C or ... or D``</span>
<span class="sd">        - ``(A or B or C or ...) and D`` -&gt;</span>
<span class="sd">          ``(A and D) or (B and D) or (C and D) or ...``</span>

<span class="sd">        Args:</span>
<span class="sd">            node (Node): A node to add to the list of clauses.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If ``node`` is not a :class:`.Node`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">() expects Node instances as arguments; &quot;</span>
                <span class="s2">&quot;received a non-Node instance </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_or</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">DisjunctionNode</span><span class="p">):</span>
                <span class="c1">#    [S1 or ... or Sn] or [A1 or ... or Am]</span>
                <span class="c1"># -&gt; S1 or ... Sn or A1 or ... or Am</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">or_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#    [S1 or ... or Sn] or [A1]</span>
                <span class="c1"># -&gt; S1 or ... or Sn or A1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">or_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">DisjunctionNode</span><span class="p">):</span>
                <span class="c1">#    [S1 or ... or Sn] and [A1 or ... or Am]</span>
                <span class="c1"># -&gt; [S1 and A1] or ... or [Sn and A1] or</span>
                <span class="c1">#        ... or [Sn and Am] or ... or [Sn and Am]</span>
                <span class="n">new_segments</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">or_parts</span><span class="p">:</span>
                    <span class="c1"># ``segment`` represents ``Si``</span>
                    <span class="k">for</span> <span class="n">sub_node</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                        <span class="c1"># ``sub_node`` represents ``Aj``</span>
                        <span class="n">new_segment</span> <span class="o">=</span> <span class="n">segment</span> <span class="o">+</span> <span class="p">[</span><span class="n">sub_node</span><span class="p">]</span>
                        <span class="n">new_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_segment</span><span class="p">)</span>
                <span class="c1"># Replace wholesale.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">or_parts</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new_segments</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ConjunctionNode</span><span class="p">):</span>
                <span class="c1">#    [S1 or ... or Sn] and [A1 and ... and Am]</span>
                <span class="c1"># -&gt; [S1 and A1 and ... and Am] or ... or</span>
                <span class="c1">#        [Sn and A1 and ... and Am]</span>
                <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">or_parts</span><span class="p">:</span>
                    <span class="c1"># ``segment`` represents ``Si``</span>
                    <span class="n">segment</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#    [S1 or ... or Sn] and [A1]</span>
                <span class="c1"># -&gt; [S1 and A1] or ... or [Sn and A1]</span>
                <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">or_parts</span><span class="p">:</span>
                    <span class="n">segment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>


<div class="viewcode-block" id="ConjunctionNode"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.ConjunctionNode">[docs]</a><span class="k">class</span> <span class="nc">ConjunctionNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tree node representing a boolean ``AND`` operator on multiple nodes.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        The constructor for this type may not always return a</span>
<span class="sd">        :class:`ConjunctionNode`. For example:</span>

<span class="sd">        * If the passed in ``nodes`` has only one entry, that single node</span>
<span class="sd">          will be returned by the constructor</span>
<span class="sd">        * If the resulting boolean expression has an ``OR`` in it, then a</span>
<span class="sd">          :class:`DisjunctionNode` will be returned; e.g.</span>
<span class="sd">          ``AND(OR(A, B), C)`` becomes ``OR(AND(A, C), AND(B, C))``</span>

<span class="sd">    Args:</span>
<span class="sd">        nodes (Tuple[Node, ...]): A list of nodes to be joined.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If ``nodes`` is empty.</span>
<span class="sd">        RuntimeError: If the ``nodes`` combine to an &quot;empty&quot; boolean</span>
<span class="sd">            expression.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_nodes&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">nodes</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ConjunctionNode() requires at least one node.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">clauses</span> <span class="o">=</span> <span class="n">_BooleanClauses</span><span class="p">(</span><span class="s2">&quot;ConjunctionNode&quot;</span><span class="p">,</span> <span class="n">combine_or</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">clauses</span><span class="o">.</span><span class="n">or_parts</span><span class="p">:</span>
            <span class="c1"># NOTE: The original implementation returned a ``FalseNode``</span>
            <span class="c1">#       here but as far as I can tell this code is unreachable.</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Invalid boolean expression&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clauses</span><span class="o">.</span><span class="n">or_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DisjunctionNode</span><span class="p">(</span>
                <span class="o">*</span><span class="p">[</span><span class="n">ConjunctionNode</span><span class="p">(</span><span class="o">*</span><span class="n">segment</span><span class="p">)</span> <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">clauses</span><span class="o">.</span><span class="n">or_parts</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ConjunctionNode</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">=</span> <span class="n">clauses</span><span class="o">.</span><span class="n">or_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">instance</span>

<div class="viewcode-block" id="ConjunctionNode.__getnewargs__"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.ConjunctionNode.__getnewargs__">[docs]</a>    <span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private API used to specify ``__new__`` arguments when unpickling.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This method only applies if the ``pickle`` protocol is 2 or</span>
<span class="sd">            greater.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Node, ...]: The list of stored nodes, converted to a</span>
<span class="sd">            :class:`tuple`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_nodes</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;AND(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">all_nodes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ConjunctionNode</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_nodes</span>

    <span class="k">def</span> <span class="nf">_to_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper to convert to low-level filter.</span>

<span class="sd">        Args:</span>
<span class="sd">            post (bool): Indicates if this is a post-filter node.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Node]: The single or composite filter corresponding to</span>
<span class="sd">                the pre- or post-filter nodes stored. May return :data:`None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">PostFilterNode</span><span class="p">)</span> <span class="o">==</span> <span class="n">post</span><span class="p">:</span>
                <span class="n">as_filter</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">_to_filter</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">as_filter</span><span class="p">:</span>
                    <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">as_filter</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">filters</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">_datastore_query</span><span class="o">.</span><span class="n">make_composite_and_filter</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_post_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper to extract post-filter nodes, if any.</span>

<span class="sd">        Filters all of the stored nodes that are :class:`PostFilterNode`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Node]: One of the following:</span>

<span class="sd">            * :data:`None` if there are no post-filter nodes in this ``AND()``</span>
<span class="sd">              clause</span>
<span class="sd">            * The single node if there is exactly one post-filter node, e.g.</span>
<span class="sd">              if the only node in ``AND(A, B, ...)`` that is a post-filter</span>
<span class="sd">              node is ``B``</span>
<span class="sd">            * The current node if every stored node a post-filter node, e.g.</span>
<span class="sd">              if all nodes ``A, B, ...`` in ``AND(A, B, ...)`` are</span>
<span class="sd">              post-filter nodes</span>
<span class="sd">            * A **new** :class:`ConjunctionNode` containing the post-filter</span>
<span class="sd">              nodes, e.g. if only ``A, C`` are post-filter nodes in</span>
<span class="sd">              ``AND(A, B, C)``, then the returned node is ``AND(A, C)``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">post_filters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">PostFilterNode</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">post_filters</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">post_filters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">post_filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">post_filters</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">ConjunctionNode</span><span class="p">(</span><span class="o">*</span><span class="n">post_filters</span><span class="p">)</span>

<div class="viewcode-block" id="ConjunctionNode.resolve"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.ConjunctionNode.resolve">[docs]</a>    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bindings</span><span class="p">,</span> <span class="n">used</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a node with parameters replaced by the selected values.</span>

<span class="sd">        Args:</span>
<span class="sd">            bindings (dict): A mapping of parameter bindings.</span>
<span class="sd">            used (Dict[Union[str, int], bool]): A mapping of already used</span>
<span class="sd">                parameters. This will be modified for each parameter found</span>
<span class="sd">                in ``bindings``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Node: The current node, if all nodes are already resolved.</span>
<span class="sd">            Otherwise returns a modifed :class:`ConjunctionNode` with</span>
<span class="sd">            each individual node resolved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resolved_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">bindings</span><span class="p">,</span> <span class="n">used</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">resolved_nodes</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">ConjunctionNode</span><span class="p">(</span><span class="o">*</span><span class="n">resolved_nodes</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DisjunctionNode"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.DisjunctionNode">[docs]</a><span class="k">class</span> <span class="nc">DisjunctionNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tree node representing a boolean ``OR`` operator on multiple nodes.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        This constructor may not always return a :class:`DisjunctionNode`.</span>
<span class="sd">        If the passed in ``nodes`` has only one entry, that single node</span>
<span class="sd">        will be returned by the constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">        nodes (Tuple[Node, ...]): A list of nodes to be joined.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If ``nodes`` is empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_multiquery</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_nodes&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">nodes</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;DisjunctionNode() requires at least one node&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DisjunctionNode</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">clauses</span> <span class="o">=</span> <span class="n">_BooleanClauses</span><span class="p">(</span><span class="s2">&quot;DisjunctionNode&quot;</span><span class="p">,</span> <span class="n">combine_or</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">instance</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">clauses</span><span class="o">.</span><span class="n">or_parts</span>
        <span class="k">return</span> <span class="n">instance</span>

<div class="viewcode-block" id="DisjunctionNode.__getnewargs__"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.DisjunctionNode.__getnewargs__">[docs]</a>    <span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private API used to specify ``__new__`` arguments when unpickling.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This method only applies if the ``pickle`` protocol is 2 or</span>
<span class="sd">            greater.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Node, ...]: The list of stored nodes, converted to a</span>
<span class="sd">            :class:`tuple`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_nodes</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;OR(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">all_nodes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">DisjunctionNode</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_nodes</span>

<div class="viewcode-block" id="DisjunctionNode.resolve"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.DisjunctionNode.resolve">[docs]</a>    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bindings</span><span class="p">,</span> <span class="n">used</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a node with parameters replaced by the selected values.</span>

<span class="sd">        Args:</span>
<span class="sd">            bindings (dict): A mapping of parameter bindings.</span>
<span class="sd">            used (Dict[Union[str, int], bool]): A mapping of already used</span>
<span class="sd">                parameters. This will be modified for each parameter found</span>
<span class="sd">                in ``bindings``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Node: The current node, if all nodes are already resolved.</span>
<span class="sd">            Otherwise returns a modifed :class:`DisjunctionNode` with</span>
<span class="sd">            each individual node resolved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resolved_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">bindings</span><span class="p">,</span> <span class="n">used</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">resolved_nodes</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">DisjunctionNode</span><span class="p">(</span><span class="o">*</span><span class="n">resolved_nodes</span><span class="p">)</span></div></div>


<span class="c1"># AND and OR are preferred aliases for these.</span>
<span class="n">AND</span> <span class="o">=</span> <span class="n">ConjunctionNode</span>
<span class="n">OR</span> <span class="o">=</span> <span class="n">DisjunctionNode</span>


<span class="k">def</span> <span class="nf">_query_options</span><span class="p">(</span><span class="n">wrapped</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A decorator for functions with query arguments for arguments.</span>

<span class="sd">    Many methods of :class:`Query` all take more or less the same arguments</span>
<span class="sd">    from which they need to create a :class:`QueryOptions` instance following</span>
<span class="sd">    the same somewhat complicated rules.</span>

<span class="sd">    This decorator wraps these methods with a function that does this</span>
<span class="sd">    processing for them and passes in a :class:`QueryOptions` instance using</span>
<span class="sd">    the ``_options`` argument to those functions, bypassing all of the</span>
<span class="sd">    other arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If there are any positional arguments, get their names</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
    <span class="n">positional</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">name</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameter</span><span class="o">.</span><span class="n">kind</span>
        <span class="ow">in</span> <span class="p">(</span><span class="n">parameter</span><span class="o">.</span><span class="n">POSITIONAL_ONLY</span><span class="p">,</span> <span class="n">parameter</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;self&quot;</span>
    <span class="p">]</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">positional</span> <span class="ow">and</span> <span class="n">positional</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span><span class="p">)</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Maybe we already did this (in the case of X calling X_async)</span>
        <span class="k">if</span> <span class="s2">&quot;_options&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wrapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_options</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_options&quot;</span><span class="p">])</span>

        <span class="c1"># Transfer any positional args to keyword args, so they&#39;re all in the</span>
        <span class="c1"># same structure.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">positional</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">() got multiple values for argument &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">wrapped</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">name</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Deprecation warning: passing &#39;options&#39; to &#39;Query&#39; methods is &quot;</span>
                <span class="s2">&quot;deprecated. Please pass arguments directly.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys_only&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;projection&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot specify &#39;projection&#39; with &#39;keys_only=True&#39;&quot;</span>
                <span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;__key__&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;keys_only&quot;</span><span class="p">]</span>

        <span class="c1"># Get arguments for QueryOptions attributes</span>
        <span class="n">query_arguments</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">QueryOptions</span><span class="o">.</span><span class="n">slots</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># Any left over kwargs don&#39;t actually correspond to slots in</span>
        <span class="c1"># QueryOptions, but should be left to the QueryOptions constructor to</span>
        <span class="c1"># sort out. Some might be synonyms or shorthand for other options.</span>
        <span class="n">query_arguments</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">context_module</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span><span class="o">.</span><span class="n">client</span>
        <span class="n">query_options</span> <span class="o">=</span> <span class="n">QueryOptions</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="o">**</span><span class="n">query_arguments</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_options</span><span class="o">=</span><span class="n">query_options</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<div class="viewcode-block" id="QueryOptions"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.QueryOptions">[docs]</a><span class="k">class</span> <span class="nc">QueryOptions</span><span class="p">(</span><span class="n">_options</span><span class="o">.</span><span class="n">Options</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># Query options</span>
        <span class="s2">&quot;kind&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ancestor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;filters&quot;</span><span class="p">,</span>
        <span class="s2">&quot;order_by&quot;</span><span class="p">,</span>
        <span class="s2">&quot;orders&quot;</span><span class="p">,</span>
        <span class="s2">&quot;distinct_on&quot;</span><span class="p">,</span>
        <span class="s2">&quot;group_by&quot;</span><span class="p">,</span>
        <span class="s2">&quot;namespace&quot;</span><span class="p">,</span>
        <span class="s2">&quot;project&quot;</span><span class="p">,</span>
        <span class="c1"># Fetch options</span>
        <span class="s2">&quot;keys_only&quot;</span><span class="p">,</span>
        <span class="s2">&quot;limit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;offset&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_cursor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;end_cursor&quot;</span><span class="p">,</span>
        <span class="c1"># Both (!?!)</span>
        <span class="s2">&quot;projection&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;read_policy&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;read_consistency&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch_size&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prefetch_size&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;produce_cursors&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Deprecation warning: &#39;produce_cursors&#39; is deprecated. &quot;</span>
                <span class="s2">&quot;Cursors are always produced when available. This option is &quot;</span>
                <span class="s2">&quot;ignored.&quot;</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">QueryOptions</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">client</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">project</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">namespace</span></div>


<div class="viewcode-block" id="Query"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query">[docs]</a><span class="k">class</span> <span class="nc">Query</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Query object.</span>

<span class="sd">    Args:</span>
<span class="sd">        kind (str): The kind of entities to be queried.</span>
<span class="sd">        filters (FilterNode): Node representing a filter expression tree.</span>
<span class="sd">        ancestor (key.Key): Entities returned will be descendants of</span>
<span class="sd">            `ancestor`.</span>
<span class="sd">        order_by (list[Union[str, google.cloud.ndb.model.Property]]): The</span>
<span class="sd">            model properties used to order query results.</span>
<span class="sd">        orders (list[Union[str, google.cloud.ndb.model.Property]]):</span>
<span class="sd">            Deprecated. Synonym for `order_by`.</span>
<span class="sd">        project (str): The project to perform the query in. Also known as the</span>
<span class="sd">            app, in Google App Engine. If not passed, uses the client&#39;s value.</span>
<span class="sd">        app (str): Deprecated. Synonym for `project`.</span>
<span class="sd">        namespace (str): The namespace to which to restrict results.</span>
<span class="sd">            If not passed, uses the client&#39;s value.</span>
<span class="sd">        projection (list[str]): The fields to return as part of the query</span>
<span class="sd">            results.</span>
<span class="sd">        distinct_on (list[str]): The field names used to group query</span>
<span class="sd">            results.</span>
<span class="sd">        group_by (list[str]): Deprecated. Synonym for distinct_on.</span>
<span class="sd">        default_options (QueryOptions): QueryOptions object.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If any of the arguments are invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ancestor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">orders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">distinct_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">group_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">default_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_options</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">app</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">project</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot use both app and project, they are synonyms. app &quot;</span>
                    <span class="s2">&quot;is deprecated.&quot;</span>
                <span class="p">)</span>
            <span class="n">project</span> <span class="o">=</span> <span class="n">app</span>

        <span class="k">if</span> <span class="n">default_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Deprecation warning: passing default_options to the Query&quot;</span>
                <span class="s2">&quot;constructor is deprecated. Please directly pass any &quot;</span>
                <span class="s2">&quot;arguments you want to use to the Query constructor or its &quot;</span>
                <span class="s2">&quot;methods.&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_options</span><span class="p">,</span> <span class="n">QueryOptions</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;default_options must be QueryOptions or None; &quot;</span>
                    <span class="s2">&quot;received </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">default_options</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Not sure why we&#39;re doing all this checking just for this one</span>
            <span class="c1"># option.</span>
            <span class="k">if</span> <span class="n">projection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">default_options</span><span class="p">,</span> <span class="s2">&quot;projection&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;cannot use projection keyword argument and &quot;</span>
                        <span class="s2">&quot;default_options.projection at the same time&quot;</span>
                    <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">default_options</span> <span class="o">=</span> <span class="n">default_options</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_option</span><span class="p">(</span><span class="s2">&quot;kind&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="p">)</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_option</span><span class="p">(</span><span class="s2">&quot;filters&quot;</span><span class="p">,</span> <span class="n">filters</span><span class="p">)</span>
            <span class="n">ancestor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_option</span><span class="p">(</span><span class="s2">&quot;ancestor&quot;</span><span class="p">,</span> <span class="n">ancestor</span><span class="p">)</span>
            <span class="n">order_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_option</span><span class="p">(</span><span class="s2">&quot;order_by&quot;</span><span class="p">,</span> <span class="n">order_by</span><span class="p">)</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_option</span><span class="p">(</span><span class="s2">&quot;orders&quot;</span><span class="p">,</span> <span class="n">orders</span><span class="p">)</span>
            <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_option</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>
            <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_option</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_option</span><span class="p">(</span><span class="s2">&quot;namespace&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_option</span><span class="p">(</span><span class="s2">&quot;projection&quot;</span><span class="p">,</span> <span class="n">projection</span><span class="p">)</span>
            <span class="n">distinct_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_option</span><span class="p">(</span><span class="s2">&quot;distinct_on&quot;</span><span class="p">,</span> <span class="n">distinct_on</span><span class="p">)</span>
            <span class="n">group_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_option</span><span class="p">(</span><span class="s2">&quot;group_by&quot;</span><span class="p">,</span> <span class="n">group_by</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ancestor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">ParameterizedThing</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">ParameterizedFunction</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">func</span> <span class="o">!=</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                            <span class="s2">&quot;ancestor cannot be a GQL function&quot;</span>
                            <span class="s2">&quot;other than Key&quot;</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Key</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;ancestor must be a Key; &quot;</span>
                        <span class="s2">&quot;received </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ancestor</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">id</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ancestor cannot be an incomplete key&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">project</span> <span class="o">!=</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">app</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ancestor/project id mismatch&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">project</span> <span class="o">=</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">app</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">namespace</span> <span class="o">!=</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">namespace</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ancestor/namespace mismatch&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">namespace</span> <span class="o">=</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">namespace</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;filters must be a query Node or None; &quot;</span>
                    <span class="s2">&quot;received </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">orders</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot use both orders and order_by, they are synonyms&quot;</span>
                <span class="s2">&quot;(orders is deprecated now)&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">order_by</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">order_by</span> <span class="o">=</span> <span class="n">orders</span>
        <span class="k">if</span> <span class="n">order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order_by</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;order must be a list, a tuple or None; &quot;</span>
                    <span class="s2">&quot;received </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">order_by</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">order_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_property_orders</span><span class="p">(</span><span class="n">order_by</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span> <span class="o">=</span> <span class="n">ancestor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="n">order_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">projection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">projection</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;projection argument cannot be empty&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">projection</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;projection must be a tuple, list or None; &quot;</span>
                    <span class="s2">&quot;received </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_properties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_property_names</span><span class="p">(</span><span class="n">projection</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">distinct_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">group_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot use both group_by and distinct_on, they are synonyms. &quot;</span>
                <span class="s2">&quot;group_by is deprecated.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">distinct_on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">distinct_on</span> <span class="o">=</span> <span class="n">group_by</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">distinct_on</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">distinct_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">distinct_on</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;distinct_on argument cannot be empty&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">distinct_on</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;distinct_on must be a tuple, list or None; &quot;</span>
                    <span class="s2">&quot;received </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">distinct_on</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_properties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_property_names</span><span class="p">(</span><span class="n">distinct_on</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distinct_on</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">distinct_on</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;project=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;namespace=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;kind=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ancestor=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;filters=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;order_by=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;projection=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_property_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distinct_on</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;distinct_on=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_property_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distinct_on</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;default_options=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_options</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if results are guaranteed to contain a unique set of property</span>
<span class="sd">        values.</span>

<span class="sd">        This happens when every property in distinct_on is also in projection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distinct_on</span>
            <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_property_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distinct_on</span><span class="p">))</span>
            <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_property_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">))</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Query.filter"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">filters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new Query with additional filter(s) applied.</span>

<span class="sd">        Args:</span>
<span class="sd">            filters (list[Node]): One or more instances of Node.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Query: A new query with the new filters applied.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If one of the filters is not a Node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filters</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">new_filters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="n">new_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot filter a non-Node argument; received </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">filter</span>
                <span class="p">)</span>
            <span class="n">new_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_filters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">new_filters</span> <span class="o">=</span> <span class="n">new_filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_filters</span> <span class="o">=</span> <span class="n">ConjunctionNode</span><span class="p">(</span><span class="o">*</span><span class="n">new_filters</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">kind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">ancestor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">new_filters</span><span class="p">,</span>
            <span class="n">order_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
            <span class="n">default_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_options</span><span class="p">,</span>
            <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span>
            <span class="n">distinct_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distinct_on</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Query.order"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.order">[docs]</a>    <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">props</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new Query with additional sort order(s) applied.</span>

<span class="sd">        Args:</span>
<span class="sd">            props (list[Union[str, google.cloud.ndb.model.Property]]): One or</span>
<span class="sd">                more model properties to sort by.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Query: A new query with the new order applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">props</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">property_orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_property_orders</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
        <span class="n">order_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span>
        <span class="k">if</span> <span class="n">order_by</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">order_by</span> <span class="o">=</span> <span class="n">property_orders</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order_by</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">property_orders</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">kind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">ancestor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">order_by</span><span class="o">=</span><span class="n">order_by</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
            <span class="n">default_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_options</span><span class="p">,</span>
            <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span>
            <span class="n">distinct_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distinct_on</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Query.analyze"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.analyze">[docs]</a>    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list giving the parameters required by a query.</span>

<span class="sd">        When a query is created using gql, any bound parameters</span>
<span class="sd">        are created as ParameterNode instances. This method returns</span>
<span class="sd">        the names of any such parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[str]: required parameter names.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">class</span> <span class="nc">MockBindings</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="n">bindings</span> <span class="o">=</span> <span class="n">MockBindings</span><span class="p">()</span>
        <span class="n">used</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ancestor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">ParameterizedThing</span><span class="p">):</span>
            <span class="n">ancestor</span> <span class="o">=</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">bindings</span><span class="p">,</span> <span class="n">used</span><span class="p">)</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span>
        <span class="k">if</span> <span class="n">filters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">bindings</span><span class="p">,</span> <span class="n">used</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">used</span><span class="p">)</span>  <span class="c1"># Returns only the keys.</span></div>

<div class="viewcode-block" id="Query.bind"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.bind">[docs]</a>    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">positional</span><span class="p">,</span> <span class="o">**</span><span class="n">keyword</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bind parameter values.  Returns a new Query object.</span>

<span class="sd">        When a query is created using gql, any bound parameters</span>
<span class="sd">        are created as ParameterNode instances. This method</span>
<span class="sd">        receives values for both positional (:1, :2, etc.) or</span>
<span class="sd">        keyword (:xyz, :abc, etc.) bound parameters, then sets the</span>
<span class="sd">        values accordingly. This mechanism allows easy reuse of a</span>
<span class="sd">        parameterized query, by passing the values to bind here.</span>

<span class="sd">        Args:</span>
<span class="sd">            positional (list[Any]): One or more positional values to bind.</span>
<span class="sd">            keyword (dict[Any]): One or more keyword values to bind.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Query: A new query with the new bound parameter values.</span>

<span class="sd">        Raises:</span>
<span class="sd">            google.cloud.ndb.exceptions.BadArgumentError: If one of</span>
<span class="sd">                the positional parameters is not used in the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bindings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">positional</span><span class="p">):</span>
            <span class="n">bindings</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="n">used</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ancestor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">ParameterizedThing</span><span class="p">):</span>
            <span class="n">ancestor</span> <span class="o">=</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">bindings</span><span class="p">,</span> <span class="n">used</span><span class="p">)</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span>
        <span class="k">if</span> <span class="n">filters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">bindings</span><span class="p">,</span> <span class="n">used</span><span class="p">)</span>
        <span class="n">unused</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">positional</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
                <span class="n">unused</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unused</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
                <span class="s2">&quot;Positional arguments </span><span class="si">%s</span><span class="s2"> were given but not used.&quot;</span>
                <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unused</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">kind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">ancestor</span><span class="o">=</span><span class="n">ancestor</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">order_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
            <span class="n">default_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_options</span><span class="p">,</span>
            <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span>
            <span class="n">distinct_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distinct_on</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_to_property_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
        <span class="n">fixed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">fixed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Property</span><span class="p">):</span>
                <span class="n">fixed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;Unexpected property </span><span class="si">{}</span><span class="s2">; &quot;</span>
                    <span class="s2">&quot;should be string or Property&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">fixed</span>

    <span class="k">def</span> <span class="nf">_to_property_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_by</span><span class="p">):</span>
        <span class="n">orders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">order_by</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">PropertyOrder</span><span class="p">):</span>
                <span class="c1"># if a negated property, will already be a PropertyOrder</span>
                <span class="n">orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Property</span><span class="p">):</span>
                <span class="c1"># use the sign to turn it into a PropertyOrder</span>
                <span class="n">orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">+</span><span class="n">order</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">order</span>
                <span class="n">reverse</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">reverse</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">property_order</span> <span class="o">=</span> <span class="n">PropertyOrder</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
                <span class="n">orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">property_order</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Order values must be properties or strings&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orders</span>

    <span class="k">def</span> <span class="nf">_check_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fixed</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">modelclass</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">_kind_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">modelclass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">modelclass</span><span class="o">.</span><span class="n">_check_properties</span><span class="p">(</span><span class="n">fixed</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Query.fetch"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.fetch">[docs]</a>    <span class="nd">@_query_options</span>
    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">keys_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prefetch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">produce_cursors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">start_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1">#  _datastore_api.EVENTUAL,  # placeholder</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run a query, fetching results.</span>

<span class="sd">        Args:</span>
<span class="sd">            limit (Optional[int]): Maximum number of results to fetch.</span>
<span class="sd">                data:`None` or data:`0` indicates no limit.</span>
<span class="sd">            keys_only (bool): Return keys instead of entities.</span>
<span class="sd">            projection (list[str]): The fields to return as part of the query</span>
<span class="sd">                results.</span>
<span class="sd">            offset (int): Number of query results to skip.</span>
<span class="sd">            limit (Optional[int]): Maximum number of query results to return.</span>
<span class="sd">                If not specified, there is no limit.</span>
<span class="sd">            batch_size (Optional[int]): Number of results to fetch in a single</span>
<span class="sd">                RPC call. Affects efficiency of queries only. Larger batch</span>
<span class="sd">                sizes use more memory but make fewer RPC calls.</span>
<span class="sd">            prefetch_size (Optional[int]): Overrides batch size for first batch</span>
<span class="sd">                returned.</span>
<span class="sd">            produce_cursors (bool): Whether to generate cursors from query.</span>
<span class="sd">            start_cursor: Starting point for search.</span>
<span class="sd">            end_cursor: Endpoint point for search.</span>
<span class="sd">            timeout (Optional[int]): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (Optional[int]): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            read_policy: Defaults to `ndb.EVENTUAL` for potentially faster</span>
<span class="sd">                query results without having to wait for Datastore to apply</span>
<span class="sd">                pending changes to all returned records.</span>
<span class="sd">            options (QueryOptions): DEPRECATED: An object containing options</span>
<span class="sd">                values for some of these arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List([model.Model]): The query results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_async</span><span class="p">(</span><span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span></div>

<div class="viewcode-block" id="Query.fetch_async"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.fetch_async">[docs]</a>    <span class="nd">@_query_options</span>
    <span class="k">def</span> <span class="nf">fetch_async</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">keys_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prefetch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">produce_cursors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">start_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1">#  _datastore_api.EVENTUAL,  # placeholder</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run a query, asynchronously fetching the results.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys_only (bool): Return keys instead of entities.</span>
<span class="sd">            projection (list[str]): The fields to return as part of the query</span>
<span class="sd">                results.</span>
<span class="sd">            offset (int): Number of query results to skip.</span>
<span class="sd">            limit (Optional[int]): Maximum number of query results to return.</span>
<span class="sd">                If not specified, there is no limit.</span>
<span class="sd">            batch_size (Optional[int]): Number of results to fetch in a single</span>
<span class="sd">                RPC call. Affects efficiency of queries only. Larger batch</span>
<span class="sd">                sizes use more memory but make fewer RPC calls.</span>
<span class="sd">            prefetch_size (Optional[int]): Overrides batch size for first batch</span>
<span class="sd">                returned.</span>
<span class="sd">            produce_cursors (bool): Whether to generate cursors from query.</span>
<span class="sd">            start_cursor: Starting point for search.</span>
<span class="sd">            end_cursor: Endpoint point for search.</span>
<span class="sd">            timeout (Optional[int]): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (Optional[int]): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            read_policy: Defaults to `ndb.EVENTUAL` for potentially faster</span>
<span class="sd">                query results without having to wait for Datastore to apply</span>
<span class="sd">                pending changes to all returned records.</span>
<span class="sd">            options (QueryOptions): DEPRECATED: An object containing options</span>
<span class="sd">                values for some of these arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tasklets.Future: Eventual result will be a List[model.Model] of the</span>
<span class="sd">                results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_datastore_query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">_options</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">given</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get given value or a provided default for an option.</span>

<span class="sd">        Precedence is given first to the `given` value, then any value passed</span>
<span class="sd">        in with `options`, then any value that is already set on this query,</span>
<span class="sd">        and, lastly, any default value in `default_options` if provided to the</span>
<span class="sd">        :class:`Query` constructor.</span>

<span class="sd">        This attempts to reconcile, in as rational a way possible, all the</span>
<span class="sd">        different ways of passing the same option to a query established by</span>
<span class="sd">        legacy NDB. Because of the absurd amount of complexity involved,</span>
<span class="sd">        `QueryOptions` is deprecated in favor of just passing arguments</span>
<span class="sd">        directly to the `Query` constructor or its methods.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Name of the option.</span>
<span class="sd">            given (Any): The given value for the option.</span>
<span class="sd">            options (Optional[QueryOptions]): An object containing option</span>
<span class="sd">                values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: Either the given value or a provided default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">given</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">given</span>

        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>

        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_options</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Query.run_to_queue"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.run_to_queue">[docs]</a>    <span class="k">def</span> <span class="nf">run_to_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dsquery</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run this query, putting entities into the given queue.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Query.iter"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.iter">[docs]</a>    <span class="nd">@_query_options</span>
    <span class="k">def</span> <span class="nf">iter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">keys_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prefetch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">produce_cursors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">start_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1">#  _datastore_api.EVENTUAL,  # placeholder</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get an iterator over query results.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys_only (bool): Return keys instead of entities.</span>
<span class="sd">            limit (Optional[int]): Maximum number of query results to return.</span>
<span class="sd">                If not specified, there is no limit.</span>
<span class="sd">            projection (list[str]): The fields to return as part of the query</span>
<span class="sd">                results.</span>
<span class="sd">            offset (int): Number of query results to skip.</span>
<span class="sd">            batch_size (Optional[int]): Number of results to fetch in a single</span>
<span class="sd">                RPC call. Affects efficiency of queries only. Larger batch</span>
<span class="sd">                sizes use more memory but make fewer RPC calls.</span>
<span class="sd">            prefetch_size (Optional[int]): Overrides batch size for first batch</span>
<span class="sd">                returned.</span>
<span class="sd">            produce_cursors (bool): Whether to generate cursors from query.</span>
<span class="sd">            start_cursor: Starting point for search.</span>
<span class="sd">            end_cursor: Endpoint point for search.</span>
<span class="sd">            timeout (Optional[int]): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (Optional[int]): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            read_policy: Defaults to `ndb.EVENTUAL` for potentially faster</span>
<span class="sd">                query results without having to wait for Datastore to apply</span>
<span class="sd">                pending changes to all returned records.</span>
<span class="sd">            options (QueryOptions): DEPRECATED: An object containing options</span>
<span class="sd">                values for some of these arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            QueryIterator: An iterator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_datastore_query</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">_options</span><span class="p">)</span></div>

    <span class="fm">__iter__</span> <span class="o">=</span> <span class="nb">iter</span>

<div class="viewcode-block" id="Query.map"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.map">[docs]</a>    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">pass_batch_into_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">merge_future</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">keys_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prefetch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">produce_cursors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">start_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1">#  _datastore_api.EVENTUAL,  # placeholder</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Map a callback function or tasklet over the query results.</span>

<span class="sd">        Args:</span>
<span class="sd">            callback (Callable): A function or tasklet to be applied to each</span>
<span class="sd">                result; see below.</span>
<span class="sd">            merge_future: Optional ``Future`` subclass; see below.</span>
<span class="sd">            keys_only (bool): Return keys instead of entities.</span>
<span class="sd">            projection (list[str]): The fields to return as part of the query</span>
<span class="sd">                results.</span>
<span class="sd">            offset (int): Number of query results to skip.</span>
<span class="sd">            limit (Optional[int]): Maximum number of query results to return.</span>
<span class="sd">                If not specified, there is no limit.</span>
<span class="sd">            batch_size (Optional[int]): Number of results to fetch in a single</span>
<span class="sd">                RPC call. Affects efficiency of queries only. Larger batch</span>
<span class="sd">                sizes use more memory but make fewer RPC calls.</span>
<span class="sd">            prefetch_size (Optional[int]): Overrides batch size for first batch</span>
<span class="sd">                returned.</span>
<span class="sd">            produce_cursors (bool): Whether to generate cursors from query.</span>
<span class="sd">            start_cursor: Starting point for search.</span>
<span class="sd">            end_cursor: Endpoint point for search.</span>
<span class="sd">            timeout (Optional[int]): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (Optional[int]): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            read_policy: Defaults to `ndb.EVENTUAL` for potentially faster</span>
<span class="sd">                query results without having to wait for Datastore to apply</span>
<span class="sd">                pending changes to all returned records.</span>
<span class="sd">            options (QueryOptions): DEPRECATED: An object containing options</span>
<span class="sd">                values for some of these arguments.</span>

<span class="sd">        Callback signature: The callback is normally called with an entity</span>
<span class="sd">        as argument.  However if keys_only=True is given, it is called</span>
<span class="sd">        with a Key.  Also, when pass_batch_into_callback is True, it is</span>
<span class="sd">        called with three arguments: the current batch, the index within</span>
<span class="sd">        the batch, and the entity or Key at that index.  The callback can</span>
<span class="sd">        return whatever it wants.  If the callback is None, a trivial</span>
<span class="sd">        callback is assumed that just returns the entity or key passed in</span>
<span class="sd">        (ignoring produce_cursors).</span>

<span class="sd">        Optional merge future: The merge_future is an advanced argument</span>
<span class="sd">        that can be used to override how the callback results are combined</span>
<span class="sd">        into the overall map() return value.  By default a list of</span>
<span class="sd">        callback return values is produced.  By substituting one of a</span>
<span class="sd">        small number of specialized alternatives you can arrange</span>
<span class="sd">        otherwise.  See tasklets.MultiFuture for the default</span>
<span class="sd">        implementation and a description of the protocol the merge_future</span>
<span class="sd">        object must implement the default.  Alternatives from the same</span>
<span class="sd">        module include QueueFuture, SerialQueueFuture and ReducingFuture.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: When the query has run to completion and all callbacks have</span>
<span class="sd">                returned, map() returns a list of the results of all callbacks.</span>
<span class="sd">                (But see &#39;optional merge future&#39; above.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Query.map_async"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.map_async">[docs]</a>    <span class="k">def</span> <span class="nf">map_async</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">pass_batch_into_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">merge_future</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">keys_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prefetch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">produce_cursors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">start_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1">#  _datastore_api.EVENTUAL,  # placeholder</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Map a callback function or tasklet over the query results.</span>

<span class="sd">        This is the asynchronous version of :meth:`Query.map`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tasklets.Future: See :meth:`Query.map` for eventual result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Query.get"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">keys_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prefetch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">produce_cursors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">start_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1">#  _datastore_api.EVENTUAL,  # placeholder</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the first query result, if any.</span>

<span class="sd">        This is equivalent to calling ``q.fetch(1)`` and returning the first</span>
<span class="sd">        result, if any.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys_only (bool): Return keys instead of entities.</span>
<span class="sd">            projection (list[str]): The fields to return as part of the query</span>
<span class="sd">                results.</span>
<span class="sd">            offset (int): Number of query results to skip.</span>
<span class="sd">            limit (Optional[int]): Maximum number of query results to return.</span>
<span class="sd">                If not specified, there is no limit.</span>
<span class="sd">            batch_size (Optional[int]): Number of results to fetch in a single</span>
<span class="sd">                RPC call. Affects efficiency of queries only. Larger batch</span>
<span class="sd">                sizes use more memory but make fewer RPC calls.</span>
<span class="sd">            prefetch_size (Optional[int]): Overrides batch size for first batch</span>
<span class="sd">                returned.</span>
<span class="sd">            produce_cursors (bool): Whether to generate cursors from query.</span>
<span class="sd">            start_cursor: Starting point for search.</span>
<span class="sd">            end_cursor: Endpoint point for search.</span>
<span class="sd">            timeout (Optional[int]): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (Optional[int]): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            read_policy: Defaults to `ndb.EVENTUAL` for potentially faster</span>
<span class="sd">                query results without having to wait for Datastore to apply</span>
<span class="sd">                pending changes to all returned records.</span>
<span class="sd">            options (QueryOptions): DEPRECATED: An object containing options</span>
<span class="sd">                values for some of these arguments.</span>

<span class="sd">            Returns:</span>
<span class="sd">                Optional[Union[entity.Entity, key.Key]]: A single result, or</span>
<span class="sd">                    :data:`None` if there are no results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Query.get_async"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.get_async">[docs]</a>    <span class="k">def</span> <span class="nf">get_async</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">keys_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prefetch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">produce_cursors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">start_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1">#  _datastore_api.EVENTUAL,  # placeholder</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the first query result, if any.</span>

<span class="sd">        This is the asynchronous version of :meth:`Query.get`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tasklets.Future: See :meth:`Query.get` for eventual result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Query.count"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">keys_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prefetch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">produce_cursors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">start_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1">#  _datastore_api.EVENTUAL,  # placeholder</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Count the number of query results, up to a limit.</span>

<span class="sd">        This returns the same result as ``len(q.fetch(limit))`` but more</span>
<span class="sd">        efficiently.</span>

<span class="sd">        Note that you should pass a maximum value to limit the amount of</span>
<span class="sd">        work done by the query.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys_only (bool): Return keys instead of entities.</span>
<span class="sd">            projection (list[str]): The fields to return as part of the query</span>
<span class="sd">                results.</span>
<span class="sd">            offset (int): Number of query results to skip.</span>
<span class="sd">            limit (Optional[int]): Maximum number of query results to return.</span>
<span class="sd">                If not specified, there is no limit.</span>
<span class="sd">            batch_size (Optional[int]): Number of results to fetch in a single</span>
<span class="sd">                RPC call. Affects efficiency of queries only. Larger batch</span>
<span class="sd">                sizes use more memory but make fewer RPC calls.</span>
<span class="sd">            prefetch_size (Optional[int]): Overrides batch size for first batch</span>
<span class="sd">                returned.</span>
<span class="sd">            produce_cursors (bool): Whether to generate cursors from query.</span>
<span class="sd">            start_cursor: Starting point for search.</span>
<span class="sd">            end_cursor: Endpoint point for search.</span>
<span class="sd">            timeout (Optional[int]): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (Optional[int]): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            read_policy: Defaults to `ndb.EVENTUAL` for potentially faster</span>
<span class="sd">                query results without having to wait for Datastore to apply</span>
<span class="sd">                pending changes to all returned records.</span>
<span class="sd">            options (QueryOptions): DEPRECATED: An object containing options</span>
<span class="sd">                values for some of these arguments.</span>

<span class="sd">            Returns:</span>
<span class="sd">                Optional[Union[entity.Entity, key.Key]]: A single result, or</span>
<span class="sd">                    :data:`None` if there are no results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Query.count_async"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.count_async">[docs]</a>    <span class="k">def</span> <span class="nf">count_async</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">keys_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prefetch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">produce_cursors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">start_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1">#  _datastore_api.EVENTUAL,  # placeholder</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Count the number of query results, up to a limit.</span>

<span class="sd">        This is the asynchronous version of :meth:`Query.count`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tasklets.Future: See :meth:`Query.count` for eventual result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Query.fetch_page"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.fetch_page">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_page</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">page_size</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">keys_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prefetch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">produce_cursors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">start_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1">#  _datastore_api.EVENTUAL,  # placeholder</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch a page of results.</span>

<span class="sd">        This is a specialized method for use by paging user interfaces.</span>

<span class="sd">        To fetch the next page, you pass the cursor returned by one call to the</span>
<span class="sd">        next call using the `start_cursor` argument.  A common idiom is to pass</span>
<span class="sd">        the cursor to the client using :meth:`_datastore_query.Cursor.urlsafe`</span>
<span class="sd">        and to reconstruct that cursor on a subsequent request using the</span>
<span class="sd">        `urlsafe` argument to :class:`Cursor`.</span>

<span class="sd">        Args:</span>
<span class="sd">            page_size (int): The number of results per page. At most, this many</span>
<span class="sd">                results will be returned.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[list, bytes, bool]: A tuple `(results, cursor, more)` where</span>
<span class="sd">                `results` is a list of query results, `cursor` is a cursor</span>
<span class="sd">                pointing just after the last result returned, and `more`</span>
<span class="sd">                indicates whether there are (likely) more results after that.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Query.fetch_page_async"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.Query.fetch_page_async">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_page_async</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">page_size</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">keys_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prefetch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">produce_cursors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">start_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1">#  _datastore_api.EVENTUAL,  # placeholder</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch a page of results.</span>

<span class="sd">        This is the asynchronous version of :meth:`Query.fetch_page`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tasklets.Future: See :meth:`Query.fetch_page` for eventual result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>


<div class="viewcode-block" id="gql"><a class="viewcode-back" href="../../../../query.html#google.cloud.ndb.query.gql">[docs]</a><span class="k">def</span> <span class="nf">gql</span><span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a GQL query string.</span>

<span class="sd">    Args:</span>
<span class="sd">        query_string (str): Full GQL query, e.g. &#39;SELECT * FROM Kind WHERE</span>
<span class="sd">            prop = 1 ORDER BY prop2&#39;.</span>
<span class="sd">        args: If present, used to call bind().</span>
<span class="sd">        kwds: If present, used to call bind().</span>

<span class="sd">    Returns:</span>
<span class="sd">        Query: a query instance.</span>

<span class="sd">    Raises:</span>
<span class="sd">        google.cloud.ndb.exceptions.BadQueryError: When bad gql is passed in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">_gql</span><span class="o">.</span><span class="n">GQL</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span><span class="o">.</span><span class="n">get_query</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwds</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">query</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">ndb</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../key.html">Key</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../model.html">Model and Property</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../query.html">Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tasklets.html">Tasklets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../exceptions.html">Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../polymodel.html">Polymorphic Models and Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../django-middleware.html">Django Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../msgprop.html">ProtoRPC Message Properties</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../blobstore.html">Blobstore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../metadata.html">Datastore Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../stats.html">Datastore Statistics</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Google.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>