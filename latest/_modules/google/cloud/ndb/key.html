
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>google.cloud.ndb.key &#8212; ndb 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for google.cloud.ndb.key</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2018 Google LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Provides a :class:`.Key` for Google Cloud Datastore.</span>

<span class="sd">.. testsetup:: *</span>

<span class="sd">    from google.cloud import ndb</span>

<span class="sd">A key encapsulates the following pieces of information, which together</span>
<span class="sd">uniquely designate a (possible) entity in Google Cloud Datastore:</span>

<span class="sd">* a Google Cloud Platform project (a string)</span>
<span class="sd">* a list of one or more ``(kind, id)`` pairs where ``kind`` is a string</span>
<span class="sd">  and ``id`` is either a string or an integer</span>
<span class="sd">* an optional namespace (a string)</span>

<span class="sd">The application ID must always be part of the key, but since most</span>
<span class="sd">applications can only access their own entities, it defaults to the</span>
<span class="sd">current application ID and you rarely need to worry about it.</span>

<span class="sd">The namespace designates a top-level partition of the key space for a</span>
<span class="sd">particular application. If you&#39;ve never heard of namespaces, you can</span>
<span class="sd">safely ignore this feature.</span>

<span class="sd">Most of the action is in the ``(kind, id)`` pairs. A key must have at</span>
<span class="sd">least one ``(kind, id)`` pair. The last ``(kind, id)`` pair gives the kind</span>
<span class="sd">and the ID of the entity that the key refers to, the others merely</span>
<span class="sd">specify a &quot;parent key&quot;.</span>

<span class="sd">The kind is a string giving the name of the model class used to</span>
<span class="sd">represent the entity. In more traditional databases this would be</span>
<span class="sd">the table name. A model class is a Python class derived from</span>
<span class="sd">:class:`.Model`. Only the class name itself is used as the kind. This means</span>
<span class="sd">all your model classes must be uniquely named within one application. You can</span>
<span class="sd">override this on a per-class basis.</span>

<span class="sd">The ID is either a string or an integer. When the ID is a string, the</span>
<span class="sd">application is in control of how it assigns IDs. For example, you</span>
<span class="sd">could use an email address as the ID for Account entities.</span>

<span class="sd">To use integer IDs, it&#39;s common to let the datastore choose a unique ID for</span>
<span class="sd">an entity when first inserted into the datastore. The ID can be set to</span>
<span class="sd">:data:`None` to represent the key for an entity that hasn&#39;t yet been</span>
<span class="sd">inserted into the datastore. The completed key (including the assigned ID)</span>
<span class="sd">will be returned after the entity is successfully inserted into the datastore.</span>

<span class="sd">A key for which the ID of the last ``(kind, id)`` pair is set to :data:`None`</span>
<span class="sd">is called an **incomplete key** or **partial key**. Such keys can only be used</span>
<span class="sd">to insert entities into the datastore.</span>

<span class="sd">A key with exactly one ``(kind, id)`` pair is called a top level key or a</span>
<span class="sd">root key. Top level keys are also used as entity groups, which play a</span>
<span class="sd">role in transaction management.</span>

<span class="sd">If there is more than one ``(kind, id)`` pair, all but the last pair</span>
<span class="sd">represent the &quot;ancestor path&quot;, also known as the key of the &quot;parent entity&quot;.</span>

<span class="sd">Other constraints:</span>

<span class="sd">* Kinds and string IDs must not be empty and must be at most 1500 bytes</span>
<span class="sd">  long (after UTF-8 encoding)</span>
<span class="sd">* Integer IDs must be at least ``1`` and at most ``2**63 - 1`` (i.e. the</span>
<span class="sd">  positive part of the range for a 64-bit signed integer)</span>

<span class="sd">For more info about namespaces, see the multitenancy `overview`_.</span>
<span class="sd">In the &quot;legacy&quot; Google App Engine runtime, the default namespace could be</span>
<span class="sd">set via the namespace manager (``google.appengine.api.namespace_manager``).</span>
<span class="sd">On the gVisor Google App Engine runtime (e.g. Python 3.7), the namespace</span>
<span class="sd">manager is not available so the default is to have an unset or empty</span>
<span class="sd">namespace. To explicitly select the empty namespace pass ``namespace=&quot;&quot;``.</span>

<span class="sd">.. _overview: https://cloud.google.com/appengine/docs/standard/python/multitenancy/</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">functools</span>

<span class="kn">from</span> <span class="nn">google.cloud.datastore</span> <span class="k">import</span> <span class="n">_app_engine_key_pb2</span>
<span class="kn">from</span> <span class="nn">google.cloud.datastore</span> <span class="k">import</span> <span class="n">key</span> <span class="k">as</span> <span class="n">_key_module</span>
<span class="kn">import</span> <span class="nn">google.cloud.datastore</span>

<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">context</span> <span class="k">as</span> <span class="n">context_module</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">_datastore_api</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">_options</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">tasklets</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">_transaction</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">]</span>
<span class="n">_APP_ID_ENVIRONMENT</span> <span class="o">=</span> <span class="s2">&quot;APPLICATION_ID&quot;</span>
<span class="n">_APP_ID_DEFAULT</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span>
<span class="n">_WRONG_TYPE</span> <span class="o">=</span> <span class="s2">&quot;Cannot construct Key reference on non-Key class; received </span><span class="si">{!r}</span><span class="s2">&quot;</span>
<span class="n">_REFERENCE_APP_MISMATCH</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Key reference constructed uses a different app </span><span class="si">{!r}</span><span class="s2"> than &quot;</span>
    <span class="s2">&quot;the one specified </span><span class="si">{!r}</span><span class="s2">&quot;</span>
<span class="p">)</span>
<span class="n">_REFERENCE_NAMESPACE_MISMATCH</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Key reference constructed uses a different namespace </span><span class="si">{!r}</span><span class="s2"> than &quot;</span>
    <span class="s2">&quot;the one specified </span><span class="si">{!r}</span><span class="s2">&quot;</span>
<span class="p">)</span>
<span class="n">_INVALID_ID_TYPE</span> <span class="o">=</span> <span class="s2">&quot;Key ID must be a string or a number; received </span><span class="si">{!r}</span><span class="s2">&quot;</span>
<span class="n">_NO_LEGACY</span> <span class="o">=</span> <span class="s2">&quot;The `google.appengine.ext.db` module is not available.&quot;</span>
<span class="n">_MAX_INTEGER_ID</span> <span class="o">=</span> <span class="mh">0x7FFFFFFFFFFFFFFF</span>  <span class="c1"># 2 ** 63 - 1</span>
<span class="n">_MAX_KEYPART_BYTES</span> <span class="o">=</span> <span class="mi">1500</span>
<span class="n">_BAD_KIND</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Key kind string must be a non-empty string up to </span><span class="si">{:d}</span><span class="s2"> bytes; received </span><span class="si">{}</span><span class="s2">&quot;</span>
<span class="p">)</span>
<span class="n">_BAD_INTEGER_ID</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Key ID number is outside of range [1, 2^63 - 1]; received </span><span class="si">{:d}</span><span class="s2">&quot;</span>
<span class="p">)</span>
<span class="n">_BAD_STRING_ID</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Key name strings must be non-empty strings up to </span><span class="si">{:d}</span><span class="s2"> bytes; received </span><span class="si">{}</span><span class="s2">&quot;</span>
<span class="p">)</span>


<div class="viewcode-block" id="Key"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key">[docs]</a><span class="k">class</span> <span class="nc">Key</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;An immutable datastore key.</span>

<span class="sd">    For flexibility and convenience, multiple constructor signatures are</span>
<span class="sd">    supported.</span>

<span class="sd">    The primary way to construct a key is using positional arguments:</span>

<span class="sd">    .. testsetup:: *</span>

<span class="sd">        from unittest import mock</span>
<span class="sd">        from google.cloud.ndb import context as context_module</span>
<span class="sd">        client = mock.Mock(project=&quot;testing&quot;, spec=(&quot;project&quot;,), namespace=&quot;&quot;)</span>
<span class="sd">        context = context_module.Context(client, stub=mock.Mock(spec=())).use()</span>
<span class="sd">        context.__enter__()</span>
<span class="sd">        kind1, id1 = &quot;Parent&quot;, &quot;C&quot;</span>
<span class="sd">        kind2, id2 = &quot;Child&quot;, 42</span>

<span class="sd">    .. testcleanup:: *</span>

<span class="sd">        context.__exit__(None, None, None)</span>

<span class="sd">    .. doctest:: key-constructor-primary</span>

<span class="sd">        &gt;&gt;&gt; ndb.Key(kind1, id1, kind2, id2)</span>
<span class="sd">        Key(&#39;Parent&#39;, &#39;C&#39;, &#39;Child&#39;, 42)</span>

<span class="sd">    This is shorthand for either of the following two longer forms:</span>

<span class="sd">    .. doctest:: key-constructor-flat-or-pairs</span>

<span class="sd">        &gt;&gt;&gt; ndb.Key(pairs=[(kind1, id1), (kind2, id2)])</span>
<span class="sd">        Key(&#39;Parent&#39;, &#39;C&#39;, &#39;Child&#39;, 42)</span>
<span class="sd">        &gt;&gt;&gt; ndb.Key(flat=[kind1, id1, kind2, id2])</span>
<span class="sd">        Key(&#39;Parent&#39;, &#39;C&#39;, &#39;Child&#39;, 42)</span>

<span class="sd">    Either of the above constructor forms can additionally pass in another</span>
<span class="sd">    key via the ``parent`` keyword. The ``(kind, id)`` pairs of the parent key</span>
<span class="sd">    are inserted before the ``(kind, id)`` pairs passed explicitly.</span>

<span class="sd">    .. doctest:: key-constructor-parent</span>

<span class="sd">        &gt;&gt;&gt; parent = ndb.Key(kind1, id1)</span>
<span class="sd">        &gt;&gt;&gt; parent</span>
<span class="sd">        Key(&#39;Parent&#39;, &#39;C&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ndb.Key(kind2, id2, parent=parent)</span>
<span class="sd">        Key(&#39;Parent&#39;, &#39;C&#39;, &#39;Child&#39;, 42)</span>

<span class="sd">    You can also construct a Key from a &quot;url-safe&quot; encoded string:</span>

<span class="sd">    .. doctest:: key-constructor-urlsafe</span>

<span class="sd">        &gt;&gt;&gt; ndb.Key(urlsafe=b&quot;agdleGFtcGxlcgsLEgRLaW5kGLkKDA&quot;)</span>
<span class="sd">        Key(&#39;Kind&#39;, 1337, app=&#39;example&#39;)</span>

<span class="sd">    For rare use cases the following constructors exist:</span>

<span class="sd">    .. testsetup:: key-constructor-rare</span>

<span class="sd">        from google.cloud.datastore import _app_engine_key_pb2</span>
<span class="sd">        reference = _app_engine_key_pb2.Reference(</span>
<span class="sd">            app=&quot;example&quot;,</span>
<span class="sd">            path=_app_engine_key_pb2.Path(element=[</span>
<span class="sd">                _app_engine_key_pb2.Path.Element(type=&quot;Kind&quot;, id=1337),</span>
<span class="sd">            ]),</span>
<span class="sd">        )</span>

<span class="sd">    .. doctest:: key-constructor-rare</span>

<span class="sd">        &gt;&gt;&gt; # Passing in a low-level Reference object</span>
<span class="sd">        &gt;&gt;&gt; reference</span>
<span class="sd">        app: &quot;example&quot;</span>
<span class="sd">        path {</span>
<span class="sd">          Element {</span>
<span class="sd">            type: &quot;Kind&quot;</span>
<span class="sd">            id: 1337</span>
<span class="sd">          }</span>
<span class="sd">        }</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; ndb.Key(reference=reference)</span>
<span class="sd">        Key(&#39;Kind&#39;, 1337, app=&#39;example&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # Passing in a serialized low-level Reference</span>
<span class="sd">        &gt;&gt;&gt; serialized = reference.SerializeToString()</span>
<span class="sd">        &gt;&gt;&gt; serialized</span>
<span class="sd">        b&#39;j\\x07exampler\\x0b\\x0b\\x12\\x04Kind\\x18\\xb9\\n\\x0c&#39;</span>
<span class="sd">        &gt;&gt;&gt; ndb.Key(serialized=serialized)</span>
<span class="sd">        Key(&#39;Kind&#39;, 1337, app=&#39;example&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # For unpickling, the same as ndb.Key(**kwargs)</span>
<span class="sd">        &gt;&gt;&gt; kwargs = {&quot;pairs&quot;: [(&quot;Cheese&quot;, &quot;Cheddar&quot;)], &quot;namespace&quot;: &quot;good&quot;}</span>
<span class="sd">        &gt;&gt;&gt; ndb.Key(kwargs)</span>
<span class="sd">        Key(&#39;Cheese&#39;, &#39;Cheddar&#39;, namespace=&#39;good&#39;)</span>

<span class="sd">    The &quot;url-safe&quot; string is really a websafe-base64-encoded serialized</span>
<span class="sd">    ``Reference``, but it&#39;s best to think of it as just an opaque unique</span>
<span class="sd">    string.</span>

<span class="sd">    If a ``Reference`` is passed (using one of the ``reference``,</span>
<span class="sd">    ``serialized`` or ``urlsafe`` keywords), the positional arguments and</span>
<span class="sd">    ``namespace`` must match what is already present in the ``Reference``</span>
<span class="sd">    (after decoding if necessary). The parent keyword cannot be combined with</span>
<span class="sd">    a ``Reference`` in any form.</span>

<span class="sd">    Keys are immutable, which means that a Key object cannot be modified</span>
<span class="sd">    once it has been created. This is enforced by the implementation as</span>
<span class="sd">    well as Python allows.</span>

<span class="sd">    Keys also support interaction with the datastore; the methods :meth:`get`,</span>
<span class="sd">    :meth:`get_async`, :meth:`delete` and :meth:`delete_async` are</span>
<span class="sd">    the only ones that engage in any kind of I/O activity.</span>

<span class="sd">    Keys may be pickled.</span>

<span class="sd">    Subclassing Key is best avoided; it would be hard to get right.</span>

<span class="sd">    Args:</span>
<span class="sd">        path_args (Union[Tuple[str, ...], Tuple[Dict]]): Either a tuple of</span>
<span class="sd">            ``(kind, id)`` pairs or a single dictionary containing only keyword</span>
<span class="sd">            arguments.</span>
<span class="sd">        reference (Optional[\</span>
<span class="sd">            ~google.cloud.datastore._app_engine_key_pb2.Reference]): A</span>
<span class="sd">            reference protobuf representing a key.</span>
<span class="sd">        serialized (Optional[bytes]): A reference protobuf serialized to bytes.</span>
<span class="sd">        urlsafe (Optional[str]): A reference protobuf serialized to bytes. The</span>
<span class="sd">            raw bytes are then converted to a websafe base64-encoded string.</span>
<span class="sd">        pairs (Optional[Iterable[Tuple[str, Union[str, int]]]]): An iterable</span>
<span class="sd">            of ``(kind, id)`` pairs. If this argument is used, then</span>
<span class="sd">            ``path_args`` should be empty.</span>
<span class="sd">        flat (Optional[Iterable[Union[str, int]]]): An iterable of the</span>
<span class="sd">            ``(kind, id)`` pairs but flattened into a single value. For</span>
<span class="sd">            example, the pairs ``[(&quot;Parent&quot;, 1), (&quot;Child&quot;, &quot;a&quot;)]`` would be</span>
<span class="sd">            flattened to ``[&quot;Parent&quot;, 1, &quot;Child&quot;, &quot;a&quot;]``.</span>
<span class="sd">        app (Optional[str]): The Google Cloud Platform project (previously</span>
<span class="sd">            on Google App Engine, this was called the Application ID).</span>
<span class="sd">        namespace (Optional[str]): The namespace for the key.</span>
<span class="sd">        parent (Optional[Key]): The parent of the key being</span>
<span class="sd">            constructed. If provided, the key path will be **relative** to the</span>
<span class="sd">            parent key&#39;s path.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If none of ``reference``, ``serialized``, ``urlsafe``,</span>
<span class="sd">            ``pairs`` or ``flat`` is provided as an argument and no positional</span>
<span class="sd">            arguments were given with the path.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_key&quot;</span><span class="p">,</span> <span class="s2">&quot;_reference&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">path_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">_constructor_handle_positional</span><span class="p">(</span><span class="n">path_args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Key</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="c1"># Make sure to pass in the namespace if it&#39;s not explicitly set.</span>
        <span class="k">if</span> <span class="s2">&quot;namespace&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">context_module</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span><span class="o">.</span><span class="n">client</span>
            <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">namespace</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">namespace</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;reference&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span>
            <span class="ow">or</span> <span class="s2">&quot;serialized&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span>
            <span class="ow">or</span> <span class="s2">&quot;urlsafe&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span>
        <span class="p">):</span>
            <span class="n">ds_key</span><span class="p">,</span> <span class="n">reference</span> <span class="o">=</span> <span class="n">_parse_from_ref</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;pairs&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="s2">&quot;flat&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">ds_key</span> <span class="o">=</span> <span class="n">_parse_from_args</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Key() cannot create a Key instance without arguments.&quot;</span>
            <span class="p">)</span>

        <span class="n">instance</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">ds_key</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_reference</span> <span class="o">=</span> <span class="n">reference</span>
        <span class="k">return</span> <span class="n">instance</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_from_ds_key</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ds_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Factory constructor for a :class:`~google.cloud.datastore.key.Key`.</span>

<span class="sd">        This bypasses the actual constructor and directly sets the ``_key``</span>
<span class="sd">        attribute to ``ds_key``.</span>

<span class="sd">        Args:</span>
<span class="sd">            ds_key (~google.cloud.datastore.key.Key): A key from</span>
<span class="sd">                ``google-cloud-datastore``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Key: The constructed :class:`Key`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Key</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">key</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">ds_key</span>
        <span class="n">key</span><span class="o">.</span><span class="n">_reference</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">key</span>

<div class="viewcode-block" id="Key.__repr__"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.__repr__">[docs]</a>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation used by :class:`str() &lt;str&gt;` and :func:`repr`.</span>

<span class="sd">        We produce a short string that conveys all relevant information,</span>
<span class="sd">        suppressing app and namespace when they are equal to the default.</span>
<span class="sd">        In many cases, this string should be able to be used to invoke the</span>
<span class="sd">        constructor.</span>

<span class="sd">        For example:</span>

<span class="sd">        .. doctest:: key-repr</span>

<span class="sd">            &gt;&gt;&gt; key = ndb.Key(&quot;hi&quot;, 100)</span>
<span class="sd">            &gt;&gt;&gt; repr(key)</span>
<span class="sd">            &quot;Key(&#39;hi&#39;, 100)&quot;</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; key = ndb.Key(</span>
<span class="sd">            ...     &quot;bye&quot;, &quot;hundred&quot;, app=&quot;specific&quot;, namespace=&quot;space&quot;</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt; str(key)</span>
<span class="sd">            &quot;Key(&#39;bye&#39;, &#39;hundred&#39;, app=&#39;specific&#39;, namespace=&#39;space&#39;)&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat</span><span class="p">()]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">()</span> <span class="o">!=</span> <span class="n">_project_from_app</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;app=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">()))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;namespace=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">()))</span>

        <span class="k">return</span> <span class="s2">&quot;Key(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span></div>

<div class="viewcode-block" id="Key.__str__"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias for :meth:`__repr__`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span></div>

<div class="viewcode-block" id="Key.__hash__"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.__hash__">[docs]</a>    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hash value, for use in dictionary lookups.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This ignores ``app`` and ``namespace``. Since :func:`hash` isn&#39;t</span>
<span class="sd">            expected to return a unique value (it just reduces the chance of</span>
<span class="sd">            collision), this doesn&#39;t try to increase entropy by including other</span>
<span class="sd">            values. The primary concern is that hashes of equal keys are</span>
<span class="sd">            equal, not the other way around.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper to return an orderable tuple.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">())</span>

<div class="viewcode-block" id="Key.__eq__"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.__eq__">[docs]</a>    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Equality comparison operation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuple</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_tuple</span><span class="p">()</span></div>

<div class="viewcode-block" id="Key.__lt__"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.__lt__">[docs]</a>    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Less than ordering.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuple</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">_tuple</span><span class="p">()</span></div>

<div class="viewcode-block" id="Key.__le__"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.__le__">[docs]</a>    <span class="k">def</span> <span class="nf">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Less than or equal ordering.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuple</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">_tuple</span><span class="p">()</span></div>

<div class="viewcode-block" id="Key.__gt__"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.__gt__">[docs]</a>    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Greater than ordering.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">&lt;=</span> <span class="n">other</span></div>

<div class="viewcode-block" id="Key.__ge__"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.__ge__">[docs]</a>    <span class="k">def</span> <span class="nf">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Greater than or equal ordering.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">&lt;</span> <span class="n">other</span></div>

<div class="viewcode-block" id="Key.__getstate__"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.__getstate__">[docs]</a>    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private API used for pickling.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Dict[str, Any]]: A tuple containing a single dictionary of</span>
<span class="sd">            state to pickle. The dictionary has three keys ``pairs``, ``app``</span>
<span class="sd">            and ``namespace``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;pairs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">(),</span>
                <span class="s2">&quot;app&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(),</span>
                <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">(),</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Key.__setstate__"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.__setstate__">[docs]</a>    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private API used for unpickling.</span>

<span class="sd">        Args:</span>
<span class="sd">            state (Tuple[Dict[str, Any]]): A tuple containing a single</span>
<span class="sd">                dictionary of pickled state. This should match the signature</span>
<span class="sd">                returned from :func:`__getstate__`, in particular, it should</span>
<span class="sd">                have three keys ``pairs``, ``app`` and ``namespace``.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the ``state`` does not have length 1.</span>
<span class="sd">            TypeError: If the single element in ``state`` is not a dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid state length, expected 1; received </span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Key accepts a dict of keyword arguments as state; &quot;</span>
                <span class="s2">&quot;received </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">flat</span> <span class="o">=</span> <span class="n">_get_path</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pairs&quot;</span><span class="p">])</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">_project_from_app</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;app&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">_key_module</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span>
            <span class="o">*</span><span class="n">flat</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Key.__getnewargs__"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.__getnewargs__">[docs]</a>    <span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private API used to specify ``__new__`` arguments when unpickling.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This method is provided for backwards compatibility, though it</span>
<span class="sd">            isn&#39;t needed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Dict[str, Any]]: A tuple containing a single dictionary of</span>
<span class="sd">            state to pickle. The dictionary has three keys ``pairs``, ``app``</span>
<span class="sd">            and ``namespace``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;pairs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">(),</span>
                <span class="s2">&quot;app&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(),</span>
                <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">(),</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Key.parent"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.parent">[docs]</a>    <span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parent key constructed from all but the last ``(kind, id)`` pairs.</span>

<span class="sd">        If there is only one ``(kind, id)`` pair, return :data:`None`.</span>

<span class="sd">        .. doctest:: key-parent</span>

<span class="sd">            &gt;&gt;&gt; key = ndb.Key(</span>
<span class="sd">            ...     pairs=[</span>
<span class="sd">            ...         (&quot;Purchase&quot;, &quot;Food&quot;),</span>
<span class="sd">            ...         (&quot;Type&quot;, &quot;Drink&quot;),</span>
<span class="sd">            ...         (&quot;Coffee&quot;, 11),</span>
<span class="sd">            ...     ]</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt; parent = key.parent()</span>
<span class="sd">            &gt;&gt;&gt; parent</span>
<span class="sd">            Key(&#39;Purchase&#39;, &#39;Food&#39;, &#39;Type&#39;, &#39;Drink&#39;)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; grandparent = parent.parent()</span>
<span class="sd">            &gt;&gt;&gt; grandparent</span>
<span class="sd">            Key(&#39;Purchase&#39;, &#39;Food&#39;)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; grandparent.parent() is None</span>
<span class="sd">            True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">Key</span><span class="o">.</span><span class="n">_from_ds_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span></div>

<div class="viewcode-block" id="Key.root"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.root">[docs]</a>    <span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The root key.</span>

<span class="sd">        This is either the current key or the highest parent.</span>

<span class="sd">        .. doctest:: key-root</span>

<span class="sd">            &gt;&gt;&gt; key = ndb.Key(&quot;a&quot;, 1, &quot;steak&quot;, &quot;sauce&quot;)</span>
<span class="sd">            &gt;&gt;&gt; root_key = key.root()</span>
<span class="sd">            &gt;&gt;&gt; root_key</span>
<span class="sd">            Key(&#39;a&#39;, 1)</span>
<span class="sd">            &gt;&gt;&gt; root_key.root() is root_key</span>
<span class="sd">            True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">root_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span>
        <span class="k">while</span> <span class="n">root_key</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">root_key</span> <span class="o">=</span> <span class="n">root_key</span><span class="o">.</span><span class="n">parent</span>

        <span class="k">if</span> <span class="n">root_key</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">Key</span><span class="o">.</span><span class="n">_from_ds_key</span><span class="p">(</span><span class="n">root_key</span><span class="p">)</span></div>

<div class="viewcode-block" id="Key.namespace"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.namespace">[docs]</a>    <span class="k">def</span> <span class="nf">namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The namespace for the key, if set.</span>

<span class="sd">        .. doctest:: key-namespace</span>

<span class="sd">            &gt;&gt;&gt; key = ndb.Key(&quot;A&quot;, &quot;B&quot;)</span>
<span class="sd">            &gt;&gt;&gt; key.namespace() is None</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; key = ndb.Key(&quot;A&quot;, &quot;B&quot;, namespace=&quot;rock&quot;)</span>
<span class="sd">            &gt;&gt;&gt; key.namespace()</span>
<span class="sd">            &#39;rock&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">namespace</span></div>

<div class="viewcode-block" id="Key.app"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.app">[docs]</a>    <span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The project ID for the key.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            This **may** differ from the original ``app`` passed in to the</span>
<span class="sd">            constructor. This is because prefixed application IDs like</span>
<span class="sd">            ``s~example`` are &quot;legacy&quot; identifiers from Google App Engine.</span>
<span class="sd">            They have been replaced by equivalent project IDs, e.g. here it</span>
<span class="sd">            would be ``example``.</span>

<span class="sd">        .. doctest:: key-app</span>

<span class="sd">            &gt;&gt;&gt; key = ndb.Key(&quot;A&quot;, &quot;B&quot;, app=&quot;s~example&quot;)</span>
<span class="sd">            &gt;&gt;&gt; key.app()</span>
<span class="sd">            &#39;example&#39;</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; key = ndb.Key(&quot;A&quot;, &quot;B&quot;, app=&quot;example&quot;)</span>
<span class="sd">            &gt;&gt;&gt; key.app()</span>
<span class="sd">            &#39;example&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">project</span></div>

<div class="viewcode-block" id="Key.id"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.id">[docs]</a>    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The string or integer ID in the last ``(kind, id)`` pair, if any.</span>

<span class="sd">        .. doctest:: key-id</span>

<span class="sd">            &gt;&gt;&gt; key_int = ndb.Key(&quot;A&quot;, 37)</span>
<span class="sd">            &gt;&gt;&gt; key_int.id()</span>
<span class="sd">            37</span>
<span class="sd">            &gt;&gt;&gt; key_str = ndb.Key(&quot;A&quot;, &quot;B&quot;)</span>
<span class="sd">            &gt;&gt;&gt; key_str.id()</span>
<span class="sd">            &#39;B&#39;</span>
<span class="sd">            &gt;&gt;&gt; key_partial = ndb.Key(&quot;A&quot;, None)</span>
<span class="sd">            &gt;&gt;&gt; key_partial.id() is None</span>
<span class="sd">            True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">id_or_name</span></div>

<div class="viewcode-block" id="Key.string_id"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.string_id">[docs]</a>    <span class="k">def</span> <span class="nf">string_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The string ID in the last ``(kind, id)`` pair, if any.</span>

<span class="sd">        .. doctest:: key-string-id</span>

<span class="sd">            &gt;&gt;&gt; key_int = ndb.Key(&quot;A&quot;, 37)</span>
<span class="sd">            &gt;&gt;&gt; key_int.string_id() is None</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; key_str = ndb.Key(&quot;A&quot;, &quot;B&quot;)</span>
<span class="sd">            &gt;&gt;&gt; key_str.string_id()</span>
<span class="sd">            &#39;B&#39;</span>
<span class="sd">            &gt;&gt;&gt; key_partial = ndb.Key(&quot;A&quot;, None)</span>
<span class="sd">            &gt;&gt;&gt; key_partial.string_id() is None</span>
<span class="sd">            True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="Key.integer_id"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.integer_id">[docs]</a>    <span class="k">def</span> <span class="nf">integer_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The string ID in the last ``(kind, id)`` pair, if any.</span>

<span class="sd">        .. doctest:: key-integer-id</span>

<span class="sd">            &gt;&gt;&gt; key_int = ndb.Key(&quot;A&quot;, 37)</span>
<span class="sd">            &gt;&gt;&gt; key_int.integer_id()</span>
<span class="sd">            37</span>
<span class="sd">            &gt;&gt;&gt; key_str = ndb.Key(&quot;A&quot;, &quot;B&quot;)</span>
<span class="sd">            &gt;&gt;&gt; key_str.integer_id() is None</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; key_partial = ndb.Key(&quot;A&quot;, None)</span>
<span class="sd">            &gt;&gt;&gt; key_partial.integer_id() is None</span>
<span class="sd">            True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">id</span></div>

<div class="viewcode-block" id="Key.pairs"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.pairs">[docs]</a>    <span class="k">def</span> <span class="nf">pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The ``(kind, id)`` pairs for the key.</span>

<span class="sd">        .. doctest:: key-pairs</span>

<span class="sd">            &gt;&gt;&gt; key = ndb.Key(&quot;Satellite&quot;, &quot;Moon&quot;, &quot;Space&quot;, &quot;Dust&quot;)</span>
<span class="sd">            &gt;&gt;&gt; key.pairs()</span>
<span class="sd">            ((&#39;Satellite&#39;, &#39;Moon&#39;), (&#39;Space&#39;, &#39;Dust&#39;))</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; partial_key = ndb.Key(&quot;Known&quot;, None)</span>
<span class="sd">            &gt;&gt;&gt; partial_key.pairs()</span>
<span class="sd">            ((&#39;Known&#39;, None),)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat</span><span class="p">()</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flat</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Key.flat"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.flat">[docs]</a>    <span class="k">def</span> <span class="nf">flat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The flat path for the key.</span>

<span class="sd">        .. doctest:: key-flat</span>

<span class="sd">            &gt;&gt;&gt; key = ndb.Key(&quot;Satellite&quot;, &quot;Moon&quot;, &quot;Space&quot;, &quot;Dust&quot;)</span>
<span class="sd">            &gt;&gt;&gt; key.flat()</span>
<span class="sd">            (&#39;Satellite&#39;, &#39;Moon&#39;, &#39;Space&#39;, &#39;Dust&#39;)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; partial_key = ndb.Key(&quot;Known&quot;, None)</span>
<span class="sd">            &gt;&gt;&gt; partial_key.flat()</span>
<span class="sd">            (&#39;Known&#39;, None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flat_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">flat_path</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_path</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">flat_path</span> <span class="o">+=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,)</span>
        <span class="k">return</span> <span class="n">flat_path</span></div>

<div class="viewcode-block" id="Key.kind"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.kind">[docs]</a>    <span class="k">def</span> <span class="nf">kind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The kind of the entity referenced.</span>

<span class="sd">        This comes from the last ``(kind, id)`` pair.</span>

<span class="sd">        .. doctest:: key-kind</span>

<span class="sd">            &gt;&gt;&gt; key = ndb.Key(&quot;Satellite&quot;, &quot;Moon&quot;, &quot;Space&quot;, &quot;Dust&quot;)</span>
<span class="sd">            &gt;&gt;&gt; key.kind()</span>
<span class="sd">            &#39;Space&#39;</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; partial_key = ndb.Key(&quot;Known&quot;, None)</span>
<span class="sd">            &gt;&gt;&gt; partial_key.kind()</span>
<span class="sd">            &#39;Known&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">kind</span></div>

<div class="viewcode-block" id="Key.reference"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.reference">[docs]</a>    <span class="k">def</span> <span class="nf">reference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The ``Reference`` protobuf object for this key.</span>

<span class="sd">        The return value will be stored on the current key, so the caller</span>
<span class="sd">        promises not to mutate it.</span>

<span class="sd">        .. doctest:: key-reference</span>

<span class="sd">            &gt;&gt;&gt; key = ndb.Key(&quot;Trampoline&quot;, 88, app=&quot;xy&quot;, namespace=&quot;zt&quot;)</span>
<span class="sd">            &gt;&gt;&gt; key.reference()</span>
<span class="sd">            app: &quot;xy&quot;</span>
<span class="sd">            path {</span>
<span class="sd">              Element {</span>
<span class="sd">                type: &quot;Trampoline&quot;</span>
<span class="sd">                id: 88</span>
<span class="sd">              }</span>
<span class="sd">            }</span>
<span class="sd">            name_space: &quot;zt&quot;</span>
<span class="sd">            &lt;BLANKLINE&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reference</span> <span class="o">=</span> <span class="n">_app_engine_key_pb2</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span>
                <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="n">_to_legacy_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                <span class="n">name_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference</span></div>

<div class="viewcode-block" id="Key.serialized"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.serialized">[docs]</a>    <span class="k">def</span> <span class="nf">serialized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A ``Reference`` protobuf serialized to bytes.</span>

<span class="sd">        .. doctest:: key-serialized</span>

<span class="sd">            &gt;&gt;&gt; key = ndb.Key(&quot;Kind&quot;, 1337, app=&quot;example&quot;)</span>
<span class="sd">            &gt;&gt;&gt; key.serialized()</span>
<span class="sd">            b&#39;j\\x07exampler\\x0b\\x0b\\x12\\x04Kind\\x18\\xb9\\n\\x0c&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">reference</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span></div>

<div class="viewcode-block" id="Key.urlsafe"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.urlsafe">[docs]</a>    <span class="k">def</span> <span class="nf">urlsafe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A ``Reference`` protobuf encoded as urlsafe base 64.</span>

<span class="sd">        .. doctest:: key-urlsafe</span>

<span class="sd">            &gt;&gt;&gt; key = ndb.Key(&quot;Kind&quot;, 1337, app=&quot;example&quot;)</span>
<span class="sd">            &gt;&gt;&gt; key.urlsafe()</span>
<span class="sd">            b&#39;agdleGFtcGxlcgsLEgRLaW5kGLkKDA&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">raw_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialized</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">raw_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;=&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Key.get"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.get">[docs]</a>    <span class="nd">@_options</span><span class="o">.</span><span class="n">ReadOptions</span><span class="o">.</span><span class="n">options</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">read_consistency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">transaction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Synchronously get the entity for this key.</span>

<span class="sd">        Returns the retrieved :class:`.Model` or :data:`None` if there is no</span>
<span class="sd">        such entity.</span>

<span class="sd">        Args:</span>
<span class="sd">            read_consistency: Set this to ``ndb.EVENTUAL`` if, instead of</span>
<span class="sd">                waiting for the Datastore to finish applying changes to all</span>
<span class="sd">                returned results, you wish to get possibly-not-current results</span>
<span class="sd">                faster. You can&#39;t do this if using a transaction.</span>
<span class="sd">            transaction (bytes): Any results returned will be consistent with</span>
<span class="sd">                the Datastore state represented by this transaction id.</span>
<span class="sd">                Defaults to the currently running transaction. Cannot be used</span>
<span class="sd">                with ``read_consistency=ndb.EVENTUAL``.</span>
<span class="sd">            retries (int): Number of times to retry this operation in the case</span>
<span class="sd">                of transient server errors. Operation will potentially be tried</span>
<span class="sd">                up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">                once, with no retries.</span>
<span class="sd">            timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            force_writes (bool): Specifies whether a write request should</span>
<span class="sd">                succeed even if the app is read-only. (This only applies to</span>
<span class="sd">                user controlled read-only periods.)</span>
<span class="sd">            use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">                cache; overrides in-process cache policy for this operation.</span>
<span class="sd">            use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">                memcache; overrides memcache policy for this operation.</span>
<span class="sd">            use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">                Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">            memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">                overrides memcache timeout policy for this operation.</span>
<span class="sd">            max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">                feature of the Context memcache methods. For example, with the</span>
<span class="sd">                default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">                set operations will be combined into a single set_multi</span>
<span class="sd">                operation.</span>
<span class="sd">            read_policy: DEPRECATED: Synonym for ``read_consistency``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[:class:`.Model`, :data:`None`]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_async</span><span class="p">(</span><span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span></div>

<div class="viewcode-block" id="Key.get_async"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.get_async">[docs]</a>    <span class="nd">@_options</span><span class="o">.</span><span class="n">ReadOptions</span><span class="o">.</span><span class="n">options</span>
    <span class="k">def</span> <span class="nf">get_async</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">read_consistency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">transaction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Asynchronously get the entity for this key.</span>

<span class="sd">        The result for the returned future will either be the retrieved</span>
<span class="sd">        :class:`.Model` or :data:`None` if there is no such entity.</span>

<span class="sd">        Args:</span>
<span class="sd">            read_consistency: Set this to ``ndb.EVENTUAL`` if, instead of</span>
<span class="sd">                waiting for the Datastore to finish applying changes to all</span>
<span class="sd">                returned results, you wish to get possibly-not-current results</span>
<span class="sd">                faster. You can&#39;t do this if using a transaction.</span>
<span class="sd">            transaction (bytes): Any results returned will be consistent with</span>
<span class="sd">                the Datastore state represented by this transaction id.</span>
<span class="sd">                Defaults to the currently running transaction. Cannot be used</span>
<span class="sd">                with ``read_consistency=ndb.EVENTUAL``.</span>
<span class="sd">            retries (int): Number of times to retry this operation in the case</span>
<span class="sd">                of transient server errors. Operation will potentially be tried</span>
<span class="sd">                up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">                once, with no retries.</span>
<span class="sd">            timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            force_writes (bool): Specifies whether a write request should</span>
<span class="sd">                succeed even if the app is read-only. (This only applies to</span>
<span class="sd">                user controlled read-only periods.)</span>
<span class="sd">            use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">                cache; overrides in-process cache policy for this operation.</span>
<span class="sd">            use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">                memcache; overrides memcache policy for this operation.</span>
<span class="sd">            use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">                Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">            memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">                overrides memcache timeout policy for this operation.</span>
<span class="sd">            max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">                feature of the Context memcache methods. For example, with the</span>
<span class="sd">                default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">                set operations will be combined into a single set_multi</span>
<span class="sd">                operation.</span>
<span class="sd">            read_policy: DEPRECATED: Synonym for ``read_consistency``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`~google.cloud.ndb.tasklets.Future`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">model</span>  <span class="c1"># avoid circular import</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">_kind_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_pre_get_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="nd">@tasklets</span><span class="o">.</span><span class="n">tasklet</span>
        <span class="k">def</span> <span class="nf">get</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">_options</span><span class="o">.</span><span class="n">use_cache</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># This result may be None, if None is cached for this key.</span>
                    <span class="k">return</span> <span class="n">context_module</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_and_validate</span><span class="p">(</span>
                        <span class="bp">self</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">entity_pb</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">_datastore_api</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="n">_options</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entity_pb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_datastore_api</span><span class="o">.</span><span class="n">_NOT_FOUND</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_entity_from_protobuf</span><span class="p">(</span><span class="n">entity_pb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">_options</span><span class="o">.</span><span class="n">use_cache</span><span class="p">:</span>
                <span class="n">context_module</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="n">future</span> <span class="o">=</span> <span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="p">:</span>
            <span class="n">future</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span>
                <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_post_get_hook</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">future</span></div>

<div class="viewcode-block" id="Key.delete"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.delete">[docs]</a>    <span class="nd">@_options</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">options</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Synchronously delete the entity for this key.</span>

<span class="sd">        This is a no-op if no such entity exists.</span>

<span class="sd">        Note:</span>
<span class="sd">            If in a transaction, the entity can only be deleted at transaction</span>
<span class="sd">            commit time. In that case, this function will schedule the entity</span>
<span class="sd">            to be deleted as part of the transaction and will return</span>
<span class="sd">            immediately, which is effectively the same as calling</span>
<span class="sd">            :meth:`delete_async` and ignoring the returned future. If not in a</span>
<span class="sd">            transaction, this function will block synchronously until the</span>
<span class="sd">            entity is deleted, as one would expect.</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            force_writes (bool): Specifies whether a write request should</span>
<span class="sd">                succeed even if the app is read-only. (This only applies to</span>
<span class="sd">                user controlled read-only periods.)</span>
<span class="sd">            use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">                cache; overrides in-process cache policy for this operation.</span>
<span class="sd">            use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">                memcache; overrides memcache policy for this operation.</span>
<span class="sd">            use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">                Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">            memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">                overrides memcache timeout policy for this operation.</span>
<span class="sd">            max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">                feature of the Context memcache methods. For example, with the</span>
<span class="sd">                default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">                set operations will be combined into a single set_multi</span>
<span class="sd">                operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_async</span><span class="p">(</span><span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_transaction</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span></div>

<div class="viewcode-block" id="Key.delete_async"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.delete_async">[docs]</a>    <span class="nd">@_options</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">options</span>
    <span class="k">def</span> <span class="nf">delete_async</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Schedule deletion of the entity for this key.</span>

<span class="sd">        The result of the returned future becomes available once the</span>
<span class="sd">        deletion is complete. In all cases the future&#39;s result is :data:`None`</span>
<span class="sd">        (i.e. there is no way to tell whether the entity existed or not).</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            force_writes (bool): Specifies whether a write request should</span>
<span class="sd">                succeed even if the app is read-only. (This only applies to</span>
<span class="sd">                user controlled read-only periods.)</span>
<span class="sd">            use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">                cache; overrides in-process cache policy for this operation.</span>
<span class="sd">            use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">                memcache; overrides memcache policy for this operation.</span>
<span class="sd">            use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">                Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">            memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">                overrides memcache timeout policy for this operation.</span>
<span class="sd">            max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">                feature of the Context memcache methods. For example, with the</span>
<span class="sd">                default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">                set operations will be combined into a single set_multi</span>
<span class="sd">                operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">model</span>  <span class="c1"># avoid circular import</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">_kind_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_pre_delete_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="nd">@tasklets</span><span class="o">.</span><span class="n">tasklet</span>
        <span class="k">def</span> <span class="nf">delete</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">_datastore_api</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="n">_options</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_options</span><span class="o">.</span><span class="n">use_cache</span><span class="p">:</span>
                <span class="n">context_module</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">future</span> <span class="o">=</span> <span class="n">delete</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="p">:</span>
            <span class="n">future</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span>
                <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_post_delete_hook</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">future</span></div>

<div class="viewcode-block" id="Key.from_old_key"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.from_old_key">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_old_key</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">old_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Factory constructor to convert from an &quot;old&quot;-style datastore key.</span>

<span class="sd">        The ``old_key`` was expected to be a ``google.appengine.ext.db.Key``</span>
<span class="sd">        (which was an alias for ``google.appengine.api.datastore_types.Key``).</span>

<span class="sd">        However, the ``google.appengine.ext.db`` module was part of the legacy</span>
<span class="sd">        Google App Engine runtime and is not generally available.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">_NO_LEGACY</span><span class="p">)</span></div>

<div class="viewcode-block" id="Key.to_old_key"><a class="viewcode-back" href="../../../../key.html#google.cloud.ndb.key.Key.to_old_key">[docs]</a>    <span class="k">def</span> <span class="nf">to_old_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert to an &quot;old&quot;-style datastore key.</span>

<span class="sd">        See :meth:`from_old_key` for more information on why this method</span>
<span class="sd">        is not supported.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">_NO_LEGACY</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_project_from_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a legacy Google App Engine app string to a project.</span>

<span class="sd">    Args:</span>
<span class="sd">        app (str): The application value to be used. If the caller passes</span>
<span class="sd">            :data:`None` and ``allow_empty`` is :data:`False`, then this will</span>
<span class="sd">            use the project set by the current client context. (See</span>
<span class="sd">            :meth:`~client.Client.context`.)</span>
<span class="sd">        allow_empty (bool): Flag determining if an empty (i.e. :data:`None`)</span>
<span class="sd">            project is allowed. Defaults to :data:`False`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The cleaned project.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">allow_empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">context_module</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span><span class="o">.</span><span class="n">client</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">project</span>

    <span class="c1"># NOTE: This is the same behavior as in the helper</span>
    <span class="c1">#       ``google.cloud.datastore.key._clean_app()``.</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_from_reference</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert Reference protobuf to :class:`~google.cloud.datastore.key.Key`.</span>

<span class="sd">    This is intended to work with the &quot;legacy&quot; representation of a</span>
<span class="sd">    datastore &quot;Key&quot; used within Google App Engine (a so-called</span>
<span class="sd">    &quot;Reference&quot;). This assumes that ``serialized`` was created within an App</span>
<span class="sd">    Engine app via something like ``ndb.Key(...).reference()``.</span>

<span class="sd">    However, the actual type used here is different since this code will not</span>
<span class="sd">    run in the App Engine standard environment where the type was</span>
<span class="sd">    ``google.appengine.datastore.entity_pb.Reference``.</span>

<span class="sd">    Args:</span>
<span class="sd">        serialized (bytes): A reference protobuf serialized to bytes.</span>
<span class="sd">        app (Optional[str]): The application ID / project ID for the</span>
<span class="sd">            constructed key.</span>
<span class="sd">        namespace (Optional[str]): The namespace for the constructed key.</span>

<span class="sd">    Returns:</span>
<span class="sd">        google.cloud.datastore.key.Key: The key corresponding to</span>
<span class="sd">        ``serialized``.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If ``app`` is not :data:`None`, but not the same as</span>
<span class="sd">            ``reference.app``.</span>
<span class="sd">        RuntimeError: If ``namespace`` is not :data:`None`, but not the same as</span>
<span class="sd">            ``reference.name_space``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">_project_from_app</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_project_from_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span> <span class="o">!=</span> <span class="n">project</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="n">_REFERENCE_APP_MISMATCH</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">parsed_namespace</span> <span class="o">=</span> <span class="n">_key_module</span><span class="o">.</span><span class="n">_get_empty</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">name_space</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">namespace</span> <span class="o">!=</span> <span class="n">parsed_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="n">_REFERENCE_NAMESPACE_MISMATCH</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">reference</span><span class="o">.</span><span class="n">name_space</span><span class="p">,</span> <span class="n">namespace</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="n">_key_module</span><span class="o">.</span><span class="n">_check_database_id</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">database_id</span><span class="p">)</span>
    <span class="n">flat_path</span> <span class="o">=</span> <span class="n">_key_module</span><span class="o">.</span><span class="n">_get_flat_path</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">google</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">datastore</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span>
        <span class="o">*</span><span class="n">flat_path</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">parsed_namespace</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_from_serialized</span><span class="p">(</span><span class="n">serialized</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert serialized protobuf to :class:`~google.cloud.datastore.key.Key`.</span>

<span class="sd">    This is intended to work with the &quot;legacy&quot; representation of a</span>
<span class="sd">    datastore &quot;Key&quot; used within Google App Engine (a so-called</span>
<span class="sd">    &quot;Reference&quot;). This assumes that ``serialized`` was created within an App</span>
<span class="sd">    Engine app via something like ``ndb.Key(...).serialized()``.</span>

<span class="sd">    Args:</span>
<span class="sd">        serialized (bytes): A reference protobuf serialized to bytes.</span>
<span class="sd">        app (Optional[str]): The application ID / project ID for the</span>
<span class="sd">            constructed key.</span>
<span class="sd">        namespace (Optional[str]): The namespace for the constructed key.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[google.cloud.datastore.key.Key, .Reference]: The key</span>
<span class="sd">        corresponding to ``serialized`` and the Reference protobuf.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">_app_engine_key_pb2</span><span class="o">.</span><span class="n">Reference</span><span class="p">()</span>
    <span class="n">reference</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">serialized</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_from_reference</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">namespace</span><span class="p">),</span> <span class="n">reference</span>


<span class="k">def</span> <span class="nf">_from_urlsafe</span><span class="p">(</span><span class="n">urlsafe</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert urlsafe string to :class:`~google.cloud.datastore.key.Key`.</span>

<span class="sd">    .. note::</span>

<span class="sd">       This is borrowed from</span>
<span class="sd">       :meth:`~google.cloud.datastore.key.Key.from_legacy_urlsafe`.</span>
<span class="sd">       It is provided here, rather than calling that method, since component</span>
<span class="sd">       parts need to be re-used.</span>

<span class="sd">    This is intended to work with the &quot;legacy&quot; representation of a</span>
<span class="sd">    datastore &quot;Key&quot; used within Google App Engine (a so-called</span>
<span class="sd">    &quot;Reference&quot;). This assumes that ``urlsafe`` was created within an App</span>
<span class="sd">    Engine app via something like ``ndb.Key(...).urlsafe()``.</span>

<span class="sd">    Args:</span>
<span class="sd">        urlsafe (Union[bytes, str]): The base64 encoded (ASCII) string</span>
<span class="sd">            corresponding to a datastore &quot;Key&quot; / &quot;Reference&quot;.</span>
<span class="sd">        app (Optional[str]): The application ID / project ID for the</span>
<span class="sd">            constructed key.</span>
<span class="sd">        namespace (Optional[str]): The namespace for the constructed key.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[google.cloud.datastore.key.Key, .Reference]: The key</span>
<span class="sd">        corresponding to ``urlsafe`` and the Reference protobuf.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">urlsafe</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">urlsafe</span> <span class="o">=</span> <span class="n">urlsafe</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">urlsafe</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">urlsafe</span> <span class="o">+=</span> <span class="n">padding</span>
    <span class="n">raw_bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">urlsafe</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_from_serialized</span><span class="p">(</span><span class="n">raw_bytes</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_constructor_handle_positional</span><span class="p">(</span><span class="n">path_args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Properly handle positional arguments to Key constructor.</span>

<span class="sd">    This will modify ``kwargs`` in a few cases:</span>

<span class="sd">    * The constructor was called with a dictionary as the only</span>
<span class="sd">      positional argument (and no keyword arguments were passed). In</span>
<span class="sd">      this case, the contents of the dictionary passed in will be copied</span>
<span class="sd">      into ``kwargs``.</span>
<span class="sd">    * The constructor was called with at least one (non-dictionary)</span>
<span class="sd">      positional argument. In this case all of the positional arguments</span>
<span class="sd">      will be added to ``kwargs`` for the key ``flat``.</span>

<span class="sd">    Args:</span>
<span class="sd">        path_args (Tuple): The positional arguments.</span>
<span class="sd">        kwargs (Dict[str, Any]): The keyword arguments.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If keyword arguments were used while the first and</span>
<span class="sd">            only positional argument was a dictionary.</span>
<span class="sd">        TypeError: If positional arguments were provided and the keyword</span>
<span class="sd">            ``flat`` was used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path_args</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Key() takes no keyword arguments when a dict is the &quot;</span>
                <span class="s2">&quot;the first and only non-keyword argument (for &quot;</span>
                <span class="s2">&quot;unpickling).&quot;</span>
            <span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">path_args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;flat&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Key() with positional arguments &quot;</span>
                <span class="s2">&quot;cannot accept flat as a keyword argument.&quot;</span>
            <span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;flat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_args</span>


<span class="k">def</span> <span class="nf">_exactly_one_specified</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make sure exactly one of ``values`` is truthy.</span>

<span class="sd">    Args:</span>
<span class="sd">        values (Tuple[Any, ...]): Some values to be checked.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: Indicating if exactly one of ``values`` was truthy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">if</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">_parse_from_ref</span><span class="p">(</span>
    <span class="n">klass</span><span class="p">,</span>
    <span class="n">reference</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">serialized</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">urlsafe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a key from a Reference.</span>

<span class="sd">    This makes sure that **exactly** one of ``reference``, ``serialized`` and</span>
<span class="sd">    ``urlsafe`` is specified (all three are different representations of a</span>
<span class="sd">    ``Reference`` protobuf).</span>

<span class="sd">    Args:</span>
<span class="sd">        klass (type): The class of the instance being constructed. It must</span>
<span class="sd">            be :class:`.Key`; we do not allow constructing :class:`.Key`</span>
<span class="sd">            subclasses from a serialized Reference protobuf.</span>
<span class="sd">        reference (Optional[\</span>
<span class="sd">            ~google.cloud.datastore._app_engine_key_pb2.Reference]): A</span>
<span class="sd">            reference protobuf representing a key.</span>
<span class="sd">        serialized (Optional[bytes]): A reference protobuf serialized to bytes.</span>
<span class="sd">        urlsafe (Optional[str]): A reference protobuf serialized to bytes. The</span>
<span class="sd">            raw bytes are then converted to a websafe base64-encoded string.</span>
<span class="sd">        app (Optional[str]): The Google Cloud Platform project (previously</span>
<span class="sd">            on Google App Engine, this was called the Application ID).</span>
<span class="sd">        namespace (Optional[str]): The namespace for the key.</span>
<span class="sd">        kwargs (Dict[str, Any]): Any extra keyword arguments not covered by</span>
<span class="sd">            the explicitly provided ones. These are passed through to indicate</span>
<span class="sd">            to the user that the wrong combination of arguments was used, e.g.</span>
<span class="sd">            if ``parent`` and ``urlsafe`` were used together.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[~.datastore.Key, \</span>
<span class="sd">            ~google.cloud.datastore._app_engine_key_pb2.Reference]:</span>
<span class="sd">        A pair of the constructed key and the reference that was serialized</span>
<span class="sd">        in one of the arguments.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If ``klass`` is not :class:`.Key`.</span>
<span class="sd">        TypeError: If ``kwargs`` isn&#39;t empty.</span>
<span class="sd">        TypeError: If any number other than exactly one of ``reference``,</span>
<span class="sd">            ``serialized`` or ``urlsafe`` is provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">klass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Key</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">_WRONG_TYPE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">klass</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">_exactly_one_specified</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">serialized</span><span class="p">,</span> <span class="n">urlsafe</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot construct Key reference from incompatible &quot;</span>
            <span class="s2">&quot;keyword arguments.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">reference</span><span class="p">:</span>
        <span class="n">ds_key</span> <span class="o">=</span> <span class="n">_from_reference</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">serialized</span><span class="p">:</span>
        <span class="n">ds_key</span><span class="p">,</span> <span class="n">reference</span> <span class="o">=</span> <span class="n">_from_serialized</span><span class="p">(</span><span class="n">serialized</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># NOTE: We know here that ``urlsafe`` is truth-y;</span>
        <span class="c1">#       ``_exactly_one_specified()`` guarantees this.</span>
        <span class="n">ds_key</span><span class="p">,</span> <span class="n">reference</span> <span class="o">=</span> <span class="n">_from_urlsafe</span><span class="p">(</span><span class="n">urlsafe</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds_key</span><span class="p">,</span> <span class="n">reference</span>


<span class="k">def</span> <span class="nf">_parse_from_args</span><span class="p">(</span>
    <span class="n">pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a key the path (and possibly a parent key).</span>

<span class="sd">    Args:</span>
<span class="sd">        pairs (Optional[Iterable[Tuple[str, Union[str, int]]]]): An iterable</span>
<span class="sd">            of (kind, ID) pairs.</span>
<span class="sd">        flat (Optional[Iterable[Union[str, int]]]): An iterable of the</span>
<span class="sd">            (kind, ID) pairs but flattened into a single value. For example,</span>
<span class="sd">            the pairs ``[(&quot;Parent&quot;, 1), (&quot;Child&quot;, &quot;a&quot;)]`` would be flattened to</span>
<span class="sd">            ``[&quot;Parent&quot;, 1, &quot;Child&quot;, &quot;a&quot;]``.</span>
<span class="sd">        app (Optional[str]): The Google Cloud Platform project (previously</span>
<span class="sd">            on Google App Engine, this was called the Application ID).</span>
<span class="sd">        namespace (Optional[str]): The namespace for the key.</span>
<span class="sd">        parent (Optional[~.ndb.key.Key]): The parent of the key being</span>
<span class="sd">            constructed. If provided, the key path will be **relative** to the</span>
<span class="sd">            parent key&#39;s path.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ~.datastore.Key: The constructed key.</span>

<span class="sd">    Raises:</span>
<span class="sd">        .BadValueError: If ``parent`` is passed but is not a ``Key``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flat</span> <span class="o">=</span> <span class="n">_get_path</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">pairs</span><span class="p">)</span>
    <span class="n">_clean_flat_path</span><span class="p">(</span><span class="n">flat</span><span class="p">)</span>

    <span class="n">parent_ds_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">_project_from_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">_project_from_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected Key instance, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># Offload verification of parent to ``google.cloud.datastore.Key()``.</span>
        <span class="n">parent_ds_key</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_key</span>

    <span class="k">return</span> <span class="n">google</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">datastore</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span>
        <span class="o">*</span><span class="n">flat</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent_ds_key</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_path</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">pairs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a flat path of key arguments.</span>

<span class="sd">    Does this from exactly one of ``flat`` or ``pairs``.</span>

<span class="sd">    Args:</span>
<span class="sd">        pairs (Optional[Iterable[Tuple[str, Union[str, int]]]]): An iterable</span>
<span class="sd">            of (kind, ID) pairs.</span>
<span class="sd">        flat (Optional[Iterable[Union[str, int]]]): An iterable of the</span>
<span class="sd">            (kind, ID) pairs but flattened into a single value. For example,</span>
<span class="sd">            the pairs ``[(&quot;Parent&quot;, 1), (&quot;Child&quot;, &quot;a&quot;)]`` would be flattened to</span>
<span class="sd">            ``[&quot;Parent&quot;, 1, &quot;Child&quot;, &quot;a&quot;]``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[Union[str, int]]: The flattened path as a list.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If both ``flat`` and ``pairs`` are provided.</span>
<span class="sd">        ValueError: If the ``flat`` path does not have an even number of</span>
<span class="sd">            elements.</span>
<span class="sd">        TypeError: If the paths are both empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">flat</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pairs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Key() cannot accept both flat and pairs arguments.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Key() must have an even number of positional arguments.&quot;</span>
            <span class="p">)</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">kind</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="n">flat</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">kind</span><span class="p">,</span> <span class="n">id_</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">flat</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Key must consist of at least one pair.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">flat</span>


<span class="k">def</span> <span class="nf">_clean_flat_path</span><span class="p">(</span><span class="n">flat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify and convert the flat path for a key.</span>

<span class="sd">    This may modify ``flat`` in place. In particular, if the last element is</span>
<span class="sd">    :data:`None` (for a partial key), this will pop it off the end. Also</span>
<span class="sd">    if some of the kinds are instance of :class:`.Model`, they will be</span>
<span class="sd">    converted to strings in ``flat``.</span>

<span class="sd">    Args:</span>
<span class="sd">        flat (List[Union[str, int]]): The flattened path as a list.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the kind in a pair is an invalid type.</span>
<span class="sd">        .BadArgumentError: If a key ID is :data:`None` (indicating a partial</span>
<span class="sd">           key), but in a pair other than the last one.</span>
<span class="sd">        TypeError: If a key ID is not a string or integer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verify the inputs in ``flat``.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
        <span class="c1"># Make sure the ``kind`` is either a string or a Model.</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">flat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">()</span>
            <span class="n">flat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Key kind must be a string or Model class; &quot;</span>
                <span class="s2">&quot;received </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># Make sure the ``id_`` is either a string or int. In the special case</span>
        <span class="c1"># of a partial key, ``id_`` can be ``None`` for the last pair.</span>
        <span class="n">id_</span> <span class="o">=</span> <span class="n">flat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">id_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
                    <span class="s2">&quot;Incomplete Key entry must be last&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">_INVALID_ID_TYPE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_</span><span class="p">))</span>

    <span class="c1"># Remove trailing ``None`` for a partial key.</span>
    <span class="k">if</span> <span class="n">flat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flat</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_verify_path_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">is_str</span><span class="p">,</span> <span class="n">is_kind</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify a key path value: one of a kind, string ID or integer ID.</span>

<span class="sd">    Args:</span>
<span class="sd">        value (Union[str, int]): The value to verify</span>
<span class="sd">        is_str (bool): Flag indicating if the ``value`` is a string. If</span>
<span class="sd">            :data:`False`, then the ``value`` is assumed to be an integer.</span>
<span class="sd">        is_kind (Optional[bool]): Flag indicating if the value is meant to</span>
<span class="sd">            be a kind. Defaults to :data:`False`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[str, int]: The ``value`` passed in, if it passed verification</span>
<span class="sd">        checks.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the ``value`` is a ``str`` for the kind, but the number</span>
<span class="sd">            of UTF-8 encoded bytes is outside of the range ``[1, 1500]``.</span>
<span class="sd">        ValueError: If the ``value`` is a ``str`` for the name, but the number</span>
<span class="sd">            of UTF-8 encoded bytes is outside of the range ``[1, 1500]``.</span>
<span class="sd">        ValueError: If the ``value`` is an integer but lies outside of the</span>
<span class="sd">            range ``[1, 2^63 - 1]``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_str</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">_MAX_KEYPART_BYTES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">is_kind</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_BAD_KIND</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_MAX_KEYPART_BYTES</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_BAD_STRING_ID</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_MAX_KEYPART_BYTES</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">_MAX_INTEGER_ID</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_BAD_INTEGER_ID</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_to_legacy_path</span><span class="p">(</span><span class="n">dict_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a tuple of ints and strings in a legacy &quot;Path&quot;.</span>

<span class="sd">    .. note:</span>

<span class="sd">        This assumes, but does not verify, that each entry in</span>
<span class="sd">        ``dict_path`` is valid (i.e. doesn&#39;t have more than one</span>
<span class="sd">        key out of &quot;name&quot; / &quot;id&quot;).</span>

<span class="sd">    Args:</span>
<span class="sd">        dict_path (Iterable[Tuple[str, Union[str, int]]]): The &quot;structured&quot;</span>
<span class="sd">            path for a ``google-cloud-datastore`` key, i.e. it is a list of</span>
<span class="sd">            dictionaries, each of which has &quot;kind&quot; and one of &quot;name&quot; / &quot;id&quot; as</span>
<span class="sd">            keys.</span>

<span class="sd">    Returns:</span>
<span class="sd">        _app_engine_key_pb2.Path: The legacy path corresponding to</span>
<span class="sd">        ``dict_path``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">dict_path</span><span class="p">:</span>
        <span class="n">element_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">_verify_path_value</span><span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">],</span> <span class="kc">True</span><span class="p">,</span> <span class="n">is_kind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
            <span class="n">element_kwargs</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_verify_path_value</span><span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
            <span class="n">element_kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_verify_path_value</span><span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">_app_engine_key_pb2</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="o">**</span><span class="n">element_kwargs</span><span class="p">)</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_app_engine_key_pb2</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">element</span><span class="o">=</span><span class="n">elements</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">ndb</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../key.html">Key</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../model.html">Model and Property</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../query.html">Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tasklets.html">Tasklets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../exceptions.html">Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../polymodel.html">Polymorphic Models and Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../django-middleware.html">Django Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../msgprop.html">ProtoRPC Message Properties</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../blobstore.html">Blobstore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../metadata.html">Datastore Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../stats.html">Datastore Statistics</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Google.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>