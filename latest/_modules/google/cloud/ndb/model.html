
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>google.cloud.ndb.model &#8212; ndb 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for google.cloud.ndb.model</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2018 Google LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Model classes for datastore objects and properties for models.</span>

<span class="sd">.. testsetup:: *</span>

<span class="sd">    from unittest import mock</span>
<span class="sd">    from google.cloud import ndb</span>
<span class="sd">    from google.cloud.ndb import context as context_module</span>

<span class="sd">    client = mock.Mock(project=&quot;testing&quot;, spec=(&quot;project&quot;,), namespace=&quot;&quot;)</span>
<span class="sd">    context = context_module.Context(client, stub=mock.Mock(spec=())).use()</span>
<span class="sd">    context.__enter__()</span>

<span class="sd">.. testcleanup:: *</span>

<span class="sd">    context.__exit__(None, None, None)</span>

<span class="sd">A model class represents the structure of entities stored in the datastore.</span>
<span class="sd">Applications define model classes to indicate the structure of their entities,</span>
<span class="sd">then instantiate those model classes to create entities.</span>

<span class="sd">All model classes must inherit (directly or indirectly) from Model. Through</span>
<span class="sd">the magic of metaclasses, straightforward assignments in the model class</span>
<span class="sd">definition can be used to declare the model&#39;s structure::</span>

<span class="sd">    class Person(Model):</span>
<span class="sd">        name = StringProperty()</span>
<span class="sd">        age = IntegerProperty()</span>

<span class="sd">We can now create a Person entity and write it to Cloud Datastore::</span>

<span class="sd">    person = Person(name=&#39;Arthur Dent&#39;, age=42)</span>
<span class="sd">    key = person.put()</span>

<span class="sd">The return value from put() is a Key (see the documentation for ndb/key.py),</span>
<span class="sd">which can be used to retrieve the same entity later::</span>

<span class="sd">    person2 = key.get()</span>
<span class="sd">    person2 == person  # Returns True</span>

<span class="sd">To update an entity, simply change its attributes and write it back (note that</span>
<span class="sd">this doesn&#39;t change the key)::</span>

<span class="sd">    person2.name = &#39;Arthur Philip Dent&#39;</span>
<span class="sd">    person2.put()</span>

<span class="sd">We can also delete an entity (by using the key)::</span>

<span class="sd">    key.delete()</span>

<span class="sd">The property definitions in the class body tell the system the names and the</span>
<span class="sd">types of the fields to be stored in Cloud Datastore, whether they must be</span>
<span class="sd">indexed, their default value, and more.</span>

<span class="sd">Many different Property types exist.  Most are indexed by default, the</span>
<span class="sd">exceptions are indicated in the list below:</span>

<span class="sd">- :class:`StringProperty`: a short text string, limited to at most 1500 bytes (when</span>
<span class="sd">  UTF-8 encoded from :class:`str` to bytes).</span>
<span class="sd">- :class:`TextProperty`: an unlimited text string; unindexed.</span>
<span class="sd">- :class:`BlobProperty`: an unlimited byte string; unindexed.</span>
<span class="sd">- :class:`IntegerProperty`: a 64-bit signed integer.</span>
<span class="sd">- :class:`FloatProperty`: a double precision floating point number.</span>
<span class="sd">- :class:`BooleanProperty`: a bool value.</span>
<span class="sd">- :class:`DateTimeProperty`: a datetime object.  Note: Datastore always uses UTC as the</span>
<span class="sd">  timezone.</span>
<span class="sd">- :class:`DateProperty`: a date object.</span>
<span class="sd">- :class:`TimeProperty`: a time object.</span>
<span class="sd">- :class:`GeoPtProperty`: a geographical location, i.e. (latitude, longitude).</span>
<span class="sd">- :class:`KeyProperty`: a Cloud Datastore Key value, optionally constrained to referring</span>
<span class="sd">  to a specific kind.</span>
<span class="sd">- :class:`UserProperty`: a User object (for backwards compatibility only)</span>
<span class="sd">- :class:`StructuredProperty`: a field that is itself structured like an entity; see</span>
<span class="sd">  below for more details.</span>
<span class="sd">- :class:`LocalStructuredProperty`: like StructuredProperty but the on-disk</span>
<span class="sd">  representation is an opaque blob; unindexed.</span>
<span class="sd">- :class:`ComputedProperty`: a property whose value is computed from other properties by</span>
<span class="sd">  a user-defined function.  The property value is written to Cloud Datastore so</span>
<span class="sd">  that it can be used in queries, but the value from Cloud Datastore is not</span>
<span class="sd">  used when the entity is read back.</span>
<span class="sd">- :class:`GenericProperty`: a property whose type is not constrained; mostly used by the</span>
<span class="sd">  Expando class (see below) but also usable explicitly.</span>
<span class="sd">- :class:`JsonProperty`: a property whose value is any object that can be serialized</span>
<span class="sd">  using JSON; the value written to Cloud Datastore is a JSON representation of</span>
<span class="sd">  that object.</span>
<span class="sd">- :class:`PickleProperty`: a property whose value is any object that can be serialized</span>
<span class="sd">  using Python&#39;s pickle protocol; the value written to the Cloud Datastore is</span>
<span class="sd">  the pickled representation of that object, using the highest available pickle</span>
<span class="sd">  protocol</span>

<span class="sd">Most Property classes have similar constructor signatures.  They</span>
<span class="sd">accept several optional keyword arguments:</span>

<span class="sd">- name=&lt;string&gt;: the name used to store the property value in the datastore.</span>
<span class="sd">  Unlike the following options, this may also be given as a positional</span>
<span class="sd">  argument.</span>
<span class="sd">- indexed=&lt;bool&gt;: indicates whether the property should be indexed (allowing</span>
<span class="sd">  queries on this property&#39;s value).</span>
<span class="sd">- repeated=&lt;bool&gt;: indicates that this property can have multiple values in</span>
<span class="sd">  the same entity.</span>
<span class="sd">- write_empty_list&lt;bool&gt;: For repeated value properties, controls whether</span>
<span class="sd">  properties with no elements (the empty list) is written to Datastore. If</span>
<span class="sd">  true, written, if false, then nothing is written to Datastore.</span>
<span class="sd">- required=&lt;bool&gt;: indicates that this property must be given a value.</span>
<span class="sd">- default=&lt;value&gt;: a default value if no explicit value is given.</span>
<span class="sd">- choices=&lt;list of values&gt;: a list or tuple of allowable values.</span>
<span class="sd">- validator=&lt;function&gt;: a general-purpose validation function. It will be</span>
<span class="sd">  called with two arguments (prop, value) and should either return the</span>
<span class="sd">  validated value or raise an exception. It is also allowed for the function</span>
<span class="sd">  to modify the value, but the function should be idempotent. For example: a</span>
<span class="sd">  validator that returns value.strip() or value.lower() is fine, but one that</span>
<span class="sd">  returns value + &#39;$&#39; is not).</span>
<span class="sd">- verbose_name=&lt;value&gt;: A human readable name for this property. This human</span>
<span class="sd">  readable name can be used for html form labels.</span>

<span class="sd">The repeated and required/default options are mutually exclusive: a repeated</span>
<span class="sd">property cannot be required nor can it specify a default value (the default is</span>
<span class="sd">always an empty list and an empty list is always an allowed value), but a</span>
<span class="sd">required property can have a default.</span>

<span class="sd">Some property types have additional arguments.  Some property types do not</span>
<span class="sd">support all options.</span>

<span class="sd">Repeated properties are always represented as Python lists; if there is only</span>
<span class="sd">one value, the list has only one element. When a new list is assigned to a</span>
<span class="sd">repeated property, all elements of the list are validated. Since it is also</span>
<span class="sd">possible to mutate lists in place, repeated properties are re-validated before</span>
<span class="sd">they are written to the datastore.</span>

<span class="sd">No validation happens when an entity is read from Cloud Datastore; however</span>
<span class="sd">property values read that have the wrong type (e.g. a string value for an</span>
<span class="sd">IntegerProperty) are ignored.</span>

<span class="sd">For non-repeated properties, None is always a possible value, and no validation</span>
<span class="sd">is called when the value is set to None. However for required properties,</span>
<span class="sd">writing the entity to Cloud Datastore requires the value to be something other</span>
<span class="sd">than None (and valid).</span>

<span class="sd">The StructuredProperty is different from most other properties; it lets you</span>
<span class="sd">define a sub-structure for your entities. The substructure itself is defined</span>
<span class="sd">using a model class, and the attribute value is an instance of that model</span>
<span class="sd">class. However, it is not stored in the datastore as a separate entity;</span>
<span class="sd">instead, its attribute values are included in the parent entity using a naming</span>
<span class="sd">convention (the name of the structured attribute followed by a dot followed by</span>
<span class="sd">the name of the subattribute). For example::</span>

<span class="sd">    class Address(Model):</span>
<span class="sd">      street = StringProperty()</span>
<span class="sd">      city = StringProperty()</span>

<span class="sd">    class Person(Model):</span>
<span class="sd">      name = StringProperty()</span>
<span class="sd">      address = StructuredProperty(Address)</span>

<span class="sd">    p = Person(name=&#39;Harry Potter&#39;,</span>
<span class="sd">               address=Address(street=&#39;4 Privet Drive&#39;,</span>
<span class="sd">               city=&#39;Little Whinging&#39;))</span>
<span class="sd">    k = p.put()</span>

<span class="sd">This would write a single &#39;Person&#39; entity with three attributes (as you could</span>
<span class="sd">verify using the Datastore Viewer in the Admin Console)::</span>

<span class="sd">    name = &#39;Harry Potter&#39;</span>
<span class="sd">    address.street = &#39;4 Privet Drive&#39;</span>
<span class="sd">    address.city = &#39;Little Whinging&#39;</span>

<span class="sd">Structured property types can be nested arbitrarily deep, but in a hierarchy of</span>
<span class="sd">nested structured property types, only one level can have the repeated flag</span>
<span class="sd">set. It is fine to have multiple structured properties referencing the same</span>
<span class="sd">model class.</span>

<span class="sd">It is also fine to use the same model class both as a top-level entity class</span>
<span class="sd">and as for a structured property; however, queries for the model class will</span>
<span class="sd">only return the top-level entities.</span>

<span class="sd">The LocalStructuredProperty works similar to StructuredProperty on the Python</span>
<span class="sd">side. For example::</span>

<span class="sd">    class Address(Model):</span>
<span class="sd">        street = StringProperty()</span>
<span class="sd">        city = StringProperty()</span>

<span class="sd">    class Person(Model):</span>
<span class="sd">        name = StringProperty()</span>
<span class="sd">        address = LocalStructuredProperty(Address)</span>

<span class="sd">    p = Person(name=&#39;Harry Potter&#39;,</span>
<span class="sd">               address=Address(street=&#39;4 Privet Drive&#39;,</span>
<span class="sd">               city=&#39;Little Whinging&#39;))</span>
<span class="sd">    k = p.put()</span>

<span class="sd">However, the data written to Cloud Datastore is different; it writes a &#39;Person&#39;</span>
<span class="sd">entity with a &#39;name&#39; attribute as before and a single &#39;address&#39; attribute</span>
<span class="sd">whose value is a blob which encodes the Address value (using the standard</span>
<span class="sd">&quot;protocol buffer&quot; encoding).</span>

<span class="sd">The Model class offers basic query support. You can create a Query object by</span>
<span class="sd">calling the query() class method. Iterating over a Query object returns the</span>
<span class="sd">entities matching the query one at a time. Query objects are fully described</span>
<span class="sd">in the documentation for query, but there is one handy shortcut that is only</span>
<span class="sd">available through Model.query(): positional arguments are interpreted as filter</span>
<span class="sd">expressions which are combined through an AND operator. For example::</span>

<span class="sd">    Person.query(Person.name == &#39;Harry Potter&#39;, Person.age &gt;= 11)</span>

<span class="sd">is equivalent to::</span>

<span class="sd">    Person.query().filter(Person.name == &#39;Harry Potter&#39;, Person.age &gt;= 11)</span>

<span class="sd">Keyword arguments passed to .query() are passed along to the Query() constructor.</span>

<span class="sd">It is possible to query for field values of structured properties. For</span>
<span class="sd">example::</span>

<span class="sd">    qry = Person.query(Person.address.city == &#39;London&#39;)</span>

<span class="sd">A number of top-level functions also live in this module:</span>

<span class="sd">- :func:`get_multi` reads multiple entities at once.</span>
<span class="sd">- :func:`put_multi` writes multiple entities at once.</span>
<span class="sd">- :func:`delete_multi` deletes multiple entities at once.</span>

<span class="sd">All these have a corresponding ``*_async()`` variant as well. The</span>
<span class="sd">``*_multi_async()`` functions return a list of Futures.</span>

<span class="sd">There are many other interesting features. For example, Model subclasses may</span>
<span class="sd">define pre-call and post-call hooks for most operations (get, put, delete,</span>
<span class="sd">allocate_ids), and Property classes may be subclassed to suit various needs.</span>
<span class="sd">Documentation for writing a Property subclass is in the docs for the</span>
<span class="sd">:class:`Property` class.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">zlib</span>

<span class="kn">from</span> <span class="nn">google.cloud.datastore</span> <span class="k">import</span> <span class="n">entity</span> <span class="k">as</span> <span class="n">entity_module</span>
<span class="kn">from</span> <span class="nn">google.cloud.datastore</span> <span class="k">import</span> <span class="n">helpers</span>
<span class="kn">from</span> <span class="nn">google.cloud.datastore_v1.proto</span> <span class="k">import</span> <span class="n">entity_pb2</span>

<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">context</span> <span class="k">as</span> <span class="n">context_module</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">_datastore_api</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">_datastore_types</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">key</span> <span class="k">as</span> <span class="n">key_module</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">_options</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">query</span> <span class="k">as</span> <span class="n">query_module</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">_transaction</span>
<span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">tasklets</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Key&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BlobKey&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GeoPt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Rollback&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KindError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;InvalidPropertyError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BadProjectionError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;UnprojectedPropertyError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ReadonlyPropertyError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ComputedPropertyError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;UserNotFoundError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IndexProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Index&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IndexState&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ModelAdapter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;make_connection&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ModelAttribute&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Property&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ModelKey&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BooleanProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IntegerProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FloatProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BlobProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TextProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;StringProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GeoPtProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PickleProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;JsonProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;User&quot;</span><span class="p">,</span>
    <span class="s2">&quot;UserProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KeyProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BlobKeyProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DateTimeProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DateProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TimeProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;StructuredProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LocalStructuredProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GenericProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ComputedProperty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MetaModel&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Model&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Expando&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_multi_async&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_multi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;put_multi_async&quot;</span><span class="p">,</span>
    <span class="s2">&quot;put_multi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;delete_multi_async&quot;</span><span class="p">,</span>
    <span class="s2">&quot;delete_multi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_indexes_async&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_indexes&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="n">_MEANING_PREDEFINED_ENTITY_USER</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">_MEANING_URI_COMPRESSED</span> <span class="o">=</span> <span class="s2">&quot;ZLIB&quot;</span>
<span class="n">_MAX_STRING_LENGTH</span> <span class="o">=</span> <span class="mi">1500</span>
<span class="n">Key</span> <span class="o">=</span> <span class="n">key_module</span><span class="o">.</span><span class="n">Key</span>
<span class="n">BlobKey</span> <span class="o">=</span> <span class="n">_datastore_types</span><span class="o">.</span><span class="n">BlobKey</span>
<span class="n">GeoPt</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">GeoPoint</span>
<span class="n">Rollback</span> <span class="o">=</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">Rollback</span>


<div class="viewcode-block" id="KindError"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.KindError">[docs]</a><span class="k">class</span> <span class="nc">KindError</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised when an implementation for a kind can&#39;t be found.</span>

<span class="sd">    May also be raised when the kind is not a byte string.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="InvalidPropertyError"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.InvalidPropertyError">[docs]</a><span class="k">class</span> <span class="nc">InvalidPropertyError</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised when a property is not applicable to a given use.</span>

<span class="sd">    For example, a property must exist and be indexed to be used in a query&#39;s</span>
<span class="sd">    projection or group by clause.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<span class="n">BadProjectionError</span> <span class="o">=</span> <span class="n">InvalidPropertyError</span>
<span class="sd">&quot;&quot;&quot;This alias for :class:`InvalidPropertyError` is for legacy support.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="UnprojectedPropertyError"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.UnprojectedPropertyError">[docs]</a><span class="k">class</span> <span class="nc">UnprojectedPropertyError</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised when getting a property value that&#39;s not in the projection.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="ReadonlyPropertyError"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.ReadonlyPropertyError">[docs]</a><span class="k">class</span> <span class="nc">ReadonlyPropertyError</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised when attempting to set a property value that is read-only.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="ComputedPropertyError"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.ComputedPropertyError">[docs]</a><span class="k">class</span> <span class="nc">ComputedPropertyError</span><span class="p">(</span><span class="n">ReadonlyPropertyError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised when attempting to set or delete a computed property.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="UserNotFoundError"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.UserNotFoundError">[docs]</a><span class="k">class</span> <span class="nc">UserNotFoundError</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;No email argument was specified, and no user is logged in.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="IndexProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.IndexProperty">[docs]</a><span class="k">class</span> <span class="nc">IndexProperty</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Immutable object representing a single property in an index.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_name&quot;</span><span class="p">,</span> <span class="s2">&quot;_direction&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">IndexProperty</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_direction</span> <span class="o">=</span> <span class="n">direction</span>
        <span class="k">return</span> <span class="n">instance</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str: The property name being indexed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">direction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str: The direction in the index, ``asc`` or ``desc``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span>

<div class="viewcode-block" id="IndexProperty.__repr__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.IndexProperty.__repr__">[docs]</a>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(name=</span><span class="si">{!r}</span><span class="s2">, direction=</span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="IndexProperty.__eq__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.IndexProperty.__eq__">[docs]</a>    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare two index properties for equality.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">IndexProperty</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">direction</span></div>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">))</span></div>


<div class="viewcode-block" id="Index"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Index">[docs]</a><span class="k">class</span> <span class="nc">Index</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Immutable object representing an index.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_kind&quot;</span><span class="p">,</span> <span class="s2">&quot;_properties&quot;</span><span class="p">,</span> <span class="s2">&quot;_ancestor&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">ancestor</span><span class="p">):</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Index</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="n">properties</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_ancestor</span> <span class="o">=</span> <span class="n">ancestor</span>
        <span class="k">return</span> <span class="n">instance</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str: The kind being indexed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List[IndexProperty]: The properties being indexed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ancestor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;bool: Indicates if this is an ancestor index.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ancestor</span>

<div class="viewcode-block" id="Index.__repr__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Index.__repr__">[docs]</a>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(kind=</span><span class="si">{!r}</span><span class="s2">, properties=</span><span class="si">{!r}</span><span class="s2">, ancestor=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Index.__eq__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Index.__eq__">[docs]</a>    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare two indexes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Index</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">kind</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">properties</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ancestor</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span><span class="p">))</span></div>


<div class="viewcode-block" id="IndexState"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.IndexState">[docs]</a><span class="k">class</span> <span class="nc">IndexState</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Immutable object representing an index and its state.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_definition&quot;</span><span class="p">,</span> <span class="s2">&quot;_state&quot;</span><span class="p">,</span> <span class="s2">&quot;_id&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">IndexState</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_definition</span> <span class="o">=</span> <span class="n">definition</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="k">return</span> <span class="n">instance</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Index: The index corresponding to the tracked state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str: The index state.</span>

<span class="sd">        Possible values are ``error``, ``deleting``, ``serving`` or</span>
<span class="sd">        ``building``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;int: The index ID.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

<div class="viewcode-block" id="IndexState.__repr__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.IndexState.__repr__">[docs]</a>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(definition=</span><span class="si">{!r}</span><span class="s2">, state=</span><span class="si">{!r}</span><span class="s2">, id=</span><span class="si">{:d}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="IndexState.__eq__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.IndexState.__eq__">[docs]</a>    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare two index states.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">IndexState</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">definition</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">definition</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">state</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span></div>


<div class="viewcode-block" id="ModelAdapter"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.ModelAdapter">[docs]</a><span class="k">class</span> <span class="nc">ModelAdapter</span><span class="p">:</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">_entity_from_ds_entity</span><span class="p">(</span><span class="n">ds_entity</span><span class="p">,</span> <span class="n">model_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create an entity from a datastore entity.</span>

<span class="sd">    Args:</span>
<span class="sd">        ds_entity (google.cloud.datastore_v1.types.Entity): An entity to be</span>
<span class="sd">        deserialized.</span>

<span class="sd">    Returns:</span>
<span class="sd">        .Model: The deserialized entity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_class</span> <span class="o">=</span> <span class="n">model_class</span> <span class="ow">or</span> <span class="n">Model</span><span class="o">.</span><span class="n">_lookup_model</span><span class="p">(</span><span class="n">ds_entity</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
    <span class="n">entity</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ds_entity</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">key_module</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">_from_ds_key</span><span class="p">(</span><span class="n">ds_entity</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ds_entity</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">prop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">Property</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">_BaseValue</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span> <span class="k">for</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">_BaseValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">prop</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">entity</span>


<span class="k">def</span> <span class="nf">_entity_from_protobuf</span><span class="p">(</span><span class="n">protobuf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deserialize an entity from a protobuffer.</span>

<span class="sd">    Args:</span>
<span class="sd">        protobuf (google.cloud.datastore_v1.types.Entity): An entity protobuf</span>
<span class="sd">            to be deserialized.</span>

<span class="sd">    Returns:</span>
<span class="sd">        .Model: The deserialized entity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ds_entity</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">entity_from_protobuf</span><span class="p">(</span><span class="n">protobuf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_entity_from_ds_entity</span><span class="p">(</span><span class="n">ds_entity</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_entity_to_ds_entity</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">set_key</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert an NDB entity to Datastore entity.</span>

<span class="sd">    Args:</span>
<span class="sd">        entity (Model): The entity to be converted.</span>

<span class="sd">    Returns:</span>
<span class="sd">        google.cloud.datastore.entity.Entity: The converted entity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span><span class="o">.</span><span class="n">mro</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">Property</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">ModelKey</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">prop</span><span class="o">.</span><span class="n">_name</span> <span class="ow">in</span> <span class="n">data</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">_get_base_value_unwrapped_as_list</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prop</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">ds_entity</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">set_key</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_key</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key_module</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">(),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ds_entity</span> <span class="o">=</span> <span class="n">entity_module</span><span class="o">.</span><span class="n">Entity</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">_key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ds_entity</span> <span class="o">=</span> <span class="n">entity_module</span><span class="o">.</span><span class="n">Entity</span><span class="p">()</span>
    <span class="n">ds_entity</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds_entity</span>


<span class="k">def</span> <span class="nf">_entity_to_protobuf</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">set_key</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Serialize an entity to a protocol buffer.</span>

<span class="sd">    Args:</span>
<span class="sd">        entity (Model): The entity to be serialized.</span>

<span class="sd">    Returns:</span>
<span class="sd">        google.cloud.datastore_v1.types.Entity: The protocol buffer</span>
<span class="sd">            representation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ds_entity</span> <span class="o">=</span> <span class="n">_entity_to_ds_entity</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">set_key</span><span class="o">=</span><span class="n">set_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">helpers</span><span class="o">.</span><span class="n">entity_to_protobuf</span><span class="p">(</span><span class="n">ds_entity</span><span class="p">)</span>


<div class="viewcode-block" id="make_connection"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.make_connection">[docs]</a><span class="k">def</span> <span class="nf">make_connection</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="ModelAttribute"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.ModelAttribute">[docs]</a><span class="k">class</span> <span class="nc">ModelAttribute</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base for classes that implement a ``_fix_up()`` method.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fix_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">code_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fix-up property name. To be implemented by subclasses.</span>

<span class="sd">        Args:</span>
<span class="sd">            cls (type): The model class that owns the property.</span>
<span class="sd">            code_name (str): The name of the :class:`Property` being fixed up.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<span class="k">class</span> <span class="nc">_BaseValue</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A marker object wrapping a &quot;base type&quot; value.</span>

<span class="sd">    This is used to be able to tell whether ``entity._values[name]`` is a</span>
<span class="sd">    user value (i.e. of a type that the Python code understands) or a</span>
<span class="sd">    base value (i.e of a type that serialization understands).</span>
<span class="sd">    User values are unwrapped; base values are wrapped in a</span>
<span class="sd">    :class:`_BaseValue` instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        b_val (Any): The base value to be wrapped.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If ``b_val`` is :data:`None`.</span>
<span class="sd">        TypeError: If ``b_val`` is a list.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;b_val&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b_val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">b_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot wrap None&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b_val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Lists cannot be wrapped. Received&quot;</span><span class="p">,</span> <span class="n">b_val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_val</span> <span class="o">=</span> <span class="n">b_val</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;_BaseValue(</span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare two :class:`_BaseValue` instances.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_BaseValue</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_val</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">b_val</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;_BaseValue is not immutable&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="Property"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Property">[docs]</a><span class="k">class</span> <span class="nc">Property</span><span class="p">(</span><span class="n">ModelAttribute</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class describing a typed, persisted attribute of an entity.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        This is not to be confused with Python&#39;s ``@property`` built-in.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This is just a base class; there are specific subclasses that</span>
<span class="sd">        describe properties of various types (and :class:`GenericProperty`</span>
<span class="sd">        which describes a dynamically typed property).</span>

<span class="sd">    The :class:`Property` does not reserve any &quot;public&quot; names (i.e. names</span>
<span class="sd">    that don&#39;t start with an underscore). This is intentional; the subclass</span>
<span class="sd">    :class:`StructuredProperty` uses the public attribute namespace to refer to</span>
<span class="sd">    nested property names (this is essential for specifying queries on</span>
<span class="sd">    subproperties).</span>

<span class="sd">    The :meth:`IN` attribute is provided as an alias for ``_IN``, but ``IN``</span>
<span class="sd">    can be overridden if a subproperty has the same name.</span>

<span class="sd">    The :class:`Property` class and its predefined subclasses allow easy</span>
<span class="sd">    subclassing using composable (or stackable) validation and</span>
<span class="sd">    conversion APIs. These require some terminology definitions:</span>

<span class="sd">    * A **user value** is a value such as would be set and accessed by the</span>
<span class="sd">      application code using standard attributes on the entity.</span>
<span class="sd">    * A **base value** is a value such as would be serialized to</span>
<span class="sd">      and deserialized from Cloud Datastore.</span>

<span class="sd">    A property will be a member of a :class:`Model` and will be used to help</span>
<span class="sd">    store values in an ``entity`` (i.e. instance of a model subclass). The</span>
<span class="sd">    underlying stored values can be either user values or base values.</span>

<span class="sd">    To interact with the composable conversion and validation API, a</span>
<span class="sd">    :class:`Property` subclass can define</span>

<span class="sd">    * ``_to_base_type()``</span>
<span class="sd">    * ``_from_base_type()``</span>
<span class="sd">    * ``_validate()``</span>

<span class="sd">    These should **not** call their ``super()`` method, since the methods</span>
<span class="sd">    are meant to be composed. For example with composable validation:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        class Positive(ndb.IntegerProperty):</span>
<span class="sd">            def _validate(self, value):</span>
<span class="sd">                if value &lt; 1:</span>
<span class="sd">                    raise ndb.exceptions.BadValueError(&quot;Non-positive&quot;, value)</span>


<span class="sd">        class SingleDigit(Positive):</span>
<span class="sd">            def _validate(self, value):</span>
<span class="sd">                if value &gt; 9:</span>
<span class="sd">                    raise ndb.exceptions.BadValueError(&quot;Multi-digit&quot;, value)</span>

<span class="sd">    neither ``_validate()`` method calls ``super()``. Instead, when a</span>
<span class="sd">    ``SingleDigit`` property validates a value, it composes all validation</span>
<span class="sd">    calls in order:</span>

<span class="sd">    * ``SingleDigit._validate``</span>
<span class="sd">    * ``Positive._validate``</span>
<span class="sd">    * ``IntegerProperty._validate``</span>

<span class="sd">    The API supports &quot;stacking&quot; classes with ever more sophisticated</span>
<span class="sd">    user / base conversions:</span>

<span class="sd">    * the user to base conversion goes from more sophisticated to less</span>
<span class="sd">      sophisticated</span>
<span class="sd">    * the base to user conversion goes from less sophisticated to more</span>
<span class="sd">      sophisticated</span>

<span class="sd">    For example, see the relationship between :class:`BlobProperty`,</span>
<span class="sd">    :class:`TextProperty` and :class:`StringProperty`.</span>

<span class="sd">    The validation API distinguishes between &quot;lax&quot; and &quot;strict&quot; user values.</span>
<span class="sd">    The set of lax values is a superset of the set of strict values. The</span>
<span class="sd">    ``_validate()`` method takes a lax value and if necessary converts it to</span>
<span class="sd">    a strict value. For example, an integer (lax) can be converted to a</span>
<span class="sd">    floating point (strict) value. This means that when setting the property</span>
<span class="sd">    value, lax values are accepted, while when getting the property value, only</span>
<span class="sd">    strict values will be returned. If no conversion is needed, ``_validate()``</span>
<span class="sd">    may return :data:`None`. If the argument is outside the set of accepted lax</span>
<span class="sd">    values, ``_validate()`` should raise an exception, preferably</span>
<span class="sd">    :exc:`TypeError` or :exc:`.BadValueError`.</span>

<span class="sd">    A class utilizing all three may resemble:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        class WidgetProperty(ndb.Property):</span>

<span class="sd">            def _validate(self, value):</span>
<span class="sd">                # Lax user value to strict user value.</span>
<span class="sd">                if not isinstance(value, Widget):</span>
<span class="sd">                    raise nbd.exceptions.BadValueError(value)</span>

<span class="sd">            def _to_base_type(self, value):</span>
<span class="sd">                # (Strict) user value to base value.</span>
<span class="sd">                if isinstance(value, Widget):</span>
<span class="sd">                    return value.to_internal()</span>

<span class="sd">            def _from_base_type(self, value):</span>
<span class="sd">                # Base value to (strict) user value.&#39;</span>
<span class="sd">                if not isinstance(value, _WidgetInternal):</span>
<span class="sd">                    return Widget(value)</span>

<span class="sd">    There are some things that ``_validate()``, ``_to_base_type()`` and</span>
<span class="sd">    ``_from_base_type()`` do **not** need to handle:</span>

<span class="sd">    * :data:`None`: They will not be called with :data:`None` (and if they</span>
<span class="sd">      return :data:`None`, this means that the value does not need conversion).</span>
<span class="sd">    * Repeated values: The infrastructure takes care of calling</span>
<span class="sd">      ``_from_base_type()`` or ``_to_base_type()`` for each list item in a</span>
<span class="sd">      repeated value.</span>
<span class="sd">    * Wrapping &quot;base&quot; values: The wrapping and unwrapping is taken care of by</span>
<span class="sd">      the infrastructure that calls the composable APIs.</span>
<span class="sd">    * Comparisons: The comparison operations call ``_to_base_type()`` on</span>
<span class="sd">      their operand.</span>
<span class="sd">    * Distinguishing between user and base values: the infrastructure</span>
<span class="sd">      guarantees that ``_from_base_type()`` will be called with an</span>
<span class="sd">      (unwrapped) base value, and that ``_to_base_type()`` will be called</span>
<span class="sd">      with a user value.</span>
<span class="sd">    * Returning the original value: if any of these return :data:`None`, the</span>
<span class="sd">      original value is kept. (Returning a different value not equal to</span>
<span class="sd">      :data:`None` will substitute the different value.)</span>

<span class="sd">    Additionally, :meth:`_prepare_for_put` can be used to integrate with</span>
<span class="sd">    datastore save hooks used by :class:`Model` instances.</span>

<span class="sd">    .. automethod:: _prepare_for_put</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): The name of the property.</span>
<span class="sd">        indexed (bool): Indicates if the value should be indexed.</span>
<span class="sd">        repeated (bool): Indicates if this property is repeated, i.e. contains</span>
<span class="sd">            multiple values.</span>
<span class="sd">        required (bool): Indicates if this property is required on the given</span>
<span class="sd">            model type.</span>
<span class="sd">        default (Any): The default value for this property.</span>
<span class="sd">        choices (Iterable[Any]): A container of allowed values for this</span>
<span class="sd">            property.</span>
<span class="sd">        validator (Callable[[~google.cloud.ndb.model.Property, Any], bool]): A</span>
<span class="sd">            validator to be used to check values.</span>
<span class="sd">        verbose_name (str): A longer, user-friendly name for this property.</span>
<span class="sd">        write_empty_list (bool): Indicates if an empty list should be written</span>
<span class="sd">            to the datastore.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Instance default fallbacks provided by class.</span>
    <span class="n">_code_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_indexed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_repeated</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_required</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_default</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_choices</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_validator</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_verbose_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_write_empty_list</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Non-public class attributes.</span>
    <span class="n">_FIND_METHODS_CACHE</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">indexed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">repeated</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">write_empty_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># NOTE: These explicitly avoid setting the values so that the</span>
        <span class="c1">#       instances will fall back to the class on lookup.</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">indexed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="o">=</span> <span class="n">indexed</span>
        <span class="k">if</span> <span class="n">repeated</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span> <span class="o">=</span> <span class="n">repeated</span>
        <span class="k">if</span> <span class="n">required</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_required</span> <span class="o">=</span> <span class="n">required</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_repeated</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">choices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_choices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_choices</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_validator</span><span class="p">(</span><span class="n">validator</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verbose_name</span> <span class="o">=</span> <span class="n">verbose_name</span>
        <span class="k">if</span> <span class="n">write_empty_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_empty_list</span> <span class="o">=</span> <span class="n">write_empty_list</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_verify_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the name of the property.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): The name of the property.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The ``name`` passed in.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the ``name`` is not a string.</span>
<span class="sd">            ValueError: If the name contains a ``.``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Name </span><span class="si">{!r}</span><span class="s2"> is not a string&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Name </span><span class="si">{!r}</span><span class="s2"> cannot contain period characters&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">_verify_repeated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if the repeated / required / default values are compatible.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If ``repeated`` is :data:`True` but one of</span>
<span class="sd">                ``required`` or ``default`` is set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_required</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;repeated is incompatible with required or default&quot;</span>
            <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_verify_choices</span><span class="p">(</span><span class="n">choices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the choices for a property with a limited set of values.</span>

<span class="sd">        Args:</span>
<span class="sd">            choices (Union[list, tuple, set, frozenset]): An iterable of</span>
<span class="sd">                allowed values for the property.</span>

<span class="sd">        Returns:</span>
<span class="sd">            frozenset: The ``choices`` cast to a frozen set.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If ``choices`` is not one of the expected container</span>
<span class="sd">                types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;choices must be a list, tuple or set; received </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">choices</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_verify_validator</span><span class="p">(</span><span class="n">validator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the validator for a property.</span>

<span class="sd">        The validator will be called as follows:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            value = validator(prop, value)</span>

<span class="sd">        The ``validator`` should be idempotent, i.e. calling it a second time</span>
<span class="sd">        should not further modify the value. So a validator that returns e.g.</span>
<span class="sd">        ``value.lower()`` or ``value.strip()`` is fine, but one that returns</span>
<span class="sd">        ``value + &quot;$&quot;`` is not.</span>

<span class="sd">        Args:</span>
<span class="sd">            validator (Callable[[Property, Any], bool]): A callable that can</span>
<span class="sd">                validate a property value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Callable[[Property, Any], bool]: The ``validator``.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If ``validator`` is not callable. This is determined by</span>
<span class="sd">                checking is the attribute ``__call__`` is defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: Checking for ``_call__`` is done to match the original</span>
        <span class="c1">#       implementation. It&#39;s not clear why ``callable()`` was not used.</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">validator</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;validator must be callable or None; received </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">validator</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">validator</span>

    <span class="k">def</span> <span class="nf">_constructor_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`__repr__`.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Tuple[str, bool]: Pairs of argument name and a boolean indicating</span>
<span class="sd">            if that argument is a keyword.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">is_keyword</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">KEYWORD_ONLY</span>
            <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">is_keyword</span>

<div class="viewcode-block" id="Property.__repr__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Property.__repr__">[docs]</a>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a compact unambiguous string representation of a property.</span>

<span class="sd">        This cycles through all stored attributes and displays the ones that</span>
<span class="sd">        differ from the default values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">is_keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor_info</span><span class="p">():</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">instance_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">default_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">instance_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">default_val</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance_val</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
                    <span class="n">as_str</span> <span class="o">=</span> <span class="n">instance_val</span><span class="o">.</span><span class="vm">__qualname__</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">as_str</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">instance_val</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">is_keyword</span><span class="p">:</span>
                    <span class="n">as_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">as_str</span><span class="p">)</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">as_str</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_datastore_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal hook used by property filters.</span>

<span class="sd">        Sometimes the low-level query interface needs a specific data type</span>
<span class="sd">        in order for the right filter to be constructed. See</span>
<span class="sd">        :meth:`_comparison`.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Any): The value to be converted to a low-level type.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The passed-in ``value``, always. Subclasses may alter this</span>
<span class="sd">            behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal helper for comparison operators.</span>

<span class="sd">        Args:</span>
<span class="sd">            op (str): The comparison operator. One of ``=``, ``!=``, ``&lt;``,</span>
<span class="sd">                ``&lt;=``, ``&gt;``, ``&gt;=`` or ``in``.</span>
<span class="sd">            value (Any): The value to compare against.</span>

<span class="sd">        Returns:</span>
<span class="sd">            FilterNode: A FilterNode instance representing the requested</span>
<span class="sd">            comparison.</span>

<span class="sd">        Raises:</span>
<span class="sd">            BadFilterError: If the current property is not indexed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import late to avoid circular imports.</span>
        <span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">query</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot query for unindexed property </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_to_base_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datastore_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">FilterNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="c1"># Comparison operators on Property instances don&#39;t compare the</span>
    <span class="c1"># properties; instead they return ``FilterNode``` instances that can be</span>
    <span class="c1"># used in queries.</span>

<div class="viewcode-block" id="Property.__eq__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Property.__eq__">[docs]</a>    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;FilterNode: Represents the ``=`` comparison.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Property.__ne__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Property.__ne__">[docs]</a>    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;FilterNode: Represents the ``!=`` comparison.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="s2">&quot;!=&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Property.__lt__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Property.__lt__">[docs]</a>    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;FilterNode: Represents the ``&lt;`` comparison.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Property.__le__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Property.__le__">[docs]</a>    <span class="k">def</span> <span class="nf">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;FilterNode: Represents the ``&lt;=`` comparison.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Property.__gt__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Property.__gt__">[docs]</a>    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;FilterNode: Represents the ``&gt;`` comparison.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Property.__ge__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Property.__ge__">[docs]</a>    <span class="k">def</span> <span class="nf">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;FilterNode: Represents the ``&gt;=`` comparison.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_IN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For the ``in`` comparison operator.</span>

<span class="sd">        The ``in`` operator cannot be overloaded in the way we want</span>
<span class="sd">        to, so we define a method. For example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Employee.query(Employee.rank.IN([4, 5, 6]))</span>

<span class="sd">        Note that the method is called ``_IN()`` but may normally be invoked</span>
<span class="sd">        as ``IN()``; ``_IN()`` is provided for the case that a</span>
<span class="sd">        :class:`.StructuredProperty` refers to a model that has a property</span>
<span class="sd">        named ``IN``.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Iterable[Any]): The set of values that the property value</span>
<span class="sd">                must be contained in.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[~google.cloud.ndb.query.DisjunctionNode, \</span>
<span class="sd">                ~google.cloud.ndb.query.FilterNode, \</span>
<span class="sd">                ~google.cloud.ndb.query.FalseNode]: A node corresponding</span>
<span class="sd">            to the desired in filter.</span>

<span class="sd">            * If ``value`` is empty, this will return a :class:`.FalseNode`</span>
<span class="sd">            * If ``len(value) == 1``, this will return a :class:`.FilterNode`</span>
<span class="sd">            * Otherwise, this will return a :class:`.DisjunctionNode`</span>

<span class="sd">        Raises:</span>
<span class="sd">            ~google.cloud.ndb.exceptions.BadFilterError: If the current</span>
<span class="sd">                property is not indexed.</span>
<span class="sd">            ~google.cloud.ndb.exceptions.BadArgumentError: If ``value`` is not</span>
<span class="sd">                a basic container (:class:`list`, :class:`tuple`, :class:`set`</span>
<span class="sd">                or :class:`frozenset`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import late to avoid circular imports.</span>
        <span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">query</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot query for unindexed property </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
                <span class="s2">&quot;Expected list, tuple or set, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sub_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sub_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_validate</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span>
                <span class="n">sub_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_to_base_type</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span>
                <span class="n">sub_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datastore_type</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">FilterNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

    <span class="n">IN</span> <span class="o">=</span> <span class="n">_IN</span>
    <span class="sd">&quot;&quot;&quot;Used to check if a property value is contained in a set of values.</span>

<span class="sd">    For example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        Employee.query(Employee.rank.IN([4, 5, 6]))</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Property.__neg__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Property.__neg__">[docs]</a>    <span class="k">def</span> <span class="nf">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a descending sort order on this property.</span>

<span class="sd">        For example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Employee.query().order(-Employee.rank)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import late to avoid circular imports.</span>
        <span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">query</span>

        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">PropertyOrder</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Property.__pos__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Property.__pos__">[docs]</a>    <span class="k">def</span> <span class="nf">__pos__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an ascending sort order on this property.</span>

<span class="sd">        Note that this is redundant but provided for consistency with</span>
<span class="sd">        :meth:`__neg__`. For example, the following two are equivalent:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Employee.query().order(+Employee.rank)</span>
<span class="sd">            Employee.query().order(Employee.rank)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import late to avoid circular imports.</span>
        <span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">query</span>

        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">PropertyOrder</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_do_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call all validations on the value.</span>

<span class="sd">        This transforms the ``value`` via:</span>

<span class="sd">        * Calling the derived ``_validate()`` method(s) (on subclasses that</span>
<span class="sd">          don&#39;t define ``_to_base_type()``),</span>
<span class="sd">        * Calling the custom validator function</span>

<span class="sd">        After transforming, it checks if the transformed value is in</span>
<span class="sd">        ``choices`` (if defined).</span>

<span class="sd">        It&#39;s possible that one of the ``_validate()`` methods will raise</span>
<span class="sd">        an exception.</span>

<span class="sd">        If ``value`` is a base-value, this will do nothing and return it.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This does not call all composable ``_validate()`` methods.</span>
<span class="sd">            It only calls ``_validate()`` methods up to the</span>
<span class="sd">            first class in the hierarchy that defines a ``_to_base_type()``</span>
<span class="sd">            method, when the MRO is traversed looking for ``_validate()`` and</span>
<span class="sd">            ``_to_base_type()`` methods.</span>

<span class="sd">        .. note::</span>

<span class="sd">            For a repeated property this method should be called</span>
<span class="sd">            for each value in the list, not for the list as a whole.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Any): The value to be converted / validated.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The transformed ``value``, possibly modified in an idempotent</span>
<span class="sd">            way.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_BaseValue</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_shallow_validation</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">new_value</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choices</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Value </span><span class="si">{!r}</span><span class="s2"> for property </span><span class="si">{}</span><span class="s2"> is not an allowed &quot;</span>
                    <span class="s2">&quot;choice&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_fix_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">code_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal helper called to tell the property its name.</span>

<span class="sd">        This is called by :meth:`_fix_up_properties`, which is called by</span>
<span class="sd">        :class:`MetaModel` when finishing the construction of a :class:`Model`</span>
<span class="sd">        subclass. The name passed in is the name of the class attribute to</span>
<span class="sd">        which the current property is assigned (a.k.a. the code name). Note</span>
<span class="sd">        that this means that each property instance must be assigned to (at</span>
<span class="sd">        most) one class attribute. E.g. to declare three strings, you must</span>
<span class="sd">        call create three :class:`StringProperty` instances:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            class MyModel(ndb.Model):</span>
<span class="sd">                foo = ndb.StringProperty()</span>
<span class="sd">                bar = ndb.StringProperty()</span>
<span class="sd">                baz = ndb.StringProperty()</span>

<span class="sd">        you cannot write:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            class MyModel(ndb.Model):</span>
<span class="sd">                foo = bar = baz = ndb.StringProperty()</span>

<span class="sd">        Args:</span>
<span class="sd">            cls (type): The class that the property is stored on. This argument</span>
<span class="sd">                is unused by this method, but may be used by subclasses.</span>
<span class="sd">            code_name (str): The name (on the class) that refers to this</span>
<span class="sd">                property.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_code_name</span> <span class="o">=</span> <span class="n">code_name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">code_name</span>

    <span class="k">def</span> <span class="nf">_store_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store a value in an entity for this property.</span>

<span class="sd">        This assumes validation has already taken place. For a repeated</span>
<span class="sd">        property the value should be a list.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to set a value on.</span>
<span class="sd">            value (Any): The value to be stored for this property.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a value in an entity for a property.</span>

<span class="sd">        This performs validation first. For a repeated property the value</span>
<span class="sd">        should be a list (or similar container).</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to set a value on.</span>
<span class="sd">            value (Any): The value to be stored for this property.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ReadonlyPropertyError: If the ``entity`` is the result of a</span>
<span class="sd">                projection query.</span>
<span class="sd">            .BadValueError: If the current property is repeated but the</span>
<span class="sd">                ``value`` is not a basic container (:class:`list`,</span>
<span class="sd">                :class:`tuple`, :class:`set` or :class:`frozenset`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadonlyPropertyError</span><span class="p">(</span>
                <span class="s2">&quot;You cannot set property values of a projection entity&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Expected list or tuple, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_do_validate</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_has_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">unused_rest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine if the entity has a value for this property.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to check if the current property has</span>
<span class="sd">                a value set.</span>
<span class="sd">            unused_rest (None): An always unused keyword.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_values</span>

    <span class="k">def</span> <span class="nf">_retrieve_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the value for this property from an entity.</span>

<span class="sd">        This returns :data:`None` if no value is set, or the ``default``</span>
<span class="sd">        argument if given. For a repeated property this returns a list if a</span>
<span class="sd">        value is set, otherwise :data:`None`. No additional transformations</span>
<span class="sd">        are applied.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to get a value from.</span>
<span class="sd">            default (Optional[Any]): The default value to use as fallback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_user_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the user value for this property of the given entity.</span>

<span class="sd">        This implies removing the :class:`_BaseValue` wrapper if present, and</span>
<span class="sd">        if it is, calling all ``_from_base_type()`` methods, in the reverse</span>
<span class="sd">        method resolution order of the property&#39;s class. It also handles</span>
<span class="sd">        default values and repeated properties.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to get a value from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The original value (if not :class:`_BaseValue`) or the wrapped</span>
<span class="sd">            value converted from the base type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_to_values</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opt_call_from_base_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_base_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the base value for this property of the given entity.</span>

<span class="sd">        This implies calling all ``_to_base_type()`` methods, in the method</span>
<span class="sd">        resolution order of the property&#39;s class, and adding a</span>
<span class="sd">        :class:`_BaseValue` wrapper, if one is not already present. (If one</span>
<span class="sd">        is present, no work is done.)  It also handles default values and</span>
<span class="sd">        repeated properties.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to get a value from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[_BaseValue, List[_BaseValue]]: The original value</span>
<span class="sd">            (if :class:`_BaseValue`) or the value converted to the base type</span>
<span class="sd">            and wrapped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_to_values</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opt_call_to_base_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_base_value_unwrapped_as_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Like _get_base_value(), but always returns a list.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to get a value from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Any]: The unwrapped base values. For an unrepeated</span>
<span class="sd">            property, if the value is missing or :data:`None`, returns</span>
<span class="sd">            ``[None]``; for a repeated property, if the original value is</span>
<span class="sd">            missing or :data:`None` or empty, returns ``[]``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">b_val</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wrapped</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wrapped</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">wrapped</span><span class="o">.</span><span class="n">b_val</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_opt_call_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call ``_from_base_type()`` if necessary.</span>

<span class="sd">        If ``value`` is a :class:`_BaseValue`, unwrap it and call all</span>
<span class="sd">        :math:`_from_base_type` methods. Otherwise, return the value</span>
<span class="sd">        unchanged.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Any): The value to invoke :meth:`_call_from_base_type`</span>
<span class="sd">               for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The original value (if not :class:`_BaseValue`) or the value</span>
<span class="sd">            converted from the base type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_BaseValue</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_from_base_type</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">b_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_value_to_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn a value (base or not) into its repr().</span>

<span class="sd">        This exists so that property classes can override it separately.</span>

<span class="sd">        This manually applies ``_from_base_type()`` so as not to have a side</span>
<span class="sd">        effect on what&#39;s contained in the entity. Printing a value should not</span>
<span class="sd">        change it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Any): The value to convert to a pretty-print ``repr``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The ``repr`` of the &quot;true&quot; value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opt_call_from_base_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_opt_call_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call ``_to_base_type()`` if necessary.</span>

<span class="sd">        If ``value`` is a :class:`_BaseValue`, return it unchanged.</span>
<span class="sd">        Otherwise, call all ``_validate()`` and ``_to_base_type()`` methods</span>
<span class="sd">        and wrap it in a :class:`_BaseValue`.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Any): The value to invoke :meth:`_call_to_base_type`</span>
<span class="sd">               for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            _BaseValue: The original value (if :class:`_BaseValue`) or the</span>
<span class="sd">            value converted to the base type and wrapped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_BaseValue</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">_BaseValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_to_base_type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_call_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call all ``_from_base_type()`` methods on the value.</span>

<span class="sd">        This calls the methods in the reverse method resolution order of</span>
<span class="sd">        the property&#39;s class.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Any): The value to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The transformed ``value``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_methods</span><span class="p">(</span><span class="s2">&quot;_from_base_type&quot;</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_list</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">call</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_call_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call all ``_validate()`` and ``_to_base_type()`` methods on value.</span>

<span class="sd">        This calls the methods in the method resolution order of the</span>
<span class="sd">        property&#39;s class. For example, given the hierarchy</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            class A(Property):</span>
<span class="sd">                def _validate(self, value):</span>
<span class="sd">                    ...</span>
<span class="sd">                def _to_base_type(self, value):</span>
<span class="sd">                    ...</span>

<span class="sd">            class B(A):</span>
<span class="sd">                def _validate(self, value):</span>
<span class="sd">                    ...</span>
<span class="sd">                def _to_base_type(self, value):</span>
<span class="sd">                    ...</span>

<span class="sd">            class C(B):</span>
<span class="sd">                def _validate(self, value):</span>
<span class="sd">                    ...</span>

<span class="sd">        the full list of methods (in order) is:</span>

<span class="sd">        * ``C._validate()``</span>
<span class="sd">        * ``B._validate()``</span>
<span class="sd">        * ``B._to_base_type()``</span>
<span class="sd">        * ``A._validate()``</span>
<span class="sd">        * ``A._to_base_type()``</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Any): The value to be converted / validated.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The transformed ``value``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_methods</span><span class="p">(</span><span class="s2">&quot;_validate&quot;</span><span class="p">,</span> <span class="s2">&quot;_to_base_type&quot;</span><span class="p">)</span>
        <span class="n">call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_list</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">call</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_call_shallow_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call the &quot;initial&quot; set of ``_validate()`` methods.</span>

<span class="sd">        This is similar to :meth:`_call_to_base_type` except it only calls</span>
<span class="sd">        those ``_validate()`` methods that can be called without needing to</span>
<span class="sd">        call ``_to_base_type()``.</span>

<span class="sd">        An example: suppose the class hierarchy is</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            class A(Property):</span>
<span class="sd">                def _validate(self, value):</span>
<span class="sd">                    ...</span>
<span class="sd">                def _to_base_type(self, value):</span>
<span class="sd">                    ...</span>

<span class="sd">            class B(A):</span>
<span class="sd">                def _validate(self, value):</span>
<span class="sd">                    ...</span>
<span class="sd">                def _to_base_type(self, value):</span>
<span class="sd">                    ...</span>

<span class="sd">            class C(B):</span>
<span class="sd">                def _validate(self, value):</span>
<span class="sd">                    ...</span>

<span class="sd">        The full list of methods (in order) called by</span>
<span class="sd">        :meth:`_call_to_base_type` is:</span>

<span class="sd">        * ``C._validate()``</span>
<span class="sd">        * ``B._validate()``</span>
<span class="sd">        * ``B._to_base_type()``</span>
<span class="sd">        * ``A._validate()``</span>
<span class="sd">        * ``A._to_base_type()``</span>

<span class="sd">        whereas the full list of methods (in order) called here stops once</span>
<span class="sd">        a ``_to_base_type()`` method is encountered:</span>

<span class="sd">        * ``C._validate()``</span>
<span class="sd">        * ``B._validate()``</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Any): The value to be converted / validated.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The transformed ``value``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_methods</span><span class="p">(</span><span class="s2">&quot;_validate&quot;</span><span class="p">,</span> <span class="s2">&quot;_to_base_type&quot;</span><span class="p">):</span>
            <span class="c1"># Stop if ``_to_base_type()`` is encountered.</span>
            <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s2">&quot;_validate&quot;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

        <span class="n">call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_list</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">call</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_find_methods</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute a list of composable methods.</span>

<span class="sd">        Because this is a common operation and the class hierarchy is</span>
<span class="sd">        static, the outcome is cached (assuming that for a particular list</span>
<span class="sd">        of names the reversed flag is either always on, or always off).</span>

<span class="sd">        Args:</span>
<span class="sd">            names (Tuple[str, ...]): One or more method names to look up on</span>
<span class="sd">                the current class or base classes.</span>
<span class="sd">            reverse (bool): Optional flag, default False; if True, the list is</span>
<span class="sd">              reversed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Callable]: Class method objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get cache on current class / set cache if it doesn&#39;t exist.</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_FIND_METHODS_CACHE</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">hit</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">hit</span>

        <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

        <span class="n">cache</span><span class="p">[</span><span class="n">names</span><span class="p">]</span> <span class="o">=</span> <span class="n">methods</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">methods</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">methods</span>

    <span class="k">def</span> <span class="nf">_apply_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methods</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Chain together a list of callables for transforming a value.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Each callable in ``methods`` is an unbound instance method, e.g.</span>
<span class="sd">            accessed via ``Property.foo`` rather than ``instance.foo``.</span>
<span class="sd">            Therefore, calling these methods will require ``self`` as the</span>
<span class="sd">            first argument.</span>

<span class="sd">        If one of the method returns :data:`None`, the previous value is kept;</span>
<span class="sd">        otherwise the last value is replace.</span>

<span class="sd">        Exceptions thrown by a method in ``methods`` are not caught, so it</span>
<span class="sd">        is up to the caller to catch them.</span>

<span class="sd">        Args:</span>
<span class="sd">            methods (Iterable[Callable[[Any], Any]]): An iterable of methods</span>
<span class="sd">                to apply to a value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Callable[[Any], Any]: A callable that takes a single value and</span>
<span class="sd">            applies each method in ``methods`` to it.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">new_value</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">call</span>

    <span class="k">def</span> <span class="nf">_apply_to_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply a function to the property value / values of a given entity.</span>

<span class="sd">        This retrieves the property value, applies the function, and then</span>
<span class="sd">        stores the value back. For a repeated property, the function is</span>
<span class="sd">        applied separately to each of the values in the list. The</span>
<span class="sd">        resulting value or list of values is both stored back in the</span>
<span class="sd">        entity and returned from this method.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to get a value from.</span>
<span class="sd">            function (Callable[[Any], Any]): A transformation to apply to</span>
<span class="sd">                the value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The transformed value store on the entity for this property.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># NOTE: This assumes, but does not check, that ``value`` is</span>
                <span class="c1">#       iterable. This relies on ``_set_value`` having checked</span>
                <span class="c1">#       and converted to a ``list`` for a repeated property.</span>
                <span class="n">value</span><span class="p">[:]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">new_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">new_value</span>

        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the value for this property from an entity.</span>

<span class="sd">        For a repeated property this initializes the value to an empty</span>
<span class="sd">        list if it is not set.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to get a value from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The user value stored for the current property.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UnprojectedPropertyError: If the ``entity`` is the result of a</span>
<span class="sd">                projection query and the current property is not one of the</span>
<span class="sd">                projected properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnprojectedPropertyError</span><span class="p">(</span>
                    <span class="s2">&quot;Property </span><span class="si">{}</span><span class="s2"> is not in the projection&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_delete_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the value for this property from an entity.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If no value exists this is a no-op; deleted values will not be</span>
<span class="sd">            serialized but requesting their value will return :data:`None` (or</span>
<span class="sd">            an empty list in the case of a repeated property).</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to get a value from.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_values</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">entity</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_is_initialized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ask if the entity has a value for this property.</span>

<span class="sd">        This returns :data:`False` if a value is stored but the stored value</span>
<span class="sd">        is :data:`None`.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to get a value from.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_has_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Property.__get__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Property.__get__">[docs]</a>    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">unused_cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Descriptor protocol: get the value from the entity.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to get a value from.</span>
<span class="sd">            unused_cls (type): The class that owns this instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">entity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Handle the case where ``__get__`` is called on the class</span>
            <span class="c1"># rather than an instance.</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span></div>

<div class="viewcode-block" id="Property.__set__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Property.__set__">[docs]</a>    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Descriptor protocol: set the value on the entity.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to set a value on.</span>
<span class="sd">            value (Any): The value to set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Property.__delete__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Property.__delete__">[docs]</a>    <span class="k">def</span> <span class="nf">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Descriptor protocol: delete the value from the entity.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to delete a value from.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_serialize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">pb</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">parent_repeated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Serialize this property to a protocol buffer.</span>

<span class="sd">        Some subclasses may override this method.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): The entity that owns this property.</span>
<span class="sd">            pb (google.cloud.datastore_v1.proto.entity_pb2.Entity): An existing</span>
<span class="sd">                entity protobuf instance that we&#39;ll add a value to.</span>
<span class="sd">            prefix (Optional[str]): Name prefix used for</span>
<span class="sd">                :class:`StructuredProperty` (if present, must end in ``.``).</span>
<span class="sd">            parent_repeated (Optional[bool]): Indicates if the parent (or an</span>
<span class="sd">                earlier ancestor) is a repeated property.</span>
<span class="sd">            projection (Optional[Union[list, tuple]]): An iterable of strings</span>
<span class="sd">                representing the projection for the model instance, or</span>
<span class="sd">                :data:`None` if the instance is not a projection.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. No longer implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_deserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">unused_depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deserialize this property from a protocol buffer.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. This method is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

<div class="viewcode-block" id="Property._prepare_for_put"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Property._prepare_for_put">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_for_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow this property to define a pre-put hook.</span>

<span class="sd">        This base class implementation does nothing, but subclasses may</span>
<span class="sd">        provide hooks.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity with values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_check_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rest</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">require_indexed</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check this property for specific requirements.</span>

<span class="sd">        Called by ``Model._check_properties()``.</span>

<span class="sd">        Args:</span>
<span class="sd">            rest: Optional subproperty to check, of the form</span>
<span class="sd">                ``name1.name2...nameN``.</span>
<span class="sd">            required_indexed (bool): Indicates if the current property must</span>
<span class="sd">                be indexed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            InvalidPropertyError: If ``require_indexed`` is :data:`True`</span>
<span class="sd">                but the current property is not indexed.</span>
<span class="sd">            InvalidPropertyError: If a subproperty is specified via ``rest``</span>
<span class="sd">                (:class:`StructuredProperty` overrides this method to handle</span>
<span class="sd">                subproperties).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">require_indexed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidPropertyError</span><span class="p">(</span>
                <span class="s2">&quot;Property is unindexed </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">rest</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidPropertyError</span><span class="p">(</span>
                <span class="s2">&quot;Referencing subproperty </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> but </span><span class="si">{}</span><span class="s2"> is not a structured &quot;</span>
                <span class="s2">&quot;property&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">rest</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_for_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the value like ``_get_value()``.</span>

<span class="sd">        This is intended to be processed for ``_to_dict()``.</span>

<span class="sd">        Property subclasses can override this if they want the dictionary</span>
<span class="sd">        returned by ``entity._to_dict()`` to contain a different value. The</span>
<span class="sd">        main use case is allowing :class:`StructuredProperty` and</span>
<span class="sd">        :class:`LocalStructuredProperty` to allow the default ``_get_value()``</span>
<span class="sd">        behavior.</span>

<span class="sd">        * If you override ``_get_for_dict()`` to return a different type, you</span>
<span class="sd">          must override ``_validate()`` to accept values of that type and</span>
<span class="sd">          convert them back to the original type.</span>

<span class="sd">        * If you override ``_get_for_dict()``, you must handle repeated values</span>
<span class="sd">          and :data:`None` correctly. However, ``_validate()`` does not need to</span>
<span class="sd">          handle these.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to get a value from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The user value stored for the current property.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_validate_key</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate a key.</span>

<span class="sd">    Args:</span>
<span class="sd">        value (.Key): The key to be validated.</span>
<span class="sd">        entity (Optional[Model]): The entity that the key is being validated</span>
<span class="sd">            for.</span>

<span class="sd">    Returns:</span>
<span class="sd">        .Key: The passed in ``value``.</span>

<span class="sd">    Raises:</span>
<span class="sd">        .BadValueError: If ``value`` is not a :class:`.Key`.</span>
<span class="sd">        KindError: If ``entity`` is specified, but the kind of the entity</span>
<span class="sd">            doesn&#39;t match the kind of ``value``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s2">&quot;Expected Key, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">entity</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">Expando</span><span class="p">):</span>
        <span class="c1"># Need to use _class_name instead of _get_kind, to be able to</span>
        <span class="c1"># return the correct kind if this is a polymodel</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span> <span class="o">!=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_class_name</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span>
                <span class="s2">&quot;Expected Key kind to be </span><span class="si">{}</span><span class="s2">; received &quot;</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_class_name</span><span class="p">(),</span> <span class="n">value</span><span class="o">.</span><span class="n">kind</span><span class="p">())</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">value</span>


<div class="viewcode-block" id="ModelKey"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.ModelKey">[docs]</a><span class="k">class</span> <span class="nc">ModelKey</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Special property to store a special &quot;key&quot; for a :class:`Model`.</span>

<span class="sd">    This is intended to be used as a psuedo-:class:`Property` on each</span>
<span class="sd">    :class:`Model` subclass. It is **not** intended for other usage in</span>
<span class="sd">    application code.</span>

<span class="sd">    It allows key-only queries to be done for a given kind.</span>

<span class="sd">    .. automethod:: _validate</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelKey</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;__key__&quot;</span>

    <span class="k">def</span> <span class="nf">_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal helper for comparison operators.</span>

<span class="sd">        This uses the base implementation in :class:`Property`, but doesn&#39;t</span>
<span class="sd">        allow comparison to :data:`None`.</span>

<span class="sd">        Args:</span>
<span class="sd">            op (str): The comparison operator. One of ``=``, ``!=``, ``&lt;``,</span>
<span class="sd">                ``&lt;=``, ``&gt;``, ``&gt;=`` or ``in``.</span>
<span class="sd">            value (Any): The value to compare against.</span>

<span class="sd">        Returns:</span>
<span class="sd">            FilterNode: A FilterNode instance representing the requested</span>
<span class="sd">            comparison.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadValueError: If ``value`` is :data:`None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ModelKey</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
            <span class="s2">&quot;__key__ filter query can&#39;t be compared to None&quot;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ModelKey._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.ModelKey._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (.Key): The value to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            .Key: The passed-in ``value``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_validate_key</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_set_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the entity key on an entity.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to set the entity key on.</span>
<span class="sd">            value (.Key): The key to be set on the entity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">_validate_key</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="n">entity</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_validate_key</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">entity</span><span class="o">.</span><span class="n">_entity_key</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the entity key from an entity.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to get the entity key from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            .Key: The entity key stored on ``entity``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_entity_key</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_delete_value</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove / disassociate the entity key from an entity.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity to remove the entity key from.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_entity_key</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="BooleanProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.BooleanProperty">[docs]</a><span class="k">class</span> <span class="nc">BooleanProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property that contains values of type bool.</span>

<span class="sd">    .. automethod:: _validate</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="BooleanProperty._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.BooleanProperty._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (bool): The value to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: The passed-in ``value``.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadValueError: If ``value`` is not a :class:`bool`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected bool, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>

    <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_serialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. No longer implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_deserialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. This method is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="IntegerProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.IntegerProperty">[docs]</a><span class="k">class</span> <span class="nc">IntegerProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property that contains values of type integer.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If a value is a :class:`bool`, it will be coerced to ``0`` (for</span>
<span class="sd">        :data:`False`) or ``1`` (for :data:`True`).</span>

<span class="sd">    .. automethod:: _validate</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="IntegerProperty._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.IntegerProperty._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Union[int, bool]): The value to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The passed-in ``value``.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadValueError: If ``value`` is not an :class:`int` or convertible</span>
<span class="sd">                to one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected integer, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_serialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. No longer implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_deserialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. This method is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="FloatProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.FloatProperty">[docs]</a><span class="k">class</span> <span class="nc">FloatProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property that contains values of type float.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If a value is a :class:`bool` or :class:`int`, it will be</span>
<span class="sd">        coerced to a floating point value.</span>

<span class="sd">    .. automethod:: _validate</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="FloatProperty._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.FloatProperty._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Union[float, int, bool]): The value to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The passed-in ``value``, possibly converted to a</span>
<span class="sd">            :class:`float`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadValueError: If ``value`` is not a :class:`float` or convertible</span>
<span class="sd">                to one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected float, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_serialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. No longer implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_deserialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. This method is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span></div>


<span class="k">class</span> <span class="nc">_CompressedValue</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A marker object wrapping compressed values.</span>

<span class="sd">    Args:</span>
<span class="sd">        z_val (bytes): A return value of ``zlib.compress``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;z_val&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_val</span> <span class="o">=</span> <span class="n">z_val</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;_CompressedValue(</span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare two compressed values.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_CompressedValue</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_val</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">z_val</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;_CompressedValue is not immutable&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="BlobProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.BlobProperty">[docs]</a><span class="k">class</span> <span class="nc">BlobProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property that contains values that are byte strings.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Unlike most property types, a :class:`BlobProperty` is **not**</span>
<span class="sd">        indexed by default.</span>

<span class="sd">    .. automethod:: _to_base_type</span>
<span class="sd">    .. automethod:: _from_base_type</span>
<span class="sd">    .. automethod:: _validate</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): The name of the property.</span>
<span class="sd">        compressed (bool): Indicates if the value should be compressed (via</span>
<span class="sd">            ``zlib``).</span>
<span class="sd">        indexed (bool): Indicates if the value should be indexed.</span>
<span class="sd">        repeated (bool): Indicates if this property is repeated, i.e. contains</span>
<span class="sd">            multiple values.</span>
<span class="sd">        required (bool): Indicates if this property is required on the given</span>
<span class="sd">            model type.</span>
<span class="sd">        default (bytes): The default value for this property.</span>
<span class="sd">        choices (Iterable[bytes]): A container of allowed values for this</span>
<span class="sd">            property.</span>
<span class="sd">        validator (Callable[[~google.cloud.ndb.model.Property, Any], bool]): A</span>
<span class="sd">            validator to be used to check values.</span>
<span class="sd">        verbose_name (str): A longer, user-friendly name for this property.</span>
<span class="sd">        write_empty_list (bool): Indicates if an empty list should be written</span>
<span class="sd">            to the datastore.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: If the property is both compressed and indexed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_indexed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_compressed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">compressed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">indexed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">repeated</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">write_empty_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BlobProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">indexed</span><span class="o">=</span><span class="n">indexed</span><span class="p">,</span>
            <span class="n">repeated</span><span class="o">=</span><span class="n">repeated</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="n">required</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="n">choices</span><span class="p">,</span>
            <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">verbose_name</span><span class="p">,</span>
            <span class="n">write_empty_list</span><span class="o">=</span><span class="n">write_empty_list</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">compressed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="o">=</span> <span class="n">compressed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;BlobProperty </span><span class="si">{}</span><span class="s2"> cannot be compressed and &quot;</span>
                <span class="s2">&quot;indexed at the same time.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_value_to_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn the value into a user friendly representation.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This will truncate the value based on the &quot;visual&quot; length, e.g.</span>
<span class="sd">            if it contains many ``\\xXX`` or ``\\uUUUU`` sequences, those</span>
<span class="sd">            will count against the length as more than one character.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Any): The value to convert to a pretty-print ``repr``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The ``repr`` of the &quot;true&quot; value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">long_repr</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">BlobProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_value_to_repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">long_repr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_MAX_STRING_LENGTH</span> <span class="o">+</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># Truncate, assuming the final character is the closing quote.</span>
            <span class="n">long_repr</span> <span class="o">=</span> <span class="n">long_repr</span><span class="p">[:</span><span class="n">_MAX_STRING_LENGTH</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="o">+</span> <span class="n">long_repr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">long_repr</span>

<div class="viewcode-block" id="BlobProperty._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.BlobProperty._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (bytes): The value to check.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadValueError: If ``value`` is not a :class:`bytes`.</span>
<span class="sd">            .BadValueError: If the current property is indexed but the value</span>
<span class="sd">                exceeds the maximum length (1500 bytes).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected bytes, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_MAX_STRING_LENGTH</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Indexed value </span><span class="si">{}</span><span class="s2"> must be at most </span><span class="si">{:d}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;bytes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">_MAX_STRING_LENGTH</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="BlobProperty._to_base_type"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.BlobProperty._to_base_type">[docs]</a>    <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value to the &quot;base&quot; value type for this property.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (bytes): The value to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[bytes]: The converted value. If the current property is</span>
<span class="sd">            compressed, this will return a wrapped version of the compressed</span>
<span class="sd">            value. Otherwise, it will return :data:`None` to indicate that</span>
<span class="sd">            the value didn&#39;t need to be converted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_CompressedValue</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">value</span><span class="p">))</span></div>

<div class="viewcode-block" id="BlobProperty._from_base_type"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.BlobProperty._from_base_type">[docs]</a>    <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value from the &quot;base&quot; value type for this property.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (bytes): The value to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[bytes]: The converted value. If the current property is</span>
<span class="sd">            a (wrapped) compressed value, this will unwrap the value and return</span>
<span class="sd">            the decompressed form. Otherwise, it will return :data:`None` to</span>
<span class="sd">            indicate that the value didn&#39;t need to be unwrapped and</span>
<span class="sd">            decompressed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_CompressedValue</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">z_val</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_serialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. No longer implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_db_set_compressed_meaning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_db_set_value`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. No longer implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_db_set_uncompressed_meaning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_db_set_value`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. No longer implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_deserialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. This method is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="TextProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.TextProperty">[docs]</a><span class="k">class</span> <span class="nc">TextProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An unindexed property that contains UTF-8 encoded text values.</span>

<span class="sd">    A :class:`TextProperty` is intended for values of unlimited length, hence</span>
<span class="sd">    is **not** indexed. Previously, a :class:`TextProperty` could be indexed</span>
<span class="sd">    via:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        class Item(ndb.Model):</span>
<span class="sd">            description = ndb.TextProperty(indexed=True)</span>
<span class="sd">            ...</span>

<span class="sd">    but this usage is no longer supported. If indexed text is desired, a</span>
<span class="sd">    :class:`StringProperty` should be used instead.</span>

<span class="sd">    .. automethod:: _to_base_type</span>
<span class="sd">    .. automethod:: _from_base_type</span>
<span class="sd">    .. automethod:: _validate</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: If ``indexed=True`` is provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">indexed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;indexed&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">indexed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;A TextProperty cannot be indexed. Previously this was &quot;</span>
                <span class="s2">&quot;allowed, but this usage is no longer supported.&quot;</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TextProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_constructor_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`__repr__`.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Tuple[str, bool]: Pairs of argument name and a boolean indicating</span>
<span class="sd">            if that argument is a keyword.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parent_init</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">TextProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">parent_init</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;indexed&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">is_keyword</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">KEYWORD_ONLY</span>
            <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">is_keyword</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_indexed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;bool: Indicates that the property is not indexed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="TextProperty._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.TextProperty._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Union[bytes, str]): The value to check.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadValueError: If ``value`` is :class:`bytes`, but is not a valid</span>
<span class="sd">                UTF-8 encoded string.</span>
<span class="sd">            .BadValueError: If ``value`` is neither :class:`bytes` nor</span>
<span class="sd">                :class:`str`.</span>
<span class="sd">            .BadValueError: If the current property is indexed but the UTF-8</span>
<span class="sd">                encoded value exceeds the maximum length (1500 bytes).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">encoded_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Expected valid UTF-8, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">encoded_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected string, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="ow">and</span> <span class="n">encoded_length</span> <span class="o">&gt;</span> <span class="n">_MAX_STRING_LENGTH</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Indexed value </span><span class="si">{}</span><span class="s2"> must be at most </span><span class="si">{:d}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;bytes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">_MAX_STRING_LENGTH</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="TextProperty._to_base_type"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.TextProperty._to_base_type">[docs]</a>    <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value to the &quot;base&quot; value type for this property.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Union[bytes, str]): The value to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: The converted value. If ``value`` is a</span>
<span class="sd">            :class:`bytes`, this will return the UTF-8 decoded ``str`` for it.</span>
<span class="sd">            Otherwise, it will return :data:`None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TextProperty._from_base_type"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.TextProperty._from_base_type">[docs]</a>    <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value from the &quot;base&quot; value type for this property.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Older versions of ``ndb`` could write non-UTF-8 ``TEXT``</span>
<span class="sd">            properties. This means that if ``value`` is :class:`bytes`, but is</span>
<span class="sd">            not a valid UTF-8 encoded string, it can&#39;t (necessarily) be</span>
<span class="sd">            rejected. But, :meth:`_validate` now rejects such values, so it&#39;s</span>
<span class="sd">            not possible to write new non-UTF-8 ``TEXT`` properties.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Union[bytes, str]): The value to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: The converted value. If ``value`` is a a valid UTF-8</span>
<span class="sd">            encoded :class:`bytes` string, this will return the decoded</span>
<span class="sd">            :class:`str` corresponding to it. Otherwise, it will return</span>
<span class="sd">            :data:`None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
                <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_db_set_uncompressed_meaning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_db_set_value`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. No longer implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="StringProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.StringProperty">[docs]</a><span class="k">class</span> <span class="nc">StringProperty</span><span class="p">(</span><span class="n">TextProperty</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An indexed property that contains UTF-8 encoded text values.</span>

<span class="sd">    This is nearly identical to :class:`TextProperty`, but is indexed. Values</span>
<span class="sd">    must be at most 1500 bytes (when UTF-8 encoded from :class:`str` to bytes).</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: If ``indexed=False`` is provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">indexed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;indexed&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">indexed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;A StringProperty must be indexed. Previously setting &quot;</span>
                <span class="s2">&quot;``indexed=False`` was allowed, but this usage is no longer &quot;</span>
                <span class="s2">&quot;supported.&quot;</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">StringProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_indexed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;bool: Indicates that the property is indexed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="GeoPtProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.GeoPtProperty">[docs]</a><span class="k">class</span> <span class="nc">GeoPtProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property that contains :attr:`.GeoPt` values.</span>

<span class="sd">    .. automethod:: _validate</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="GeoPtProperty._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.GeoPtProperty._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (~google.cloud.datastore.helpers.GeoPoint): The value to</span>
<span class="sd">                check.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadValueError: If ``value`` is not a :attr:`.GeoPt`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">GeoPt</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected GeoPt, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_serialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. No longer implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_deserialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. This method is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="PickleProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.PickleProperty">[docs]</a><span class="k">class</span> <span class="nc">PickleProperty</span><span class="p">(</span><span class="n">BlobProperty</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property that contains values that are pickle-able.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Unlike most property types, a :class:`PickleProperty` is **not**</span>
<span class="sd">        indexed by default.</span>

<span class="sd">    This will use :func:`pickle.dumps` with the highest available pickle</span>
<span class="sd">    protocol to convert to bytes and :func:`pickle.loads` to convert **from**</span>
<span class="sd">    bytes. The base value stored in the datastore will be the pickled bytes.</span>

<span class="sd">    .. automethod:: _to_base_type</span>
<span class="sd">    .. automethod:: _from_base_type</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="PickleProperty._to_base_type"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.PickleProperty._to_base_type">[docs]</a>    <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value to the &quot;base&quot; value type for this property.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Any): The value to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bytes: The pickled ``value``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span></div>

<div class="viewcode-block" id="PickleProperty._from_base_type"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.PickleProperty._from_base_type">[docs]</a>    <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value from the &quot;base&quot; value type for this property.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (bytes): The value to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The unpickled ``value``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="JsonProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.JsonProperty">[docs]</a><span class="k">class</span> <span class="nc">JsonProperty</span><span class="p">(</span><span class="n">BlobProperty</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property that contains JSON-encodable values.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Unlike most property types, a :class:`JsonProperty` is **not**</span>
<span class="sd">        indexed by default.</span>

<span class="sd">    .. automethod:: _to_base_type</span>
<span class="sd">    .. automethod:: _from_base_type</span>
<span class="sd">    .. automethod:: _validate</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): The name of the property.</span>
<span class="sd">        compressed (bool): Indicates if the value should be compressed (via</span>
<span class="sd">            ``zlib``).</span>
<span class="sd">        json_type (type): The expected type of values that this property can</span>
<span class="sd">            hold. If :data:`None`, any type is allowed.</span>
<span class="sd">        indexed (bool): Indicates if the value should be indexed.</span>
<span class="sd">        repeated (bool): Indicates if this property is repeated, i.e. contains</span>
<span class="sd">            multiple values.</span>
<span class="sd">        required (bool): Indicates if this property is required on the given</span>
<span class="sd">            model type.</span>
<span class="sd">        default (Any): The default value for this property.</span>
<span class="sd">        choices (Iterable[Any]): A container of allowed values for this</span>
<span class="sd">            property.</span>
<span class="sd">        validator (Callable[[~google.cloud.ndb.model.Property, Any], bool]): A</span>
<span class="sd">            validator to be used to check values.</span>
<span class="sd">        verbose_name (str): A longer, user-friendly name for this property.</span>
<span class="sd">        write_empty_list (bool): Indicates if an empty list should be written</span>
<span class="sd">            to the datastore.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_json_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">compressed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">json_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">indexed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">repeated</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">write_empty_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">JsonProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">,</span>
            <span class="n">indexed</span><span class="o">=</span><span class="n">indexed</span><span class="p">,</span>
            <span class="n">repeated</span><span class="o">=</span><span class="n">repeated</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="n">required</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="n">choices</span><span class="p">,</span>
            <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">verbose_name</span><span class="p">,</span>
            <span class="n">write_empty_list</span><span class="o">=</span><span class="n">write_empty_list</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">json_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_json_type</span> <span class="o">=</span> <span class="n">json_type</span>

<div class="viewcode-block" id="JsonProperty._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.JsonProperty._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Any): The value to check.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the current property has a JSON type set and</span>
<span class="sd">                ``value`` is not an instance of that type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_type</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;JSON property must be a </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_json_type</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="JsonProperty._to_base_type"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.JsonProperty._to_base_type">[docs]</a>    <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value to the &quot;base&quot; value type for this property.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Any): The value to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bytes: The ``value``, JSON encoded as an ASCII byte string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">as_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">as_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="JsonProperty._from_base_type"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.JsonProperty._from_base_type">[docs]</a>    <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value from the &quot;base&quot; value type for this property.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (bytes): The value to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The ``value`` (ASCII bytes or string) loaded as JSON.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="User"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.User">[docs]</a><span class="nd">@functools</span><span class="o">.</span><span class="n">total_ordering</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Provides the email address, nickname, and ID for a Google Accounts user.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This class is a port of ``google.appengine.api.users.User``.</span>
<span class="sd">        In the (legacy) Google App Engine standard environment, this</span>
<span class="sd">        constructor relied on several environment variables to provide a</span>
<span class="sd">        fallback for inputs. In particular:</span>

<span class="sd">        * ``AUTH_DOMAIN`` for the ``_auth_domain`` argument</span>
<span class="sd">        * ``USER_EMAIL`` for the ``email`` argument</span>
<span class="sd">        * ``USER_ID`` for the ``_user_id`` argument</span>
<span class="sd">        * ``FEDERATED_IDENTITY`` for the (now removed) ``federated_identity``</span>
<span class="sd">          argument</span>
<span class="sd">        * ``FEDERATED_PROVIDER`` for the (now removed) ``federated_provider``</span>
<span class="sd">          argument</span>

<span class="sd">        However in the gVisor Google App Engine runtime (e.g. Python 3.7),</span>
<span class="sd">        none of these environment variables will be populated.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Previous versions of the Google Cloud Datastore API had an explicit</span>
<span class="sd">        ``UserValue`` field. However, the ``google.datastore.v1`` API returns</span>
<span class="sd">        previously stored user values as an ``Entity`` with the meaning set to</span>
<span class="sd">        ``ENTITY_USER=20``.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        The ``federated_identity`` and ``federated_provider`` are</span>
<span class="sd">        decommissioned and have been removed from the constructor. Additionally</span>
<span class="sd">        ``_strict_mode`` has been removed from the constructor and the</span>
<span class="sd">        ``federated_identity()`` and ``federated_provider()`` methods have been</span>
<span class="sd">        removed from this class.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): The user&#39;s email address.</span>
<span class="sd">        _auth_domain (str): The auth domain for the current application.</span>
<span class="sd">        _user_id (str): The user ID.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the ``_auth_domain`` is not passed in.</span>
<span class="sd">        UserNotFoundError: If ``email`` is empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_auth_domain&quot;</span><span class="p">,</span> <span class="s2">&quot;_email&quot;</span><span class="p">,</span> <span class="s2">&quot;_user_id&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_auth_domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_auth_domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;_auth_domain is required&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserNotFoundError</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_auth_domain</span> <span class="o">=</span> <span class="n">_auth_domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_email</span> <span class="o">=</span> <span class="n">email</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span> <span class="o">=</span> <span class="n">_user_id</span>

<div class="viewcode-block" id="User.nickname"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.User.nickname">[docs]</a>    <span class="k">def</span> <span class="nf">nickname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The nickname for this user.</span>

<span class="sd">        A nickname is a human-readable string that uniquely identifies a Google</span>
<span class="sd">        user with respect to this application, akin to a username. For some</span>
<span class="sd">        users, this nickname is an email address or part of the email address.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The nickname of the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_email</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_domain</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_email</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_domain</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">suffix_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth_domain</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_email</span><span class="p">[:</span><span class="o">-</span><span class="n">suffix_len</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_email</span></div>

<div class="viewcode-block" id="User.email"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.User.email">[docs]</a>    <span class="k">def</span> <span class="nf">email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the user&#39;s email address.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_email</span></div>

<div class="viewcode-block" id="User.user_id"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.User.user_id">[docs]</a>    <span class="k">def</span> <span class="nf">user_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtains the user ID of the user.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: A permanent unique identifying string or</span>
<span class="sd">            :data:`None`. If the email address was set explicity, this will</span>
<span class="sd">            return :data:`None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span></div>

<div class="viewcode-block" id="User.auth_domain"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.User.auth_domain">[docs]</a>    <span class="k">def</span> <span class="nf">auth_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtains the user&#39;s authentication domain.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The authentication domain. This method is internal and</span>
<span class="sd">            should not be used by client applications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_domain</span></div>

<div class="viewcode-block" id="User.add_to_entity"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.User.add_to_entity">[docs]</a>    <span class="k">def</span> <span class="nf">add_to_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the user value to a datastore entity.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This assumes, but does not check, that ``name`` is not already</span>
<span class="sd">            set on ``entity`` or in the meanings of ``entity``.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (~google.cloud.datastore.entity.Entity): An entity that</span>
<span class="sd">                contains a user value as the field ``name``.</span>
<span class="sd">            name (str): The name of the field containing this user value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_entity</span> <span class="o">=</span> <span class="n">entity_module</span><span class="o">.</span><span class="n">Entity</span><span class="p">()</span>
        <span class="n">entity</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_entity</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_meanings</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_MEANING_PREDEFINED_ENTITY_USER</span><span class="p">,</span> <span class="n">user_entity</span><span class="p">)</span>

        <span class="c1"># Set required fields.</span>
        <span class="n">user_entity</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_email</span>
        <span class="n">user_entity</span><span class="o">.</span><span class="n">exclude_from_indexes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">)</span>
        <span class="n">user_entity</span><span class="p">[</span><span class="s2">&quot;auth_domain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_domain</span>
        <span class="n">user_entity</span><span class="o">.</span><span class="n">exclude_from_indexes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;auth_domain&quot;</span><span class="p">)</span>
        <span class="c1"># Set optional field.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span><span class="p">:</span>
            <span class="n">user_entity</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span>
            <span class="n">user_entity</span><span class="o">.</span><span class="n">exclude_from_indexes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="User.read_from_entity"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.User.read_from_entity">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">read_from_entity</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the user value to a datastore entity.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (~google.cloud.datastore.entity.Entity): An entity that</span>
<span class="sd">                contains a user value as the field ``name``.</span>
<span class="sd">            name (str): The name of the field containing this user value.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the stored meaning for the ``name`` field is not</span>
<span class="sd">                equal to ``ENTITY_USER=20``.</span>
<span class="sd">            ValueError: If the value stored in the meanings for ``entity``</span>
<span class="sd">                is not the actual stored value under ``name``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: This may fail in a ``KeyError``.</span>
        <span class="n">user_entity</span> <span class="o">=</span> <span class="n">entity</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="c1"># NOTE: This may result in a ``ValueError`` for failed unpacking.</span>
        <span class="n">meaning</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_meanings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">meaning</span> <span class="o">!=</span> <span class="n">_MEANING_PREDEFINED_ENTITY_USER</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;User values should have meaning=20&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_entity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected value stored for meaning&quot;</span><span class="p">)</span>

        <span class="c1"># NOTE: We do not check ``exclude_from_indexes``.</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user_entity</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
            <span class="s2">&quot;_auth_domain&quot;</span><span class="p">:</span> <span class="n">user_entity</span><span class="p">[</span><span class="s2">&quot;auth_domain&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;user_id&quot;</span> <span class="ow">in</span> <span class="n">user_entity</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_user_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_entity</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nickname</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;email=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_email</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span><span class="p">:</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;_user_id=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;users.User(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_email</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_domain</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">User</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_email</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_email</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_domain</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_auth_domain</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">User</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_email</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_domain</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span>
            <span class="n">other</span><span class="o">.</span><span class="n">_email</span><span class="p">,</span>
            <span class="n">other</span><span class="o">.</span><span class="n">_auth_domain</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="UserProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.UserProperty">[docs]</a><span class="k">class</span> <span class="nc">UserProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property that contains :class:`.User` values.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        This exists for backwards compatibility with existing Cloud Datastore</span>
<span class="sd">        schemas only; storing :class:`.User` objects directly in Cloud</span>
<span class="sd">        Datastore is not recommended.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        The ``auto_current_user`` and ``auto_current_user_add`` arguments are</span>
<span class="sd">        no longer supported.</span>

<span class="sd">    .. note::</span>

<span class="sd">        On Google App Engine standard, after saving a :class:`User` the user ID</span>
<span class="sd">        would automatically be populated by the datastore, even if it wasn&#39;t</span>
<span class="sd">        set in the :class:`User` value being stored. For example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; class Simple(ndb.Model):</span>
<span class="sd">            ...     u = ndb.UserProperty()</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; entity = Simple(u=users.User(&quot;user@example.com&quot;))</span>
<span class="sd">            &gt;&gt;&gt; entity.u.user_id() is None</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; entity.put()</span>
<span class="sd">            &gt;&gt;&gt; # Reload without the cached values</span>
<span class="sd">            &gt;&gt;&gt; entity = entity.key.get(use_cache=False, use_memcache=False)</span>
<span class="sd">            &gt;&gt;&gt; entity.u.user_id()</span>
<span class="sd">            &#39;...9174...&#39;</span>

<span class="sd">        However in the gVisor Google App Engine runtime (e.g. Python 3.7),</span>
<span class="sd">        this will behave differently. The user ID will only be stored if it</span>
<span class="sd">        is manually set in the :class:`User` instance, either by the running</span>
<span class="sd">        application or by retrieving a stored :class:`User` that already has</span>
<span class="sd">        a user ID set.</span>

<span class="sd">    .. automethod:: _validate</span>
<span class="sd">    .. automethod:: _prepare_for_put</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): The name of the property.</span>
<span class="sd">        auto_current_user (bool): Deprecated flag. When supported, if this flag</span>
<span class="sd">            was set to :data:`True`, the property value would be set to the</span>
<span class="sd">            currently signed-in user whenever the model instance is stored in</span>
<span class="sd">            the datastore, overwriting the property&#39;s previous value.</span>
<span class="sd">            This was useful for tracking which user modifies a model instance.</span>
<span class="sd">        auto_current_user_add (bool): Deprecated flag. When supported, if this</span>
<span class="sd">            flag was set to :data:`True`, the property value would be set to</span>
<span class="sd">            the urrently signed-in user he first time the model instance is</span>
<span class="sd">            stored in the datastore, unless the property has already been</span>
<span class="sd">            assigned a value. This was useful for tracking which user creates</span>
<span class="sd">            a model instance, which may not be the same user that modifies it</span>
<span class="sd">            later.</span>
<span class="sd">        indexed (bool): Indicates if the value should be indexed.</span>
<span class="sd">        repeated (bool): Indicates if this property is repeated, i.e. contains</span>
<span class="sd">            multiple values.</span>
<span class="sd">        required (bool): Indicates if this property is required on the given</span>
<span class="sd">            model type.</span>
<span class="sd">        default (bytes): The default value for this property.</span>
<span class="sd">        choices (Iterable[bytes]): A container of allowed values for this</span>
<span class="sd">            property.</span>
<span class="sd">        validator (Callable[[~google.cloud.ndb.model.Property, Any], bool]): A</span>
<span class="sd">            validator to be used to check values.</span>
<span class="sd">        verbose_name (str): A longer, user-friendly name for this property.</span>
<span class="sd">        write_empty_list (bool): Indicates if an empty list should be written</span>
<span class="sd">            to the datastore.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: If ``auto_current_user`` is provided.</span>
<span class="sd">        NotImplementedError: If ``auto_current_user_add`` is provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_auto_current_user</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_auto_current_user_add</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">auto_current_user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">auto_current_user_add</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">indexed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">repeated</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">write_empty_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UserProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">indexed</span><span class="o">=</span><span class="n">indexed</span><span class="p">,</span>
            <span class="n">repeated</span><span class="o">=</span><span class="n">repeated</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="n">required</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="n">choices</span><span class="p">,</span>
            <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">verbose_name</span><span class="p">,</span>
            <span class="n">write_empty_list</span><span class="o">=</span><span class="n">write_empty_list</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">auto_current_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">auto_current_user_add</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

<div class="viewcode-block" id="UserProperty._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.UserProperty._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (User): The value to check.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadValueError: If ``value`` is not a :class:`User`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">User</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected User, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="UserProperty._prepare_for_put"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.UserProperty._prepare_for_put">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_for_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pre-put hook</span>

<span class="sd">        This is a no-op. In previous versions of ``ndb``, this method</span>
<span class="sd">        populated the value based on ``auto_current_user`` or</span>
<span class="sd">        ``auto_current_user_add``, but these flags have been disabled.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity with values.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_serialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. No longer implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_deserialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. This method is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="KeyProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.KeyProperty">[docs]</a><span class="k">class</span> <span class="nc">KeyProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property that contains :class:`.Key` values.</span>

<span class="sd">    The constructor for :class:`KeyProperty` allows at most two positional</span>
<span class="sd">    arguments. Any usage of :data:`None` as a positional argument will</span>
<span class="sd">    be ignored. Any of the following signatures are allowed:</span>

<span class="sd">    .. testsetup:: key-property-constructor</span>

<span class="sd">        from google.cloud import ndb</span>


<span class="sd">        class SimpleModel(ndb.Model):</span>
<span class="sd">            pass</span>

<span class="sd">    .. doctest:: key-property-constructor</span>

<span class="sd">        &gt;&gt;&gt; name = &quot;my_value&quot;</span>
<span class="sd">        &gt;&gt;&gt; ndb.KeyProperty(name)</span>
<span class="sd">        KeyProperty(&#39;my_value&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ndb.KeyProperty(SimpleModel)</span>
<span class="sd">        KeyProperty(kind=&#39;SimpleModel&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ndb.KeyProperty(name, SimpleModel)</span>
<span class="sd">        KeyProperty(&#39;my_value&#39;, kind=&#39;SimpleModel&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ndb.KeyProperty(SimpleModel, name)</span>
<span class="sd">        KeyProperty(&#39;my_value&#39;, kind=&#39;SimpleModel&#39;)</span>

<span class="sd">    The type of the positional arguments will be used to determine their</span>
<span class="sd">    purpose: a string argument is assumed to be the ``name`` and a</span>
<span class="sd">    :class:`type` argument is assumed to be the ``kind`` (and checked that</span>
<span class="sd">    the type is a subclass of :class:`Model`).</span>

<span class="sd">    .. automethod:: _validate</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): The name of the property.</span>
<span class="sd">        kind (Union[type, str]): The (optional) kind to be stored. If provided</span>
<span class="sd">            as a positional argument, this must be a subclass of :class:`Model`</span>
<span class="sd">            otherwise the kind name is sufficient.</span>
<span class="sd">        indexed (bool): Indicates if the value should be indexed.</span>
<span class="sd">        repeated (bool): Indicates if this property is repeated, i.e. contains</span>
<span class="sd">            multiple values.</span>
<span class="sd">        required (bool): Indicates if this property is required on the given</span>
<span class="sd">            model type.</span>
<span class="sd">        default (.Key): The default value for this property.</span>
<span class="sd">        choices (Iterable[.Key]): A container of allowed values for this</span>
<span class="sd">            property.</span>
<span class="sd">        validator (Callable[[~google.cloud.ndb.model.Property, .Key], bool]): A</span>
<span class="sd">            validator to be used to check values.</span>
<span class="sd">        verbose_name (str): A longer, user-friendly name for this property.</span>
<span class="sd">        write_empty_list (bool): Indicates if an empty list should be written</span>
<span class="sd">            to the datastore.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_kind</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">indexed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">repeated</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">write_empty_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_positional</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">kind</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">KeyProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">indexed</span><span class="o">=</span><span class="n">indexed</span><span class="p">,</span>
            <span class="n">repeated</span><span class="o">=</span><span class="n">repeated</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="n">required</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="n">choices</span><span class="p">,</span>
            <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">verbose_name</span><span class="p">,</span>
            <span class="n">write_empty_list</span><span class="o">=</span><span class="n">write_empty_list</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span> <span class="o">=</span> <span class="n">kind</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_handle_positional</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">kind</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle positional arguments.</span>

<span class="sd">        In particular, assign them to the &quot;correct&quot; values and make sure</span>
<span class="sd">        they don&#39;t collide with the relevant keyword arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (tuple): The positional arguments provided to the</span>
<span class="sd">                constructor.</span>
<span class="sd">            name (Optional[str]): The name that was provided as a keyword</span>
<span class="sd">                argument to the constructor.</span>
<span class="sd">            kind (Optional[Union[type, str]]): The kind that was provided as a</span>
<span class="sd">                keyword argument to the constructor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Optional[str], Optional[str]]: The ``name`` and ``kind``</span>
<span class="sd">            inferred from the arguments. Either may be :data:`None`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If ``args`` has more than 2 elements.</span>
<span class="sd">            TypeError: If a valid ``name`` type (i.e. a string) is specified</span>
<span class="sd">                twice in ``args``.</span>
<span class="sd">            TypeError: If a valid ``kind`` type (i.e. a subclass of</span>
<span class="sd">                :class:`Model`) is specified twice in ``args``.</span>
<span class="sd">            TypeError: If an element in ``args`` is not a :class:`str` or a</span>
<span class="sd">                subclass of :class:`Model`.</span>
<span class="sd">            TypeError: If a ``name`` is specified both in ``args`` and via</span>
<span class="sd">                the ``name`` keyword.</span>
<span class="sd">            TypeError: If a ``kind`` is specified both in ``args`` and via</span>
<span class="sd">                the ``kind`` keyword.</span>
<span class="sd">            TypeError: If a ``kind`` was provided via ``keyword`` and is</span>
<span class="sd">                not a :class:`str` or a subclass of :class:`Model`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Limit positional arguments.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;The KeyProperty constructor accepts at most two &quot;</span>
                <span class="s2">&quot;positional arguments.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Filter out None</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="c1"># Determine the name / kind inferred from the positional arguments.</span>
        <span class="n">name_via_positional</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">kind_via_positional</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name_via_positional</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">name_via_positional</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;You can only specify one name&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">kind_via_positional</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kind_via_positional</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;You can only specify one kind&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;Unexpected positional argument: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># Reconcile the two possible ``name``` values.</span>
        <span class="k">if</span> <span class="n">name_via_positional</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name_via_positional</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;You can only specify name once&quot;</span><span class="p">)</span>

        <span class="c1"># Reconcile the two possible ``kind``` values.</span>
        <span class="k">if</span> <span class="n">kind_via_positional</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">kind_via_positional</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;You can only specify kind once&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure the ``kind`` is a ``str``.</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;kind must be a Model class or a string&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">kind</span>

    <span class="k">def</span> <span class="nf">_constructor_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`__repr__`.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Tuple[str, bool]: Pairs of argument name and a boolean indicating</span>
<span class="sd">            if that argument is a keyword.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">yield</span> <span class="s2">&quot;kind&quot;</span><span class="p">,</span> <span class="kc">True</span>
        <span class="n">from_inspect</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">KeyProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_constructor_info</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">is_keyword</span> <span class="ow">in</span> <span class="n">from_inspect</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;kind&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">is_keyword</span>

<div class="viewcode-block" id="KeyProperty._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.KeyProperty._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (.Key): The value to check.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadValueError: If ``value`` is not a :class:`.Key`.</span>
<span class="sd">            .BadValueError: If ``value`` is a partial :class:`.Key` (i.e. it</span>
<span class="sd">                has no name or ID set).</span>
<span class="sd">            .BadValueError: If the current property has an associated ``kind``</span>
<span class="sd">                and ``value`` does not match that kind.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected Key, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Reject incomplete keys.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected complete Key, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Verify kind if provided.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Expected Key with kind=</span><span class="si">{!r}</span><span class="s2">, got &quot;</span>
                    <span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kind</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_serialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. No longer implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_deserialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. This method is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="BlobKeyProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.BlobKeyProperty">[docs]</a><span class="k">class</span> <span class="nc">BlobKeyProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property containing :class:`~google.cloud.ndb.model.BlobKey` values.</span>

<span class="sd">    .. automethod:: _validate</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="BlobKeyProperty._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.BlobKeyProperty._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (~google.cloud.ndb.model.BlobKey): The value to check.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadValueError: If ``value`` is not a</span>
<span class="sd">                :class:`~google.cloud.ndb.model.BlobKey`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BlobKey</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected BlobKey, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_serialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. No longer implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_deserialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. This method is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="DateTimeProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.DateTimeProperty">[docs]</a><span class="k">class</span> <span class="nc">DateTimeProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property that contains :class:`~datetime.datetime` values.</span>

<span class="sd">    This property expects &quot;naive&quot; datetime stamps, i.e. no timezone can</span>
<span class="sd">    be set. Furthermore, the assumption is that naive datetime stamps</span>
<span class="sd">    represent UTC.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Unlike Django, ``auto_now_add`` can be overridden by setting the</span>
<span class="sd">        value before writing the entity. And unlike the legacy</span>
<span class="sd">        ``google.appengine.ext.db``, ``auto_now`` does not supply a default</span>
<span class="sd">        value. Also unlike legacy ``db``, when the entity is written, the</span>
<span class="sd">        property values are updated to match what was written. Finally, beware</span>
<span class="sd">        that this also updates the value in the in-process cache, **and** that</span>
<span class="sd">        ``auto_now_add`` may interact weirdly with transaction retries (a retry</span>
<span class="sd">        of a property with ``auto_now_add`` set will reuse the value that was</span>
<span class="sd">        set on the first try).</span>

<span class="sd">    .. automethod:: _validate</span>
<span class="sd">    .. automethod:: _prepare_for_put</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): The name of the property.</span>
<span class="sd">        auto_now (bool): Indicates that the property should be set to the</span>
<span class="sd">            current datetime when an entity is created and whenever it is</span>
<span class="sd">            updated.</span>
<span class="sd">        auto_now_add (bool): Indicates that the property should be set to the</span>
<span class="sd">            current datetime when an entity is created.</span>
<span class="sd">        indexed (bool): Indicates if the value should be indexed.</span>
<span class="sd">        repeated (bool): Indicates if this property is repeated, i.e. contains</span>
<span class="sd">            multiple values.</span>
<span class="sd">        required (bool): Indicates if this property is required on the given</span>
<span class="sd">            model type.</span>
<span class="sd">        default (~datetime.datetime): The default value for this property.</span>
<span class="sd">        choices (Iterable[~datetime.datetime]): A container of allowed values</span>
<span class="sd">            for this property.</span>
<span class="sd">        validator (Callable[[~google.cloud.ndb.model.Property, Any], bool]): A</span>
<span class="sd">            validator to be used to check values.</span>
<span class="sd">        verbose_name (str): A longer, user-friendly name for this property.</span>
<span class="sd">        write_empty_list (bool): Indicates if an empty list should be written</span>
<span class="sd">            to the datastore.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If ``repeated=True`` and ``auto_now=True``.</span>
<span class="sd">        ValueError: If ``repeated=True`` and ``auto_now_add=True``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_auto_now</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_auto_now_add</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">auto_now</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">auto_now_add</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">indexed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">repeated</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">write_empty_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DateTimeProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">indexed</span><span class="o">=</span><span class="n">indexed</span><span class="p">,</span>
            <span class="n">repeated</span><span class="o">=</span><span class="n">repeated</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="n">required</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="n">choices</span><span class="p">,</span>
            <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">verbose_name</span><span class="p">,</span>
            <span class="n">write_empty_list</span><span class="o">=</span><span class="n">write_empty_list</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">auto_now</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;DateTimeProperty </span><span class="si">{}</span><span class="s2"> could use auto_now and be &quot;</span>
                    <span class="s2">&quot;repeated, but there would be no point.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">auto_now_add</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;DateTimeProperty </span><span class="si">{}</span><span class="s2"> could use auto_now_add and be &quot;</span>
                    <span class="s2">&quot;repeated, but there would be no point.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">auto_now</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auto_now</span> <span class="o">=</span> <span class="n">auto_now</span>
        <span class="k">if</span> <span class="n">auto_now_add</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auto_now_add</span> <span class="o">=</span> <span class="n">auto_now_add</span>

<div class="viewcode-block" id="DateTimeProperty._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.DateTimeProperty._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (~datetime.datetime): The value to check.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadValueError: If ``value`` is not a :class:`~datetime.datetime`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected datetime, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_now</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;datetime.datetime: Return current datetime.</span>

<span class="sd">        Subclasses will override this to return different forms of &quot;now&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

<div class="viewcode-block" id="DateTimeProperty._prepare_for_put"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.DateTimeProperty._prepare_for_put">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_for_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the current timestamp when &quot;auto&quot; is set.</span>

<span class="sd">        If one of the following scenarios occur</span>

<span class="sd">        * ``auto_now=True``</span>
<span class="sd">        * ``auto_now_add=True`` and the ``entity`` doesn&#39;t have a value set</span>

<span class="sd">        then this hook will run before the ``entity`` is ``put()`` into</span>
<span class="sd">        the datastore.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (Model): An entity with values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_now</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auto_now_add</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_serialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. No longer implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_deserialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. This method is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="DateProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.DateProperty">[docs]</a><span class="k">class</span> <span class="nc">DateProperty</span><span class="p">(</span><span class="n">DateTimeProperty</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property that contains :class:`~datetime.date` values.</span>

<span class="sd">    .. automethod:: _to_base_type</span>
<span class="sd">    .. automethod:: _from_base_type</span>
<span class="sd">    .. automethod:: _validate</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="DateProperty._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.DateProperty._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (~datetime.date): The value to check.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadValueError: If ``value`` is not a :class:`~datetime.date`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected date, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="DateProperty._to_base_type"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.DateProperty._to_base_type">[docs]</a>    <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value to the &quot;base&quot; value type for this property.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (~datetime.date): The value to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ~datetime.datetime: The converted value: a datetime object with the</span>
<span class="sd">            time set to ``00:00``.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If ``value`` is not a :class:`~datetime.date`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot convert to datetime expected date value; &quot;</span>
                <span class="s2">&quot;received </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">day</span><span class="p">)</span></div>

<div class="viewcode-block" id="DateProperty._from_base_type"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.DateProperty._from_base_type">[docs]</a>    <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value from the &quot;base&quot; value type for this property.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (~datetime.datetime): The value to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ~datetime.date: The converted value: the date that ``value``</span>
<span class="sd">            occurs on.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">date</span><span class="p">()</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_now</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;datetime.datetime: Return current date.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span></div>


<div class="viewcode-block" id="TimeProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.TimeProperty">[docs]</a><span class="k">class</span> <span class="nc">TimeProperty</span><span class="p">(</span><span class="n">DateTimeProperty</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property that contains :class:`~datetime.time` values.</span>

<span class="sd">    .. automethod:: _to_base_type</span>
<span class="sd">    .. automethod:: _from_base_type</span>
<span class="sd">    .. automethod:: _validate</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="TimeProperty._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.TimeProperty._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (~datetime.time): The value to check.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .BadValueError: If ``value`` is not a :class:`~datetime.time`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected time, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="TimeProperty._to_base_type"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.TimeProperty._to_base_type">[docs]</a>    <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value to the &quot;base&quot; value type for this property.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (~datetime.time): The value to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ~datetime.datetime: The converted value: a datetime object with the</span>
<span class="sd">            date set to ``1970-01-01``.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If ``value`` is not a :class:`~datetime.time`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot convert to datetime expected time value; &quot;</span>
                <span class="s2">&quot;received </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span>
            <span class="mi">1970</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">value</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
            <span class="n">value</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
            <span class="n">value</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="n">value</span><span class="o">.</span><span class="n">microsecond</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TimeProperty._from_base_type"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.TimeProperty._from_base_type">[docs]</a>    <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value from the &quot;base&quot; value type for this property.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (~datetime.datetime): The value to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ~datetime.time: The converted value: the time that ``value``</span>
<span class="sd">            occurs at.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_now</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;datetime.datetime: Return current time.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>


<div class="viewcode-block" id="StructuredProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.StructuredProperty">[docs]</a><span class="k">class</span> <span class="nc">StructuredProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Property whose value is itself an entity.</span>

<span class="sd">    The values of the sub-entity are indexed and can be queried.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_model_class</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_kwargs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StructuredProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_has_repeated</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;This StructuredProperty cannot use repeated=True &quot;</span>
                    <span class="s2">&quot;because its model class (</span><span class="si">%s</span><span class="s2">) contains repeated &quot;</span>
                    <span class="s2">&quot;properties (directly or indirectly).&quot;</span>
                    <span class="o">%</span> <span class="n">model_class</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span> <span class="o">=</span> <span class="n">model_class</span>

    <span class="k">def</span> <span class="nf">_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override _get_value() to *not* raise UnprojectedPropertyError.</span>

<span class="sd">        This is necessary because the projection must include both the</span>
<span class="sd">        sub-entity and the property name that is projected (e.g. &#39;foo.bar&#39;</span>
<span class="sd">        instead of only &#39;foo&#39;). In that case the original code would fail,</span>
<span class="sd">        because it only looks for the property name (&#39;foo&#39;). Here we check for</span>
<span class="sd">        a value, and only call the original code if the value is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">entity</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
            <span class="c1"># Invoke super _get_value() to raise the proper exception.</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">StructuredProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_get_for_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span>

<div class="viewcode-block" id="StructuredProperty.__getattr__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.StructuredProperty.__getattr__">[docs]</a>    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dynamically get a subproperty.&quot;&quot;&quot;</span>
        <span class="c1"># Optimistically try to use the dict key.</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attrname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;Model subclass </span><span class="si">%s</span><span class="s2"> has no attribute </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">prop_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="n">prop_copy</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">prop_copy</span><span class="o">.</span><span class="n">_name</span>
        <span class="c1"># Cache the outcome, so subsequent requests for the same attribute</span>
        <span class="c1"># name will get the copied property directly rather than going</span>
        <span class="c1"># through the above motions all over again.</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">prop_copy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prop_copy</span></div>

    <span class="k">def</span> <span class="nf">_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">!=</span> <span class="n">query_module</span><span class="o">.</span><span class="n">_EQ_OP</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
                <span class="s2">&quot;StructuredProperty filter can only use ==&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot query for unindexed StructuredProperty </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
            <span class="p">)</span>
        <span class="c1"># Import late to avoid circular imports.</span>
        <span class="kn">from</span> <span class="nn">.query</span> <span class="k">import</span> <span class="n">ConjunctionNode</span><span class="p">,</span> <span class="n">PostFilterNode</span>
        <span class="kn">from</span> <span class="nn">.query</span> <span class="k">import</span> <span class="n">RepeatedStructuredPropertyPredicate</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.query</span> <span class="k">import</span> <span class="p">(</span>
                <span class="n">FilterNode</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># Import late to avoid circular imports.</span>

            <span class="k">return</span> <span class="n">FilterNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">match_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">subvalue</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">subvalue</span><span class="p">:</span>  <span class="c1"># pragma: no branch</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot query for non-empty repeated property </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="n">prop</span><span class="o">.</span><span class="n">_name</span>
                    <span class="p">)</span>
                <span class="k">continue</span>  <span class="c1"># pragma: NO COVER</span>

            <span class="k">if</span> <span class="n">subvalue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no branch</span>
                <span class="n">altprop</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span><span class="p">)</span>
                <span class="n">filt</span> <span class="o">=</span> <span class="n">altprop</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">subvalue</span><span class="p">)</span>
                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>
                <span class="n">match_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">filters</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
                <span class="s2">&quot;StructuredProperty filter without any values&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
            <span class="n">entity_pb</span> <span class="o">=</span> <span class="n">_entity_to_protobuf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">predicate</span> <span class="o">=</span> <span class="n">RepeatedStructuredPropertyPredicate</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">match_keys</span><span class="p">,</span> <span class="n">entity_pb</span>
            <span class="p">)</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PostFilterNode</span><span class="p">(</span><span class="n">predicate</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ConjunctionNode</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_IN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
                <span class="s2">&quot;Expected list, tuple or set, got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,)</span>
            <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">.query</span> <span class="k">import</span> <span class="n">DisjunctionNode</span><span class="p">,</span> <span class="n">FalseNode</span>

        <span class="c1"># Expand to a series of == filters.</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="n">query_module</span><span class="o">.</span><span class="n">_EQ_OP</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filters</span><span class="p">:</span>
            <span class="c1"># DisjunctionNode doesn&#39;t like an empty list of filters.</span>
            <span class="c1"># Running the query will still fail, but this matches the</span>
            <span class="c1"># behavior of IN for regular properties.</span>
            <span class="k">return</span> <span class="n">FalseNode</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DisjunctionNode</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span>

    <span class="n">IN</span> <span class="o">=</span> <span class="n">_IN</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># A dict is assumed to be the result of a _to_dict() call.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="p">(</span><span class="o">**</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected </span><span class="si">%s</span><span class="s2"> instance, got </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_has_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">rest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if entity has a value for this property.</span>

<span class="sd">        Basically, prop._has_value(self, ent, [&#39;x&#39;, &#39;y&#39;]) is similar to</span>
<span class="sd">          (prop._has_value(ent) and prop.x._has_value(ent.x) and</span>
<span class="sd">           prop.x.y._has_value(ent.x.y)), assuming prop.x and prop.x.y exist.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity (ndb.Model): An instance of a model.</span>
<span class="sd">            rest (list[str]): optional list of attribute names to check in</span>
<span class="sd">                addition.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the entity has a value for that property.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">StructuredProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_has_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">rest</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;Failed to retrieve sub-entity of StructuredProperty&quot;</span>
                        <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
                    <span class="p">)</span>
                <span class="n">subent</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subent</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="n">subent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="n">subprop</span> <span class="o">=</span> <span class="n">subent</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">subprop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">subprop</span><span class="o">.</span><span class="n">_has_value</span><span class="p">(</span><span class="n">subent</span><span class="p">,</span> <span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">return</span> <span class="n">ok</span>

    <span class="k">def</span> <span class="nf">_check_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rest</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">require_indexed</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override for Property._check_property().</span>

<span class="sd">        Raises:</span>
<span class="sd">            InvalidPropertyError if no subproperty is specified or if something</span>
<span class="sd">            is wrong with the subproperty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rest</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidPropertyError</span><span class="p">(</span>
                <span class="s2">&quot;Structured property </span><span class="si">%s</span><span class="s2"> requires a subproperty&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="o">.</span><span class="n">_check_properties</span><span class="p">(</span>
            <span class="p">[</span><span class="n">rest</span><span class="p">],</span> <span class="n">require_indexed</span><span class="o">=</span><span class="n">require_indexed</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value to the &quot;base&quot; value type for this property.</span>

<span class="sd">        Args:</span>
<span class="sd">            value: The given class value to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bytes</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If ``value`` is not the correct ``Model`` type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot convert to protocol buffer. Expected </span><span class="si">{}</span><span class="s2"> value; &quot;</span>
                <span class="s2">&quot;received </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">_entity_to_ds_entity</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value from the &quot;base&quot; value type for this property.</span>
<span class="sd">        Args:</span>
<span class="sd">            value(~google.cloud.datastore.Entity or bytes): The value to be</span>
<span class="sd">            converted.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The converted value with given class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">entity_module</span><span class="o">.</span><span class="n">Entity</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">_entity_from_ds_entity</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">model_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_get_value_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span></div>


<div class="viewcode-block" id="LocalStructuredProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.LocalStructuredProperty">[docs]</a><span class="k">class</span> <span class="nc">LocalStructuredProperty</span><span class="p">(</span><span class="n">BlobProperty</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property that contains ndb.Model value.</span>

<span class="sd">    .. note::</span>
<span class="sd">        Unlike most property types, a :class:`LocalStructuredProperty`</span>
<span class="sd">        is **not** indexed.</span>
<span class="sd">    .. automethod:: _to_base_type</span>
<span class="sd">    .. automethod:: _from_base_type</span>
<span class="sd">    .. automethod:: _validate</span>

<span class="sd">    Args:</span>
<span class="sd">        model_class (type): The class of the property. (Must be subclass of</span>
<span class="sd">            ``ndb.Model``.)</span>
<span class="sd">        name (str): The name of the property.</span>
<span class="sd">        compressed (bool): Indicates if the value should be compressed (via</span>
<span class="sd">            ``zlib``).</span>
<span class="sd">        repeated (bool): Indicates if this property is repeated, i.e. contains</span>
<span class="sd">            multiple values.</span>
<span class="sd">        required (bool): Indicates if this property is required on the given</span>
<span class="sd">            model type.</span>
<span class="sd">        default (Any): The default value for this property.</span>
<span class="sd">        validator (Callable[[~google.cloud.ndb.model.Property, Any], bool]): A</span>
<span class="sd">            validator to be used to check values.</span>
<span class="sd">        verbose_name (str): A longer, user-friendly name for this property.</span>
<span class="sd">        write_empty_list (bool): Indicates if an empty list should be written</span>
<span class="sd">            to the datastore.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_model_class</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_keep_keys</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_kwargs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">indexed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;indexed&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">indexed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot index LocalStructuredProperty </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">keep_keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;keep_keys&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LocalStructuredProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span> <span class="o">=</span> <span class="n">model_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keep_keys</span> <span class="o">=</span> <span class="n">keep_keys</span>

<div class="viewcode-block" id="LocalStructuredProperty._validate"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.LocalStructuredProperty._validate">[docs]</a>    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a ``value`` before setting it.</span>
<span class="sd">        Args:</span>
<span class="sd">            value: The value to check.</span>
<span class="sd">        Raises:</span>
<span class="sd">            .BadValueError: If ``value`` is not a given class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># A dict is assumed to be the result of a _to_dict() call.</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="p">(</span><span class="o">**</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected </span><span class="si">{}</span><span class="s2">, got </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">value</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="LocalStructuredProperty._to_base_type"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.LocalStructuredProperty._to_base_type">[docs]</a>    <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value to the &quot;base&quot; value type for this property.</span>
<span class="sd">        Args:</span>
<span class="sd">            value: The given class value to be converted.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bytes</span>
<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If ``value`` is not the correct ``Model`` type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot convert to bytes expected </span><span class="si">{}</span><span class="s2"> value; &quot;</span>
                <span class="s2">&quot;received </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">pb</span> <span class="o">=</span> <span class="n">_entity_to_protobuf</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">set_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_keep_keys</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pb</span><span class="o">.</span><span class="n">SerializePartialToString</span><span class="p">()</span></div>

<div class="viewcode-block" id="LocalStructuredProperty._from_base_type"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.LocalStructuredProperty._from_base_type">[docs]</a>    <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value from the &quot;base&quot; value type for this property.</span>
<span class="sd">        Args:</span>
<span class="sd">            value(~google.cloud.datastore.Entity or bytes): The value to be</span>
<span class="sd">            converted.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The converted value with given class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">pb</span> <span class="o">=</span> <span class="n">entity_pb2</span><span class="o">.</span><span class="n">Entity</span><span class="p">()</span>
            <span class="n">pb</span><span class="o">.</span><span class="n">MergeFromString</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">entity_from_protobuf</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_keys</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
            <span class="n">value</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">_entity_from_ds_entity</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">model_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GenericProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.GenericProperty">[docs]</a><span class="k">class</span> <span class="nc">GenericProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Property whose value can be (almost) any basic type.</span>
<span class="sd">    This is mainly used for Expando and for orphans (values present in</span>
<span class="sd">    Cloud Datastore but not represented in the Model subclass) but can</span>
<span class="sd">    also be used explicitly for properties with dynamically-typed</span>
<span class="sd">    values.</span>

<span class="sd">    This supports compressed=True, which is only effective for str</span>
<span class="sd">    values (not for unicode), and implies indexed=False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_compressed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_kwargs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">compressed</span><span class="p">:</span>  <span class="c1"># Compressed implies unindexed.</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;indexed&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GenericProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="o">=</span> <span class="n">compressed</span>
        <span class="k">if</span> <span class="n">compressed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;GenericProperty </span><span class="si">%s</span><span class="s2"> cannot be compressed and &quot;</span>
                <span class="s2">&quot;indexed at the same time.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_CompressedValue</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_CompressedValue</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">z_val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_MAX_STRING_LENGTH</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Indexed value </span><span class="si">%s</span><span class="s2"> must be at most </span><span class="si">%d</span><span class="s2"> bytes&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">_MAX_STRING_LENGTH</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_deserialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. This method is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper for :meth:`_deserialize`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always. This method is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoLongerImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="ComputedProperty"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.ComputedProperty">[docs]</a><span class="k">class</span> <span class="nc">ComputedProperty</span><span class="p">(</span><span class="n">GenericProperty</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Property whose value is determined by a user-supplied function.</span>
<span class="sd">    Computed properties cannot be set directly, but are instead generated by a</span>
<span class="sd">    function when required. They are useful to provide fields in Cloud Datastore</span>
<span class="sd">    that can be used for filtering or sorting without having to manually set the</span>
<span class="sd">    value in code - for example, sorting on the length of a BlobProperty, or</span>
<span class="sd">    using an equality filter to check if another field is not empty.</span>
<span class="sd">    ComputedProperty can be declared as a regular property, passing a function as</span>
<span class="sd">    the first argument, or it can be used as a decorator for the function that</span>
<span class="sd">    does the calculation.</span>

<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; class DatastoreFile(ndb.Model):</span>
<span class="sd">    ...   name = ndb.model.StringProperty()</span>
<span class="sd">    ...   name_lower = ndb.model.ComputedProperty(lambda self: self.name.lower())</span>
<span class="sd">    ...</span>
<span class="sd">    ...   data = ndb.model.BlobProperty()</span>
<span class="sd">    ...</span>
<span class="sd">    ...   @ndb.model.ComputedProperty</span>
<span class="sd">    ...   def size(self):</span>
<span class="sd">    ...     return len(self.data)</span>
<span class="sd">    ...</span>
<span class="sd">    ...   def _compute_hash(self):</span>
<span class="sd">    ...     return hashlib.sha1(self.data).hexdigest()</span>
<span class="sd">    ...   hash = ndb.model.ComputedProperty(_compute_hash, name=&#39;sha1&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_kwargs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indexed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repeated</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        Args:</span>

<span class="sd">        func: A function that takes one argument, the model instance, and returns</span>
<span class="sd">            a calculated value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ComputedProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">indexed</span><span class="o">=</span><span class="n">indexed</span><span class="p">,</span>
            <span class="n">repeated</span><span class="o">=</span><span class="n">repeated</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">verbose_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">def</span> <span class="nf">_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ComputedPropertyError</span><span class="p">(</span><span class="s2">&quot;Cannot assign to a ComputedProperty&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_delete_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ComputedPropertyError</span><span class="p">(</span><span class="s2">&quot;Cannot delete a ComputedProperty&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="c1"># About projections and computed properties: if the computed</span>
        <span class="c1"># property itself is in the projection, don&#39;t recompute it; this</span>
        <span class="c1"># prevents raising UnprojectedPropertyError if one of the</span>
        <span class="c1"># dependents is not in the projection.  However, if the computed</span>
        <span class="c1"># property is not in the projection, compute it normally -- its</span>
        <span class="c1"># dependents may all be in the projection, and it may be useful to</span>
        <span class="c1"># access the computed value without having it in the projection.</span>
        <span class="c1"># In this case, if any of the dependents is not in the projection,</span>
        <span class="c1"># accessing it in the computation function will raise</span>
        <span class="c1"># UnprojectedPropertyError which will just bubble up.</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_projection</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ComputedProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_prepare_for_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>  <span class="c1"># For its side effects.</span></div>


<div class="viewcode-block" id="MetaModel"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.MetaModel">[docs]</a><span class="k">class</span> <span class="nc">MetaModel</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metaclass for Model.</span>

<span class="sd">    This exists to fix up the properties -- they need to know their name. For</span>
<span class="sd">    example, defining a model:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        class Book(ndb.Model):</span>
<span class="sd">            pages = ndb.IntegerProperty()</span>

<span class="sd">    the ``Book.pages`` property doesn&#39;t have the name ``pages`` assigned.</span>
<span class="sd">    This is accomplished by calling the ``_fix_up_properties()`` method on the</span>
<span class="sd">    class itself.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">classdict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MetaModel</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">classdict</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_fix_up_properties</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">props</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span><span class="p">,</span> <span class="n">prop</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">props</span><span class="p">))</span></div>


<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Model">[docs]</a><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">MetaModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class describing Cloud Datastore entities.</span>

<span class="sd">    Model instances are usually called entities. All model classes</span>
<span class="sd">    inheriting from :class:`Model` automatically have :class:`MetaModel` as</span>
<span class="sd">    their metaclass, so that the properties are fixed up properly after the</span>
<span class="sd">    class is defined.</span>

<span class="sd">    Because of this, you cannot use the same :class:`Property` object to</span>
<span class="sd">    describe multiple properties -- you must create separate :class:`Property`</span>
<span class="sd">    objects for each property. For example, this does not work:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        reuse_prop = ndb.StringProperty()</span>

<span class="sd">        class Wrong(ndb.Model):</span>
<span class="sd">            first = reuse_prop</span>
<span class="sd">            second = reuse_prop</span>

<span class="sd">    instead each class attribute needs to be distinct:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        class NotWrong(ndb.Model):</span>
<span class="sd">            first = ndb.StringProperty()</span>
<span class="sd">            second = ndb.StringProperty()</span>

<span class="sd">    The &quot;kind&quot; for a given :class:`Model` subclass is normally equal to the</span>
<span class="sd">    class name (exclusive of the module name or any other parent scope). To</span>
<span class="sd">    override the kind, define :meth:`_get_kind`, as follows:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        class MyModel(ndb.Model):</span>
<span class="sd">            @classmethod</span>
<span class="sd">            def _get_kind(cls):</span>
<span class="sd">                return &quot;AnotherKind&quot;</span>

<span class="sd">    A newly constructed entity will not be persisted to Cloud Datastore without</span>
<span class="sd">    an explicit call to :meth:`put`.</span>

<span class="sd">    User-defined properties can be passed to the constructor via keyword</span>
<span class="sd">    arguments:</span>

<span class="sd">    .. doctest:: model-keywords</span>

<span class="sd">        &gt;&gt;&gt; class MyModel(ndb.Model):</span>
<span class="sd">        ...     value = ndb.FloatProperty()</span>
<span class="sd">        ...     description = ndb.StringProperty()</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; MyModel(value=7.34e22, description=&quot;Mass of the moon&quot;)</span>
<span class="sd">        MyModel(description=&#39;Mass of the moon&#39;, value=7.34e+22)</span>

<span class="sd">    In addition to user-defined properties, there are six accepted keyword</span>
<span class="sd">    arguments:</span>

<span class="sd">    * ``key``</span>
<span class="sd">    * ``id``</span>
<span class="sd">    * ``app``</span>
<span class="sd">    * ``namespace``</span>
<span class="sd">    * ``parent``</span>
<span class="sd">    * ``projection``</span>

<span class="sd">    Of these, ``key`` is a public attribute on :class:`Model` instances:</span>

<span class="sd">    .. testsetup:: model-key</span>

<span class="sd">        from google.cloud import ndb</span>


<span class="sd">        class MyModel(ndb.Model):</span>
<span class="sd">            value = ndb.FloatProperty()</span>
<span class="sd">            description = ndb.StringProperty()</span>

<span class="sd">    .. doctest:: model-key</span>

<span class="sd">        &gt;&gt;&gt; entity1 = MyModel(id=11)</span>
<span class="sd">        &gt;&gt;&gt; entity1.key</span>
<span class="sd">        Key(&#39;MyModel&#39;, 11)</span>
<span class="sd">        &gt;&gt;&gt; entity2 = MyModel(parent=entity1.key)</span>
<span class="sd">        &gt;&gt;&gt; entity2.key</span>
<span class="sd">        Key(&#39;MyModel&#39;, 11, &#39;MyModel&#39;, None)</span>
<span class="sd">        &gt;&gt;&gt; entity3 = MyModel(key=ndb.Key(MyModel, &quot;e-three&quot;))</span>
<span class="sd">        &gt;&gt;&gt; entity3.key</span>
<span class="sd">        Key(&#39;MyModel&#39;, &#39;e-three&#39;)</span>

<span class="sd">    However, a user-defined property can be defined on the model with the</span>
<span class="sd">    same name as one of those keyword arguments. In this case, the user-defined</span>
<span class="sd">    property &quot;wins&quot;:</span>

<span class="sd">    .. doctest:: model-keyword-id-collision</span>

<span class="sd">        &gt;&gt;&gt; class IDCollide(ndb.Model):</span>
<span class="sd">        ...     id = ndb.FloatProperty()</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; entity = IDCollide(id=17)</span>
<span class="sd">        &gt;&gt;&gt; entity</span>
<span class="sd">        IDCollide(id=17.0)</span>
<span class="sd">        &gt;&gt;&gt; entity.key is None</span>
<span class="sd">        True</span>

<span class="sd">    In such cases of argument &quot;collision&quot;, an underscore can be used as a</span>
<span class="sd">    keyword argument prefix:</span>

<span class="sd">    .. doctest:: model-keyword-id-collision</span>

<span class="sd">        &gt;&gt;&gt; entity = IDCollide(id=17, _id=2009)</span>
<span class="sd">        &gt;&gt;&gt; entity</span>
<span class="sd">        IDCollide(key=Key(&#39;IDCollide&#39;, 2009), id=17.0)</span>

<span class="sd">    For the **very** special case of a property named ``key``, the ``key``</span>
<span class="sd">    attribute will no longer be the entity&#39;s key but instead will be the</span>
<span class="sd">    property value. Instead, the entity&#39;s key is accessible via ``_key``:</span>

<span class="sd">    .. doctest:: model-keyword-key-collision</span>

<span class="sd">        &gt;&gt;&gt; class KeyCollide(ndb.Model):</span>
<span class="sd">        ...     key = ndb.StringProperty()</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; entity1 = KeyCollide(key=&quot;Take fork in road&quot;, id=987)</span>
<span class="sd">        &gt;&gt;&gt; entity1</span>
<span class="sd">        KeyCollide(_key=Key(&#39;KeyCollide&#39;, 987), key=&#39;Take fork in road&#39;)</span>
<span class="sd">        &gt;&gt;&gt; entity1.key</span>
<span class="sd">        &#39;Take fork in road&#39;</span>
<span class="sd">        &gt;&gt;&gt; entity1._key</span>
<span class="sd">        Key(&#39;KeyCollide&#39;, 987)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; entity2 = KeyCollide(key=&quot;Go slow&quot;, _key=ndb.Key(KeyCollide, 1))</span>
<span class="sd">        &gt;&gt;&gt; entity2</span>
<span class="sd">        KeyCollide(_key=Key(&#39;KeyCollide&#39;, 1), key=&#39;Go slow&#39;)</span>

<span class="sd">    The constructor accepts keyword arguments based on the properties</span>
<span class="sd">    defined on model subclass. However, using keywords for nonexistent</span>
<span class="sd">    or non-:class:`Property` class attributes will cause a failure:</span>

<span class="sd">    .. doctest:: model-keywords-fail</span>

<span class="sd">        &gt;&gt;&gt; class Simple(ndb.Model):</span>
<span class="sd">        ...     marker = 1001</span>
<span class="sd">        ...     some_name = ndb.StringProperty()</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; Simple(some_name=&quot;Value set here.&quot;)</span>
<span class="sd">        Simple(some_name=&#39;Value set here.&#39;)</span>
<span class="sd">        &gt;&gt;&gt; Simple(some_name=&quot;Value set here.&quot;, marker=29)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">          ...</span>
<span class="sd">        TypeError: Cannot set non-property marker</span>
<span class="sd">        &gt;&gt;&gt; Simple(some_name=&quot;Value set here.&quot;, missing=29)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">          ...</span>
<span class="sd">        AttributeError: type object &#39;Simple&#39; has no attribute &#39;missing&#39;</span>

<span class="sd">    .. automethod:: _get_kind</span>

<span class="sd">    Args:</span>
<span class="sd">        key (Key): Datastore key for this entity (kind must match this model).</span>
<span class="sd">            If ``key`` is used, ``id`` and ``parent`` must be unset or</span>
<span class="sd">            :data:`None`.</span>
<span class="sd">        id (str): Key ID for this model. If ``id`` is used, ``key`` must be</span>
<span class="sd">            :data:`None`.</span>
<span class="sd">        parent (Key): The parent model or :data:`None` for a top-level model.</span>
<span class="sd">            If ``parent`` is used, ``key`` must be :data:`None`.</span>
<span class="sd">        namespace (str): Namespace for the entity key.</span>
<span class="sd">        app (str): Application ID for the entity key.</span>
<span class="sd">        kwargs (Dict[str, Any]): Additional keyword arguments. These should map</span>
<span class="sd">            to properties of this model.</span>

<span class="sd">    Raises:</span>
<span class="sd">        .BadArgumentError: If the constructor is called with ``key`` and one</span>
<span class="sd">            of ``id``, ``app``, ``namespace`` or ``parent`` specified.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Class variables updated by _fix_up_properties()</span>
    <span class="n">_properties</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_has_repeated</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_kind_map</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dict mapping {kind: Model subclass}</span>

    <span class="c1"># Defaults for instance variables.</span>
    <span class="n">_entity_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_values</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_projection</span> <span class="o">=</span> <span class="p">()</span>  <span class="c1"># Tuple of names of projected properties.</span>

    <span class="c1"># Hardcoded pseudo-property for the key.</span>
    <span class="n">_key</span> <span class="o">=</span> <span class="n">ModelKey</span><span class="p">()</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">_key</span>
    <span class="sd">&quot;&quot;&quot;A special pseudo-property for key queries.</span>

<span class="sd">    For example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        key = ndb.Key(MyModel, 808)</span>
<span class="sd">        query = MyModel.query(MyModel.key &gt; key)</span>

<span class="sd">    will create a query for the reserved ``__key__`` property.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">_self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># NOTE: We use ``_self`` rather than ``self`` so users can define a</span>
        <span class="c1">#       property named &#39;self&#39;.</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">_self</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arg</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="p">)</span>
        <span class="n">id_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arg</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">)</span>
        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arg</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;app&quot;</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arg</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;namespace&quot;</span><span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arg</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;parent&quot;</span><span class="p">)</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arg</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;projection&quot;</span><span class="p">)</span>

        <span class="n">key_parts_unspecified</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">id_</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key_parts_unspecified</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
                    <span class="s2">&quot;Model constructor given ``key`` does not accept &quot;</span>
                    <span class="s2">&quot;``id``, ``app``, ``namespace``, or ``parent``.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">_validate_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">key_parts_unspecified</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">(),</span>
                <span class="n">id_</span><span class="p">,</span>
                <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
                <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span>
                <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Set the projection last, otherwise it will prevent _set_attributes().</span>
        <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_projection</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_arg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse keywords for fields that aren&#39;t user-defined properties.</span>

<span class="sd">        This is used to re-map special keyword arguments in the presence</span>
<span class="sd">        of name collision. For example if ``id`` is a property on the current</span>
<span class="sd">        :class:`Model`, then it may be desirable to pass ``_id`` (instead of</span>
<span class="sd">        ``id``) to the constructor.</span>

<span class="sd">        If the argument is found as ``_{keyword}`` or ``{keyword}``, it will</span>
<span class="sd">        be removed from ``kwargs``.</span>

<span class="sd">        Args:</span>
<span class="sd">            kwargs (Dict[str, Any]): A keyword arguments dictionary.</span>
<span class="sd">            keyword (str): A keyword to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Any]: The ``keyword`` argument, if found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alt_keyword</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">keyword</span>
        <span class="k">if</span> <span class="n">alt_keyword</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">alt_keyword</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Property</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ModelKey</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_set_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set attributes from keyword arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            kwargs (Dict[str, Any]): A keyword arguments dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># NOTE: This raises an ``AttributeError`` for unknown properties</span>
            <span class="c1">#       and that is the intended behavior.</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">Property</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot set non-property </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">prop</span><span class="o">.</span><span class="n">_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Model.__repr__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Model.__repr__">[docs]</a>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an unambiguous string representation of an entity.&quot;&quot;&quot;</span>
        <span class="n">by_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">has_key_property</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span> <span class="o">==</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span>
                <span class="n">has_key_property</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">prop</span><span class="o">.</span><span class="n">_has_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">_retrieve_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">arg_repr</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
            <span class="k">elif</span> <span class="n">prop</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
                <span class="n">arg_reprs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">prop</span><span class="o">.</span><span class="n">_value_to_repr</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span> <span class="k">for</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">value</span>
                <span class="p">]</span>
                <span class="n">arg_repr</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg_reprs</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arg_repr</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">_value_to_repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="n">by_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span><span class="p">,</span> <span class="n">arg_repr</span><span class="p">))</span>

        <span class="n">by_args</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_key_property</span><span class="p">:</span>
                <span class="n">entity_key_name</span> <span class="o">=</span> <span class="s2">&quot;_key&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">entity_key_name</span> <span class="o">=</span> <span class="s2">&quot;key&quot;</span>
            <span class="n">by_args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entity_key_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
            <span class="n">by_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;_projection=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_projection</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">by_args</span><span class="p">))</span></div>

<div class="viewcode-block" id="Model._get_kind"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Model._get_kind">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_kind</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str: Return the kind name for this class.</span>

<span class="sd">        This defaults to ``cls.__name__``; users may override this to give a</span>
<span class="sd">        class a different name when stored in Google Cloud Datastore than the</span>
<span class="sd">        name of the class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_class_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A hook for polymodel to override.</span>

<span class="sd">        For regular models and expandos this is just an alias for</span>
<span class="sd">        _get_kind().  For PolyModel subclasses, it returns the class name</span>
<span class="sd">        (as set in the &#39;class&#39; attribute thereof), whereas _get_kind()</span>
<span class="sd">        returns the kind (the class name of the root class of a specific</span>
<span class="sd">        PolyModel hierarchy).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_default_filters</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an iterable of filters that are always to be applied.</span>

<span class="sd">        This is used by PolyModel to quietly insert a filter for the</span>
<span class="sd">        current class name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">()</span>

<div class="viewcode-block" id="Model.__hash__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Model.__hash__">[docs]</a>    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Not implemented hash function.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: Always, to emphasize that entities are mutable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Model is mutable, so cannot be hashed.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.__eq__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Model.__eq__">[docs]</a>    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare two entities of the same class for equality.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equivalent</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_equivalent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare two entities of the same class, excluding keys.</span>

<span class="sd">        Args:</span>
<span class="sd">            other (Model): An entity of the same class. It is assumed that</span>
<span class="sd">                the type and the key of ``other`` match the current entity&#39;s</span>
<span class="sd">                type and key (and the caller is responsible for checking).</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Indicating if the current entity and ``other`` are</span>
<span class="sd">            equivalent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_projection</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_projection</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">prop_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># Restrict properties to the projection if set.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
            <span class="n">prop_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_projection</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">prop_names</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_properties</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Model.__lt__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Model.__lt__">[docs]</a>    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The ``&lt;`` comparison is not well-defined.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Model instances are not orderable.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.__le__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Model.__le__">[docs]</a>    <span class="k">def</span> <span class="nf">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The ``&lt;=`` comparison is not well-defined.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Model instances are not orderable.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.__gt__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Model.__gt__">[docs]</a>    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The ``&gt;`` comparison is not well-defined.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Model instances are not orderable.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.__ge__"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Model.__ge__">[docs]</a>    <span class="k">def</span> <span class="nf">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The ``&gt;=`` comparison is not well-defined.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Model instances are not orderable.&quot;</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_lookup_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">default_model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the model class for the given kind.</span>

<span class="sd">        Args:</span>
<span class="sd">            kind (str): The name of the kind to look up.</span>
<span class="sd">            default_model (Optional[type]): The model class to return if the</span>
<span class="sd">                kind can&#39;t be found.</span>

<span class="sd">        Returns:</span>
<span class="sd">            type: The model class for the requested kind or the default model.</span>

<span class="sd">        Raises:</span>
<span class="sd">            .KindError: If the kind was not found and no ``default_model`` was</span>
<span class="sd">                provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_class</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_kind_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">default_model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;No model class found for the kind &#39;</span><span class="si">{}</span><span class="s2">&#39;. Did you forget to &quot;</span>
                    <span class="s2">&quot;import it?&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">model_class</span>

    <span class="k">def</span> <span class="nf">_set_projection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the projected properties for this instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            projection (Union[list, tuple]): An iterable of strings</span>
<span class="sd">                representing the projection for the model instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_projection</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_check_properties</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">property_names</span><span class="p">,</span> <span class="n">require_indexed</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal helper to check the given properties exist and meet specified</span>
<span class="sd">        requirements.</span>

<span class="sd">        Called from query.py.</span>

<span class="sd">        Args:</span>
<span class="sd">            property_names (list): List or tuple of property names -- each being</span>
<span class="sd">            a string, possibly containing dots (to address subproperties of</span>
<span class="sd">            structured properties).</span>

<span class="sd">        Raises:</span>
<span class="sd">            InvalidPropertyError: if one of the properties is invalid.</span>
<span class="sd">            AssertionError: if the argument is not a list or tuple of strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">property_names</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">property_names</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">property_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rest</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidPropertyError</span><span class="p">(</span><span class="s2">&quot;Unknown property </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prop</span><span class="o">.</span><span class="n">_check_property</span><span class="p">(</span><span class="n">rest</span><span class="p">,</span> <span class="n">require_indexed</span><span class="o">=</span><span class="n">require_indexed</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_fix_up_properties</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fix up the properties by calling their ``_fix_up()`` method.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This is called by :class:`MetaModel`, but may also be called</span>
<span class="sd">            manually after dynamically updating a model class.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KindError: If the returned kind from ``_get_kind()`` is not a</span>
<span class="sd">                :class:`str`.</span>
<span class="sd">            TypeError: If a property on this model has a name beginning with</span>
<span class="sd">                an underscore.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span>
                <span class="s2">&quot;Class </span><span class="si">{}</span><span class="s2"> defines a ``_get_kind()`` method that returns &quot;</span>
                <span class="s2">&quot;a non-string (</span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">kind</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Skip the classes in ``ndb.model``.</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="vm">__name__</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">ModelAttribute</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">attr</span><span class="p">,</span> <span class="n">ModelKey</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;ModelAttribute </span><span class="si">{}</span><span class="s2"> cannot begin with an underscore &quot;</span>
                        <span class="s2">&quot;character. ``_`` prefixed attributes are reserved &quot;</span>
                        <span class="s2">&quot;for temporary Model instance values.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">attr</span><span class="o">.</span><span class="n">_fix_up</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Property</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">_repeated</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">StructuredProperty</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">_model_class</span><span class="o">.</span><span class="n">_has_repeated</span>
                    <span class="p">):</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">_has_repeated</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">_properties</span><span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_update_kind_map</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_update_kind_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the kind map to include this class.&quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_kind_map</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">cls</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_validate_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validation for ``_key`` attribute (designed to be overridden).</span>

<span class="sd">        Args:</span>
<span class="sd">            key (.Key): Proposed key to use for this entity.</span>

<span class="sd">        Returns:</span>
<span class="sd">            .Key: The validated ``key``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">key</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_gql</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">query_string</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run a GQL query using this model as the FROM entity.</span>

<span class="sd">        Args:</span>
<span class="sd">            query_string (str): The WHERE part of a GQL query (including the</span>
<span class="sd">                WHERE kwyword).</span>
<span class="sd">            args: if present, used to call bind() on the query.</span>
<span class="sd">            kwargs: if present, used to call bind() on the query.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:query.Query: A query instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># import late to avoid circular import problems</span>
        <span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">query</span>

        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">gql</span><span class="p">(</span>
            <span class="s2">&quot;SELECT * FROM </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_class_name</span><span class="p">(),</span> <span class="n">query_string</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">gql</span> <span class="o">=</span> <span class="n">_gql</span>

    <span class="nd">@_options</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">options</span>
    <span class="k">def</span> <span class="nf">_put</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Synchronously write this entity to Cloud Datastore.</span>

<span class="sd">        If the operation creates or completes a key, the entity&#39;s key</span>
<span class="sd">        attribute is set to the new, complete key.</span>

<span class="sd">        Args:</span>
<span class="sd">            retries (int): Number of times to retry this operation in the case</span>
<span class="sd">                of transient server errors. Operation will potentially be tried</span>
<span class="sd">                up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">                once, with no retries.</span>
<span class="sd">            timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            force_writes (bool): Specifies whether a write request should</span>
<span class="sd">                succeed even if the app is read-only. (This only applies to</span>
<span class="sd">                user controlled read-only periods.)</span>
<span class="sd">            use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">                cache; overrides in-process cache policy for this operation.</span>
<span class="sd">            use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">                memcache; overrides memcache policy for this operation.</span>
<span class="sd">            use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">                Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">            memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">                overrides memcache timeout policy for this operation.</span>
<span class="sd">            max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">                feature of the Context memcache methods. For example, with the</span>
<span class="sd">                default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">                set operations will be combined into a single set_multi</span>
<span class="sd">                operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            key.Key: The key for the entity. This is always a complete key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_put_async</span><span class="p">(</span><span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="n">put</span> <span class="o">=</span> <span class="n">_put</span>

    <span class="nd">@_options</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">options</span>
    <span class="k">def</span> <span class="nf">_put_async</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Asynchronously write this entity to Cloud Datastore.</span>

<span class="sd">        If the operation creates or completes a key, the entity&#39;s key</span>
<span class="sd">        attribute is set to the new, complete key.</span>

<span class="sd">        Args:</span>
<span class="sd">            retries (int): Number of times to retry this operation in the case</span>
<span class="sd">                of transient server errors. Operation will potentially be tried</span>
<span class="sd">                up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">                once, with no retries.</span>
<span class="sd">            timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            force_writes (bool): Specifies whether a write request should</span>
<span class="sd">                succeed even if the app is read-only. (This only applies to</span>
<span class="sd">                user controlled read-only periods.)</span>
<span class="sd">            use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">                cache; overrides in-process cache policy for this operation.</span>
<span class="sd">            use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">                memcache; overrides memcache policy for this operation.</span>
<span class="sd">            use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">                Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">            memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">                overrides memcache timeout policy for this operation.</span>
<span class="sd">            max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">                feature of the Context memcache methods. For example, with the</span>
<span class="sd">                default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">                set operations will be combined into a single set_multi</span>
<span class="sd">                operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tasklets.Future: The eventual result will be the key for the</span>
<span class="sd">                entity. This is always a complete key.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pre_put_hook</span><span class="p">()</span>

        <span class="nd">@tasklets</span><span class="o">.</span><span class="n">tasklet</span>
        <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">entity_pb</span> <span class="o">=</span> <span class="n">_entity_to_protobuf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">key_pb</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">_datastore_api</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">entity_pb</span><span class="p">,</span> <span class="n">_options</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key_pb</span><span class="p">:</span>
                <span class="n">ds_key</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">key_from_protobuf</span><span class="p">(</span><span class="n">key_pb</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">key_module</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">_from_ds_key</span><span class="p">(</span><span class="n">ds_key</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">_options</span><span class="o">.</span><span class="n">use_cache</span><span class="p">:</span>
                    <span class="n">context_module</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span>

        <span class="n">future</span> <span class="o">=</span> <span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">future</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_post_put_hook</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">future</span>

    <span class="n">put_async</span> <span class="o">=</span> <span class="n">_put_async</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_query</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="o">*</span><span class="n">filters</span><span class="p">,</span>
        <span class="n">distinct</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ancestor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">orders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">distinct_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">group_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a query for this class.</span>

<span class="sd">        Args:</span>
<span class="sd">            *filters (query.FilterNode): Filters to apply to this query.</span>
<span class="sd">            distinct (Optional[bool]): Setting this to :data:`True` is</span>
<span class="sd">                shorthand for setting `distinct_on` to `projection`.</span>
<span class="sd">            ancestor (key.Key): Entities returned will be descendants of</span>
<span class="sd">                `ancestor`.</span>
<span class="sd">            order_by (list[Union[str, google.cloud.ndb.model.Property]]):</span>
<span class="sd">                The model properties used to order query results.</span>
<span class="sd">            orders (list[Union[str, google.cloud.ndb.model.Property]]):</span>
<span class="sd">                Deprecated. Synonym for `order_by`.</span>
<span class="sd">            project (str): The project to perform the query in. Also known as</span>
<span class="sd">                the app, in Google App Engine. If not passed, uses the</span>
<span class="sd">                client&#39;s value.</span>
<span class="sd">            app (str): Deprecated. Synonym for `project`.</span>
<span class="sd">            namespace (str): The namespace to which to restrict results.</span>
<span class="sd">                If not passed, uses the client&#39;s value.</span>
<span class="sd">            projection (list[str]): The fields to return as part of the</span>
<span class="sd">                query results.</span>
<span class="sd">            distinct_on (list[str]): The field names used to group query</span>
<span class="sd">                results.</span>
<span class="sd">            group_by (list[str]): Deprecated. Synonym for distinct_on.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validating distinct</span>
        <span class="k">if</span> <span class="n">distinct</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">distinct_on</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot use `distinct` and `distinct_on` together.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">group_by</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot use `distinct` and `group_by` together.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">projection</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot use `distinct` without `projection`.&quot;</span><span class="p">)</span>

            <span class="n">distinct_on</span> <span class="o">=</span> <span class="n">projection</span>

        <span class="c1"># Avoid circular import</span>
        <span class="kn">from</span> <span class="nn">google.cloud.ndb</span> <span class="k">import</span> <span class="n">query</span> <span class="k">as</span> <span class="n">query_module</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">query_module</span><span class="o">.</span><span class="n">Query</span><span class="p">(</span>
            <span class="n">kind</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">(),</span>
            <span class="n">ancestor</span><span class="o">=</span><span class="n">ancestor</span><span class="p">,</span>
            <span class="n">order_by</span><span class="o">=</span><span class="n">order_by</span><span class="p">,</span>
            <span class="n">orders</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
            <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span>
            <span class="n">distinct_on</span><span class="o">=</span><span class="n">distinct_on</span><span class="p">,</span>
            <span class="n">group_by</span><span class="o">=</span><span class="n">group_by</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">_default_filters</span><span class="p">())</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="n">query</span> <span class="o">=</span> <span class="n">_query</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@_options</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">options</span>
    <span class="k">def</span> <span class="nf">_allocate_ids</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allocates a range of key IDs for this model class.</span>

<span class="sd">        Args:</span>
<span class="sd">            size (int): Number of IDs to allocate. Must be specified.</span>
<span class="sd">            max (int): Maximum ID to allocated. This feature is no longer</span>
<span class="sd">                supported. You must always specify ``size``.</span>
<span class="sd">            parent (key.Key): Parent key for which the IDs will be allocated.</span>
<span class="sd">            retries (int): Number of times to retry this operation in the case</span>
<span class="sd">                of transient server errors. Operation will potentially be tried</span>
<span class="sd">                up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">                once, with no retries.</span>
<span class="sd">            timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            force_writes (bool): Specifies whether a write request should</span>
<span class="sd">                succeed even if the app is read-only. (This only applies to</span>
<span class="sd">                user controlled read-only periods.)</span>
<span class="sd">            use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">                cache; overrides in-process cache policy for this operation.</span>
<span class="sd">            use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">                memcache; overrides memcache policy for this operation.</span>
<span class="sd">            use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">                Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">            memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">                overrides memcache timeout policy for this operation.</span>
<span class="sd">            max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">                feature of the Context memcache methods. For example, with the</span>
<span class="sd">                default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">                set operations will be combined into a single set_multi</span>
<span class="sd">                operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple(key.Key): Keys for the newly allocated IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_allocate_ids_async</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="n">allocate_ids</span> <span class="o">=</span> <span class="n">_allocate_ids</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@_options</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">options</span>
    <span class="k">def</span> <span class="nf">_allocate_ids_async</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allocates a range of key IDs for this model class.</span>

<span class="sd">        Args:</span>
<span class="sd">            size (int): Number of IDs to allocate. Must be specified.</span>
<span class="sd">            max (int): Maximum ID to allocated. This feature is no longer</span>
<span class="sd">                supported. You must always specify ``size``.</span>
<span class="sd">            parent (key.Key): Parent key for which the IDs will be allocated.</span>
<span class="sd">            retries (int): Number of times to retry this operation in the case</span>
<span class="sd">                of transient server errors. Operation will potentially be tried</span>
<span class="sd">                up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">                once, with no retries.</span>
<span class="sd">            timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            force_writes (bool): Specifies whether a write request should</span>
<span class="sd">                succeed even if the app is read-only. (This only applies to</span>
<span class="sd">                user controlled read-only periods.)</span>
<span class="sd">            use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">                cache; overrides in-process cache policy for this operation.</span>
<span class="sd">            use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">                memcache; overrides memcache policy for this operation.</span>
<span class="sd">            use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">                Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">            memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">                overrides memcache timeout policy for this operation.</span>
<span class="sd">            max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">                feature of the Context memcache methods. For example, with the</span>
<span class="sd">                default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">                set operations will be combined into a single set_multi</span>
<span class="sd">                operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tasklets.Future: Eventural result is ``tuple(key.Key)``: Keys for</span>
<span class="sd">                the newly allocated IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;max&#39; argument to &#39;allocate_ids&#39; is no longer supported. &quot;</span>
                <span class="s2">&quot;There is no support for it in the Google Datastore backend &quot;</span>
                <span class="s2">&quot;service.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Must pass non-zero &#39;size&#39; to &#39;allocate_ids&#39;&quot;</span><span class="p">)</span>

        <span class="nd">@tasklets</span><span class="o">.</span><span class="n">tasklet</span>
        <span class="k">def</span> <span class="nf">allocate_ids</span><span class="p">():</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_pre_allocate_ids_hook</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">()</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">key_module</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">_key</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">key_pbs</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">_datastore_api</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">_options</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">key_module</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">_from_ds_key</span><span class="p">(</span>
                        <span class="n">helpers</span><span class="o">.</span><span class="n">key_from_protobuf</span><span class="p">(</span><span class="n">key_pb</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">key_pb</span> <span class="ow">in</span> <span class="n">key_pbs</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">keys</span>

        <span class="n">future</span> <span class="o">=</span> <span class="n">allocate_ids</span><span class="p">()</span>
        <span class="n">future</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span>
            <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_post_allocate_ids_hook</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">future</span>

    <span class="n">allocate_ids_async</span> <span class="o">=</span> <span class="n">_allocate_ids_async</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@_options</span><span class="o">.</span><span class="n">ReadOptions</span><span class="o">.</span><span class="n">options</span>
    <span class="k">def</span> <span class="nf">_get_by_id</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">read_consistency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">transaction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get an instance of Model class by ID.</span>

<span class="sd">        This really just a shorthand for ``Key(cls, id, ....).get()``.</span>

<span class="sd">        Args:</span>
<span class="sd">            id (Union[int, str]): ID of the entity to load.</span>
<span class="sd">            parent (Optional[key.Key]): Key for the parent of the entity to</span>
<span class="sd">                load.</span>
<span class="sd">            namespace (Optional[str]): Namespace for the entity to load. If not</span>
<span class="sd">                passed, uses the client&#39;s value.</span>
<span class="sd">            project (Optional[str]): Project id for the entity to load. If not</span>
<span class="sd">                passed, uses the client&#39;s value.</span>
<span class="sd">            app (str): DEPRECATED: Synonym for `project`.</span>
<span class="sd">            read_consistency: Set this to ``ndb.EVENTUAL`` if, instead of</span>
<span class="sd">                waiting for the Datastore to finish applying changes to all</span>
<span class="sd">                returned results, you wish to get possibly-not-current results</span>
<span class="sd">                faster. You can&#39;t do this if using a transaction.</span>
<span class="sd">            read_policy: DEPRECATED: Synonym for ``read_consistency``.</span>
<span class="sd">            transaction (bytes): Any results returned will be consistent with</span>
<span class="sd">                the Datastore state represented by this transaction id.</span>
<span class="sd">                Defaults to the currently running transaction. Cannot be used</span>
<span class="sd">                with ``read_consistency=ndb.EVENTUAL``.</span>
<span class="sd">            retries (int): Number of times to retry this operation in the case</span>
<span class="sd">                of transient server errors. Operation will potentially be tried</span>
<span class="sd">                up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">                once, with no retries.</span>
<span class="sd">            timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            force_writes (bool): Specifies whether a write request should</span>
<span class="sd">                succeed even if the app is read-only. (This only applies to</span>
<span class="sd">                user controlled read-only periods.)</span>
<span class="sd">            use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">                cache; overrides in-process cache policy for this operation.</span>
<span class="sd">            use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">                memcache; overrides memcache policy for this operation.</span>
<span class="sd">            use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">                Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">            memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">                overrides memcache timeout policy for this operation.</span>
<span class="sd">            max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">                feature of the Context memcache methods. For example, with the</span>
<span class="sd">                default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">                set operations will be combined into a single set_multi</span>
<span class="sd">                operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Model]: The retrieved entity, if one is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_by_id_async</span><span class="p">(</span>
            <span class="nb">id</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span>
            <span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="n">get_by_id</span> <span class="o">=</span> <span class="n">_get_by_id</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@_options</span><span class="o">.</span><span class="n">ReadOptions</span><span class="o">.</span><span class="n">options</span>
    <span class="k">def</span> <span class="nf">_get_by_id_async</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">read_consistency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">transaction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get an instance of Model class by ID.</span>

<span class="sd">        This is the asynchronous version of :meth:`get_by_id`.</span>

<span class="sd">        Args:</span>
<span class="sd">            id (Union[int, str]): ID of the entity to load.</span>
<span class="sd">            parent (Optional[key.Key]): Key for the parent of the entity to</span>
<span class="sd">                load.</span>
<span class="sd">            namespace (Optional[str]): Namespace for the entity to load. If not</span>
<span class="sd">                passed, uses the client&#39;s value.</span>
<span class="sd">            project (Optional[str]): Project id for the entity to load. If not</span>
<span class="sd">                passed, uses the client&#39;s value.</span>
<span class="sd">            app (str): DEPRECATED: Synonym for `project`.</span>
<span class="sd">            read_consistency: Set this to ``ndb.EVENTUAL`` if, instead of</span>
<span class="sd">                waiting for the Datastore to finish applying changes to all</span>
<span class="sd">                returned results, you wish to get possibly-not-current results</span>
<span class="sd">                faster. You can&#39;t do this if using a transaction.</span>
<span class="sd">            read_policy: DEPRECATED: Synonym for ``read_consistency``.</span>
<span class="sd">            transaction (bytes): Any results returned will be consistent with</span>
<span class="sd">                the Datastore state represented by this transaction id.</span>
<span class="sd">                Defaults to the currently running transaction. Cannot be used</span>
<span class="sd">                with ``read_consistency=ndb.EVENTUAL``.</span>
<span class="sd">            retries (int): Number of times to retry this operation in the case</span>
<span class="sd">                of transient server errors. Operation will potentially be tried</span>
<span class="sd">                up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">                once, with no retries.</span>
<span class="sd">            timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            force_writes (bool): Specifies whether a write request should</span>
<span class="sd">                succeed even if the app is read-only. (This only applies to</span>
<span class="sd">                user controlled read-only periods.)</span>
<span class="sd">            use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">                cache; overrides in-process cache policy for this operation.</span>
<span class="sd">            use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">                memcache; overrides memcache policy for this operation.</span>
<span class="sd">            use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">                Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">            memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">                overrides memcache timeout policy for this operation.</span>
<span class="sd">            max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">                feature of the Context memcache methods. For example, with the</span>
<span class="sd">                default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">                set operations will be combined into a single set_multi</span>
<span class="sd">                operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tasklets.Future: Optional[Model]: The retrieved entity, if one is</span>
<span class="sd">                found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">app</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">project</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;Can&#39;t pass &#39;app&#39; and &#39;project&#39; arguments together.&quot;</span>
                <span class="p">)</span>

            <span class="n">project</span> <span class="o">=</span> <span class="n">app</span>

        <span class="c1"># Key class is weird about keyword args. If you want it to use defaults</span>
        <span class="c1"># you have to not pass them at all.</span>
        <span class="n">key_args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">project</span><span class="p">:</span>
            <span class="n">key_args</span><span class="p">[</span><span class="s2">&quot;app&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project</span>

        <span class="k">if</span> <span class="n">namespace</span><span class="p">:</span>
            <span class="n">key_args</span><span class="p">[</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namespace</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">key_module</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">(),</span> <span class="nb">id</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">key_args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">get_async</span><span class="p">(</span><span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">)</span>

    <span class="n">get_by_id_async</span> <span class="o">=</span> <span class="n">_get_by_id_async</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@_options</span><span class="o">.</span><span class="n">ReadOptions</span><span class="o">.</span><span class="n">options</span>
    <span class="k">def</span> <span class="nf">_get_or_insert</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">read_consistency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">transaction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kw_model_args</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transactionally retrieves an existing entity or creates a new one.</span>

<span class="sd">        Will attempt to look up an entity with the given ``name`` and</span>
<span class="sd">        ``parent``. If none is found a new entity will be created using the</span>
<span class="sd">        given ``name`` and ``parent``, and passing any ``kw_model_args`` to the</span>
<span class="sd">        constructor the ``Model`` class.</span>

<span class="sd">        If not already in a transaction, a new transaction will be created and</span>
<span class="sd">        this operation will be run in that transaction.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Name of the entity to load or create.</span>
<span class="sd">            parent (Optional[key.Key]): Key for the parent of the entity to</span>
<span class="sd">                load.</span>
<span class="sd">            namespace (Optional[str]): Namespace for the entity to load. If not</span>
<span class="sd">                passed, uses the client&#39;s value.</span>
<span class="sd">            project (Optional[str]): Project id for the entity to load. If not</span>
<span class="sd">                passed, uses the client&#39;s value.</span>
<span class="sd">            app (str): DEPRECATED: Synonym for `project`.</span>
<span class="sd">            **kw_model_args: Keyword arguments to pass to the constructor of</span>
<span class="sd">                the model class if an instance for the specified key name does</span>
<span class="sd">                not already exist. If an instance with the supplied ``name``</span>
<span class="sd">                and ``parent`` already exists, these arguments will be</span>
<span class="sd">                discarded.</span>
<span class="sd">            read_consistency: Set this to ``ndb.EVENTUAL`` if, instead of</span>
<span class="sd">                waiting for the Datastore to finish applying changes to all</span>
<span class="sd">                returned results, you wish to get possibly-not-current results</span>
<span class="sd">                faster. You can&#39;t do this if using a transaction.</span>
<span class="sd">            read_policy: DEPRECATED: Synonym for ``read_consistency``.</span>
<span class="sd">            transaction (bytes): Any results returned will be consistent with</span>
<span class="sd">                the Datastore state represented by this transaction id.</span>
<span class="sd">                Defaults to the currently running transaction. Cannot be used</span>
<span class="sd">                with ``read_consistency=ndb.EVENTUAL``.</span>
<span class="sd">            retries (int): Number of times to retry this operation in the case</span>
<span class="sd">                of transient server errors. Operation will potentially be tried</span>
<span class="sd">                up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">                once, with no retries.</span>
<span class="sd">            timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            force_writes (bool): Specifies whether a write request should</span>
<span class="sd">                succeed even if the app is read-only. (This only applies to</span>
<span class="sd">                user controlled read-only periods.)</span>
<span class="sd">            use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">                cache; overrides in-process cache policy for this operation.</span>
<span class="sd">            use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">                memcache; overrides memcache policy for this operation.</span>
<span class="sd">            use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">                Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">            memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">                overrides memcache timeout policy for this operation.</span>
<span class="sd">            max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">                feature of the Context memcache methods. For example, with the</span>
<span class="sd">                default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">                set operations will be combined into a single set_multi</span>
<span class="sd">                operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Model: The entity that was either just retrieved or created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_or_insert_async</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span>
            <span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kw_model_args</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="n">get_or_insert</span> <span class="o">=</span> <span class="n">_get_or_insert</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@_options</span><span class="o">.</span><span class="n">ReadOptions</span><span class="o">.</span><span class="n">options</span>
    <span class="k">def</span> <span class="nf">_get_or_insert_async</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">read_consistency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">transaction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kw_model_args</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transactionally retrieves an existing entity or creates a new one.</span>

<span class="sd">        This is the asynchronous version of :meth:``_get_or_insert``.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Name of the entity to load or create.</span>
<span class="sd">            parent (Optional[key.Key]): Key for the parent of the entity to</span>
<span class="sd">                load.</span>
<span class="sd">            namespace (Optional[str]): Namespace for the entity to load. If not</span>
<span class="sd">                passed, uses the client&#39;s value.</span>
<span class="sd">            project (Optional[str]): Project id for the entity to load. If not</span>
<span class="sd">                passed, uses the client&#39;s value.</span>
<span class="sd">            app (str): DEPRECATED: Synonym for `project`.</span>
<span class="sd">            **kw_model_args: Keyword arguments to pass to the constructor of</span>
<span class="sd">                the model class if an instance for the specified key name does</span>
<span class="sd">                not already exist. If an instance with the supplied ``name``</span>
<span class="sd">                and ``parent`` already exists, these arguments will be</span>
<span class="sd">                discarded.</span>
<span class="sd">            read_consistency: Set this to ``ndb.EVENTUAL`` if, instead of</span>
<span class="sd">                waiting for the Datastore to finish applying changes to all</span>
<span class="sd">                returned results, you wish to get possibly-not-current results</span>
<span class="sd">                faster. You can&#39;t do this if using a transaction.</span>
<span class="sd">            read_policy: DEPRECATED: Synonym for ``read_consistency``.</span>
<span class="sd">            transaction (bytes): Any results returned will be consistent with</span>
<span class="sd">                the Datastore state represented by this transaction id.</span>
<span class="sd">                Defaults to the currently running transaction. Cannot be used</span>
<span class="sd">                with ``read_consistency=ndb.EVENTUAL``.</span>
<span class="sd">            retries (int): Number of times to retry this operation in the case</span>
<span class="sd">                of transient server errors. Operation will potentially be tried</span>
<span class="sd">                up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">                once, with no retries.</span>
<span class="sd">            timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">            deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">            force_writes (bool): Specifies whether a write request should</span>
<span class="sd">                succeed even if the app is read-only. (This only applies to</span>
<span class="sd">                user controlled read-only periods.)</span>
<span class="sd">            use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">                cache; overrides in-process cache policy for this operation.</span>
<span class="sd">            use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">                memcache; overrides memcache policy for this operation.</span>
<span class="sd">            use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">                Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">            memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">                overrides memcache timeout policy for this operation.</span>
<span class="sd">            max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">                feature of the Context memcache methods. For example, with the</span>
<span class="sd">                default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">                set operations will be combined into a single set_multi</span>
<span class="sd">                operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tasklets.Future: Model: The entity that was either just retrieved</span>
<span class="sd">                or created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;name&#39; must be a string; received </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;name&#39; must not be an empty string.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">app</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">project</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;Can&#39;t pass &#39;app&#39; and &#39;project&#39; arguments together.&quot;</span>
                <span class="p">)</span>

            <span class="n">project</span> <span class="o">=</span> <span class="n">app</span>

        <span class="c1"># Key class is weird about keyword args. If you want it to use defaults</span>
        <span class="c1"># you have to not pass them at all.</span>
        <span class="n">key_args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">project</span><span class="p">:</span>
            <span class="n">key_args</span><span class="p">[</span><span class="s2">&quot;app&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project</span>

        <span class="k">if</span> <span class="n">namespace</span><span class="p">:</span>
            <span class="n">key_args</span><span class="p">[</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namespace</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">key_module</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">(),</span> <span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">key_args</span><span class="p">)</span>

        <span class="nd">@tasklets</span><span class="o">.</span><span class="n">tasklet</span>
        <span class="k">def</span> <span class="nf">get_or_insert</span><span class="p">():</span>
            <span class="nd">@tasklets</span><span class="o">.</span><span class="n">tasklet</span>
            <span class="k">def</span> <span class="nf">insert</span><span class="p">():</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kw_model_args</span><span class="p">)</span>
                <span class="n">entity</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">key</span>
                <span class="k">yield</span> <span class="n">entity</span><span class="o">.</span><span class="n">put_async</span><span class="p">(</span><span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">entity</span>

            <span class="c1"># We don&#39;t need to start a transaction just to check if the entity</span>
            <span class="c1"># exists already</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">key</span><span class="o">.</span><span class="n">get_async</span><span class="p">(</span><span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">entity</span>

            <span class="k">if</span> <span class="n">_transaction</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">():</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">insert</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">_transaction</span><span class="o">.</span><span class="n">transaction_async</span><span class="p">(</span><span class="n">insert</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">entity</span>

        <span class="k">return</span> <span class="n">get_or_insert</span><span class="p">()</span>

    <span class="n">get_or_insert_async</span> <span class="o">=</span> <span class="n">_get_or_insert_async</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate an instance from keyword arguments.</span>

<span class="sd">        Each keyword argument will be used to set a corresponding property.</span>
<span class="sd">        Each keyword must refer to a valid property name. This is similar to</span>
<span class="sd">        passing keyword arguments to the ``Model`` constructor, except that no</span>
<span class="sd">        provision for key, id, or parent are made.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            **kwargs: Keyword arguments corresponding to poperties of this</span>
<span class="sd">                model class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">populate</span> <span class="o">=</span> <span class="n">_populate</span>

    <span class="k">def</span> <span class="nf">_has_complete_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return whether this entity has a complete key.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: :data:``True`` if and only if entity has a key and that key</span>
<span class="sd">                has a name or an id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="n">has_complete_key</span> <span class="o">=</span> <span class="n">_has_complete_key</span>

    <span class="k">def</span> <span class="nf">_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a ``dict`` containing the entity&#39;s property values.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            include (Optional[Union[list, tuple, set]]): Set of property names</span>
<span class="sd">                to include. Default is to include all names.</span>
<span class="sd">            exclude (Optional[Union[list, tuple, set]]): Set of property names</span>
<span class="sd">                to exclude. Default is to not exclude any names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span>
            <span class="k">if</span> <span class="n">include</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">_get_for_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">UnprojectedPropertyError</span><span class="p">:</span>
                <span class="c1"># Ignore unprojected property errors, rather than failing</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">values</span>

    <span class="n">to_dict</span> <span class="o">=</span> <span class="n">_to_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_pre_allocate_ids_hook</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_post_allocate_ids_hook</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_pre_delete_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_post_delete_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_pre_get_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_post_get_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_pre_put_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_post_put_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Expando"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.Expando">[docs]</a><span class="k">class</span> <span class="nc">Expando</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Model subclass to support dynamic Property names and types.</span>

<span class="sd">    Sometimes the set of properties is not known ahead of time.  In such</span>
<span class="sd">    cases you can use the Expando class.  This is a Model subclass that</span>
<span class="sd">    creates properties on the fly, both upon assignment and when loading</span>
<span class="sd">    an entity from Cloud Datastore.  For example::</span>

<span class="sd">        &gt;&gt;&gt; class SuperPerson(Expando):</span>
<span class="sd">                name = StringProperty()</span>
<span class="sd">                superpower = StringProperty()</span>

<span class="sd">        &gt;&gt;&gt; razorgirl = SuperPerson(name=&#39;Molly Millions&#39;,</span>
<span class="sd">                                    superpower=&#39;bionic eyes, razorblade hands&#39;,</span>
<span class="sd">                                    rasta_name=&#39;Steppin\&#39; Razor&#39;,</span>
<span class="sd">                                    alt_name=&#39;Sally Shears&#39;)</span>
<span class="sd">        &gt;&gt;&gt; elastigirl = SuperPerson(name=&#39;Helen Parr&#39;,</span>
<span class="sd">                                     superpower=&#39;stretchable body&#39;)</span>
<span class="sd">        &gt;&gt;&gt; elastigirl.max_stretch = 30  # Meters</span>

<span class="sd">        &gt;&gt;&gt; print(razorgirl._properties.keys())</span>
<span class="sd">            [&#39;rasta_name&#39;, &#39;name&#39;, &#39;superpower&#39;, &#39;alt_name&#39;]</span>
<span class="sd">        &gt;&gt;&gt; print(elastigirl._properties)</span>
<span class="sd">            {&#39;max_stretch&#39;: GenericProperty(&#39;max_stretch&#39;),</span>
<span class="sd">             &#39;name&#39;: StringProperty(&#39;name&#39;),</span>
<span class="sd">             &#39;superpower&#39;: StringProperty(&#39;superpower&#39;)}</span>

<span class="sd">    Note: You can inspect the properties of an expando instance using the</span>
<span class="sd">    _properties attribute, as shown above. This property exists for plain Model instances</span>
<span class="sd">    too; it is just not as interesting for those.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Set this to False (in an Expando subclass or entity) to make</span>
    <span class="c1"># properties default to unindexed.</span>
    <span class="n">_default_indexed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Set this to True to write [] to Cloud Datastore instead of no property</span>
    <span class="n">_write_empty_list_for_dynamic_properties</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_set_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwds</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prop</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="n">Property</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">StructuredProperty</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">StructuredProperty</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">GenericProperty</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">repeated</span><span class="o">=</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)),</span>
                <span class="n">indexed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_indexed</span><span class="p">,</span>
                <span class="n">write_empty_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_empty_list_for_dynamic_properties</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>
        <span class="n">prop</span><span class="o">.</span><span class="n">_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="n">Property</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">Property</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Model properties must be Property instances; not </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">prop</span>
            <span class="p">)</span>
        <span class="n">prop</span><span class="o">.</span><span class="n">_delete_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_properties</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Property </span><span class="si">%s</span><span class="s2"> still in the list of properties for the &quot;</span>
                <span class="s2">&quot;base class.&quot;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_multi_async"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.get_multi_async">[docs]</a><span class="nd">@_options</span><span class="o">.</span><span class="n">ReadOptions</span><span class="o">.</span><span class="n">options</span>
<span class="k">def</span> <span class="nf">get_multi_async</span><span class="p">(</span>
    <span class="n">keys</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">read_consistency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">transaction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetches a sequence of keys.</span>

<span class="sd">    Args:</span>
<span class="sd">        keys (Sequence[:class:`~google.cloud.ndb.key.Key`]): A sequence of</span>
<span class="sd">            keys.</span>
<span class="sd">        read_consistency: Set this to ``ndb.EVENTUAL`` if, instead of</span>
<span class="sd">            waiting for the Datastore to finish applying changes to all</span>
<span class="sd">            returned results, you wish to get possibly-not-current results</span>
<span class="sd">            faster. You can&#39;t do this if using a transaction.</span>
<span class="sd">        transaction (bytes): Any results returned will be consistent with</span>
<span class="sd">            the Datastore state represented by this transaction id.</span>
<span class="sd">            Defaults to the currently running transaction. Cannot be used</span>
<span class="sd">            with ``read_consistency=ndb.EVENTUAL``.</span>
<span class="sd">        retries (int): Number of times to retry this operation in the case</span>
<span class="sd">            of transient server errors. Operation will potentially be tried</span>
<span class="sd">            up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">            once, with no retries.</span>
<span class="sd">        timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">        deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">        force_writes (bool): Specifies whether a write request should</span>
<span class="sd">            succeed even if the app is read-only. (This only applies to</span>
<span class="sd">            user controlled read-only periods.)</span>
<span class="sd">        use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">            cache; overrides in-process cache policy for this operation.</span>
<span class="sd">        use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">            memcache; overrides memcache policy for this operation.</span>
<span class="sd">        use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">            Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">        memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">            overrides memcache timeout policy for this operation.</span>
<span class="sd">        max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">            feature of the Context memcache methods. For example, with the</span>
<span class="sd">            default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">            set operations will be combined into a single set_multi</span>
<span class="sd">            operation.</span>
<span class="sd">        read_policy: DEPRECATED: Synonym for ``read_consistency``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[:class:`~google.cloud.ndb.tasklets.Future`]: List of futures.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">get_async</span><span class="p">(</span><span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_multi"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.get_multi">[docs]</a><span class="nd">@_options</span><span class="o">.</span><span class="n">ReadOptions</span><span class="o">.</span><span class="n">options</span>
<span class="k">def</span> <span class="nf">get_multi</span><span class="p">(</span>
    <span class="n">keys</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">read_consistency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">read_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">transaction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetches a sequence of keys.</span>

<span class="sd">    Args:</span>
<span class="sd">        keys (Sequence[:class:`~google.cloud.ndb.key.Key`]): A sequence of</span>
<span class="sd">            keys.</span>
<span class="sd">        read_consistency: Set this to ``ndb.EVENTUAL`` if, instead of</span>
<span class="sd">            waiting for the Datastore to finish applying changes to all</span>
<span class="sd">            returned results, you wish to get possibly-not-current results</span>
<span class="sd">            faster. You can&#39;t do this if using a transaction.</span>
<span class="sd">        transaction (bytes): Any results returned will be consistent with</span>
<span class="sd">            the Datastore state represented by this transaction id.</span>
<span class="sd">            Defaults to the currently running transaction. Cannot be used</span>
<span class="sd">            with ``read_consistency=ndb.EVENTUAL``.</span>
<span class="sd">        retries (int): Number of times to retry this operation in the case</span>
<span class="sd">            of transient server errors. Operation will potentially be tried</span>
<span class="sd">            up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">            once, with no retries.</span>
<span class="sd">        timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">        deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">        force_writes (bool): Specifies whether a write request should</span>
<span class="sd">            succeed even if the app is read-only. (This only applies to</span>
<span class="sd">            user controlled read-only periods.)</span>
<span class="sd">        use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">            cache; overrides in-process cache policy for this operation.</span>
<span class="sd">        use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">            memcache; overrides memcache policy for this operation.</span>
<span class="sd">        use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">            Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">        memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">            overrides memcache timeout policy for this operation.</span>
<span class="sd">        max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">            feature of the Context memcache methods. For example, with the</span>
<span class="sd">            default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">            set operations will be combined into a single set_multi</span>
<span class="sd">            operation.</span>
<span class="sd">        read_policy: DEPRECATED: Synonym for ``read_consistency``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[Union[:class:`~google.cloud.ndb.model.Model`, :data:`None`]]: List</span>
<span class="sd">            containing the retrieved models or None where a key was not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">get_async</span><span class="p">(</span><span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span></div>


<div class="viewcode-block" id="put_multi_async"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.put_multi_async">[docs]</a><span class="nd">@_options</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">options</span>
<span class="k">def</span> <span class="nf">put_multi_async</span><span class="p">(</span>
    <span class="n">entities</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stores a sequence of Model instances.</span>

<span class="sd">    Args:</span>
<span class="sd">        retries (int): Number of times to retry this operation in the case</span>
<span class="sd">            of transient server errors. Operation will potentially be tried</span>
<span class="sd">            up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">            once, with no retries.</span>
<span class="sd">        entities (List[:class:`~google.cloud.ndb.model.Model`]): A sequence</span>
<span class="sd">            of models to store.</span>
<span class="sd">        timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">        deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">        force_writes (bool): Specifies whether a write request should</span>
<span class="sd">            succeed even if the app is read-only. (This only applies to</span>
<span class="sd">            user controlled read-only periods.)</span>
<span class="sd">        use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">            cache; overrides in-process cache policy for this operation.</span>
<span class="sd">        use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">            memcache; overrides memcache policy for this operation.</span>
<span class="sd">        use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">            Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">        memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">            overrides memcache timeout policy for this operation.</span>
<span class="sd">        max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">            feature of the Context memcache methods. For example, with the</span>
<span class="sd">            default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">            set operations will be combined into a single set_multi</span>
<span class="sd">            operation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[:class:`~google.cloud.ndb.tasklets.Future`]: List of futures.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">put_async</span><span class="p">(</span><span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">)</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">]</span></div>


<div class="viewcode-block" id="put_multi"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.put_multi">[docs]</a><span class="nd">@_options</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">options</span>
<span class="k">def</span> <span class="nf">put_multi</span><span class="p">(</span>
    <span class="n">entities</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stores a sequence of Model instances.</span>

<span class="sd">    Args:</span>
<span class="sd">        entities (List[:class:`~google.cloud.ndb.model.Model`]): A sequence</span>
<span class="sd">            of models to store.</span>
<span class="sd">        retries (int): Number of times to retry this operation in the case</span>
<span class="sd">            of transient server errors. Operation will potentially be tried</span>
<span class="sd">            up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">            once, with no retries.</span>
<span class="sd">        timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">        deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">        force_writes (bool): Specifies whether a write request should</span>
<span class="sd">            succeed even if the app is read-only. (This only applies to</span>
<span class="sd">            user controlled read-only periods.)</span>
<span class="sd">        use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">            cache; overrides in-process cache policy for this operation.</span>
<span class="sd">        use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">            memcache; overrides memcache policy for this operation.</span>
<span class="sd">        use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">            Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">        memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">            overrides memcache timeout policy for this operation.</span>
<span class="sd">        max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">            feature of the Context memcache methods. For example, with the</span>
<span class="sd">            default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">            set operations will be combined into a single set_multi</span>
<span class="sd">            operation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[:class:`~google.cloud.ndb.key.Key`]: A list with the stored keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">put_async</span><span class="p">(</span><span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">)</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span></div>


<div class="viewcode-block" id="delete_multi_async"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.delete_multi_async">[docs]</a><span class="nd">@_options</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">options</span>
<span class="k">def</span> <span class="nf">delete_multi_async</span><span class="p">(</span>
    <span class="n">keys</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deletes a sequence of keys.</span>

<span class="sd">    Args:</span>
<span class="sd">        retries (int): Number of times to retry this operation in the case</span>
<span class="sd">            of transient server errors. Operation will potentially be tried</span>
<span class="sd">            up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">            once, with no retries.</span>
<span class="sd">        keys (Sequence[:class:`~google.cloud.ndb.key.Key`]): A sequence of</span>
<span class="sd">            keys.</span>
<span class="sd">        timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">        deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">        force_writes (bool): Specifies whether a write request should</span>
<span class="sd">            succeed even if the app is read-only. (This only applies to</span>
<span class="sd">            user controlled read-only periods.)</span>
<span class="sd">        use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">            cache; overrides in-process cache policy for this operation.</span>
<span class="sd">        use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">            memcache; overrides memcache policy for this operation.</span>
<span class="sd">        use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">            Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">        memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">            overrides memcache timeout policy for this operation.</span>
<span class="sd">        max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">            feature of the Context memcache methods. For example, with the</span>
<span class="sd">            default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">            set operations will be combined into a single set_multi</span>
<span class="sd">            operation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[:class:`~google.cloud.ndb.tasklets.Future`]: List of futures.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">delete_async</span><span class="p">(</span><span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span></div>


<div class="viewcode-block" id="delete_multi"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.delete_multi">[docs]</a><span class="nd">@_options</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">options</span>
<span class="k">def</span> <span class="nf">delete_multi</span><span class="p">(</span>
    <span class="n">keys</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">force_writes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_memcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_datastore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">memcache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">max_memcache_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deletes a sequence of keys.</span>

<span class="sd">    Args:</span>
<span class="sd">        keys (Sequence[:class:`~google.cloud.ndb.key.Key`]): A sequence of</span>
<span class="sd">            keys.</span>
<span class="sd">        retries (int): Number of times to retry this operation in the case</span>
<span class="sd">            of transient server errors. Operation will potentially be tried</span>
<span class="sd">            up to ``retries`` + 1 times. Set to ``0`` to try operation only</span>
<span class="sd">            once, with no retries.</span>
<span class="sd">        timeout (float): Override the gRPC timeout, in seconds.</span>
<span class="sd">        deadline (float): DEPRECATED: Synonym for ``timeout``.</span>
<span class="sd">        force_writes (bool): Specifies whether a write request should</span>
<span class="sd">            succeed even if the app is read-only. (This only applies to</span>
<span class="sd">            user controlled read-only periods.)</span>
<span class="sd">        use_cache (bool): Specifies whether to store entities in in-process</span>
<span class="sd">            cache; overrides in-process cache policy for this operation.</span>
<span class="sd">        use_memcache (bool): Specifies whether to store entities in</span>
<span class="sd">            memcache; overrides memcache policy for this operation.</span>
<span class="sd">        use_datastore (bool): Specifies whether to store entities in</span>
<span class="sd">            Datastore; overrides Datastore policy for this operation.</span>
<span class="sd">        memcache_timeout (int): Maximum lifetime for entities in memcache;</span>
<span class="sd">            overrides memcache timeout policy for this operation.</span>
<span class="sd">        max_memcache_items (int): Maximum batch size for the auto-batching</span>
<span class="sd">            feature of the Context memcache methods. For example, with the</span>
<span class="sd">            default size of max_memcache_items (100), up to 100 memcache</span>
<span class="sd">            set operations will be combined into a single set_multi</span>
<span class="sd">            operation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[:data:`None`]: A list whose items are all None, one per deleted</span>
<span class="sd">            key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">delete_async</span><span class="p">(</span><span class="n">_options</span><span class="o">=</span><span class="n">_options</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_indexes_async"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.get_indexes_async">[docs]</a><span class="k">def</span> <span class="nf">get_indexes_async</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a data structure representing the configured indexes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="get_indexes"><a class="viewcode-back" href="../../../../model.html#google.cloud.ndb.blobstore.get_indexes">[docs]</a><span class="k">def</span> <span class="nf">get_indexes</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a data structure representing the configured indexes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">ndb</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../key.html">Key</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../model.html">Model and Property</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../query.html">Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tasklets.html">Tasklets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../exceptions.html">Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../polymodel.html">Polymorphic Models and Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../django-middleware.html">Django Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../msgprop.html">ProtoRPC Message Properties</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../blobstore.html">Blobstore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../metadata.html">Datastore Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../stats.html">Datastore Statistics</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Google.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>